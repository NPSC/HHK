!function(t){function e(t){t.incidentdialog.find("input").val("").removeAttr("readonly"),t.incidentdialog.find("input").removeClass("ui-state-error"),t.incidentdialog.find("textarea").empty(),t.incidentdialog.find("textarea").val("").removeAttr("readonly"),t.incidentdialog.find("option").removeAttr("selected"),t.incidentdialog.find(".incidentStatus").val("a"),t.incidentdialog.find(".jsignature").empty(),t.incidentdialog.find(".jsignature").jSignature({width:"563px",height:"141px"}),t.incidentdialog.find(".hhk-clear-signature-btn").button(),t.incidentdialog.find(".hhk-finish-signature-btn").button(),t.incidentdialog.on("click",".hhk-clear-signature-btn",function(){t.incidentdialog.find(".jsignature").jSignature("clear"),t.incidentdialog.find(".sigDate").datepicker("setDate","")}),t.incidentdialog.find(".incdate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"}).datepicker("setDate","today"),t.incidentdialog.find(".resdate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"}),t.incidentdialog.find(".sigDate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"})}function i(i,n,d,a){var r=!1;if(null==a&&(a=!1),""==i.incidentdialog.find("input[name=incidentTitle]").val()?(r=!0,i.incidentdialog.find("input[name=incidentTitle]").addClass("ui-state-error")):i.incidentdialog.find("input[name=incidentTitle]").removeClass("ui-state-error"),""==i.incidentdialog.find("input[name=incidentDate]").val()?(r=!0,i.incidentdialog.find("input[name=incidentDate]").addClass("ui-state-error")):i.incidentdialog.find("input[name=incidentDate]").removeClass("ui-state-error"),!0==r)n.alertMessage("Incident not saved. Check fields in red.","error");else{var s=i.incidentdialog.find("input[name=reportId]").val(),l=i.incidentdialog.find("form").serialize();l+="&signature="+encodeURIComponent(i.incidentdialog.find(".jsignature").jSignature("getData")),s>0?l+="&cmd=editIncident&repId="+s:l+="&cmd=saveIncident&guestId="+n.guestId+"&psgId="+n.psgId,t.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:l,success:function(r){var s,l,o;r.idReport>0?(a?(s=i,l=n,o=r.idReport,null==o&&(o=0),t.ajax({url:l.serviceURL,dataType:"JSON",type:"post",data:{cmd:"getincidentreport",print:!0,repid:o},success:function(t){if(t.title){var e="";"a"==t.status?e="Active":"h"==t.status?e="On Hold":"r"==t.status&&(e="Resolved");var i='<div id="incidentPrint">';t.guest&&(i+="<h3>"+l.visitorLabel+'</h3><table cellpadding="10" style="margin-bottom: 2em;"><thead><tr><th>Name</th><th>Phone</th><th>Address</th></tr></thead><tbody><tr><td> '+t.guest.First+" "+t.guest.Last+"</td><td>"+t.guest.Phone+"</td>",t.guest.Address?i+="<td>"+t.guest.Address+"<br>"+t.guest.City+", "+t.guest.State+" "+t.guest.Zip+"</td>":i+="<td></td>",i+="</tr></tbody></table>"),i+='<h3>Incident</h3><table cellpadding="10"><tr><td class="tdlabel">Title</td><td>'+t.title+'</td></tr><tr><td class="tdlabel">Date</td><td>'+t.reportDate+'</td></tr><tr><td class="tdlabel">Description</td><td>'+t.description+'</td></tr><tr><td class="tdlabel">Status</td><td>'+e+'</td></tr><tr><td class="tdlabel">Resolution</td><td>'+t.resolution+'</td></tr><tr><td class="tdlabel" style="width: 25%;">Resolution Date</td><td>'+t.resolutionDate+'</td></tr><tr><td class="tdlabel" style="width: 25%; height: 100px;">Signature</td>',t.signature?i+='<td><img src="'+t.signature+'"></td>':i+="<td></td>",i+='</tr><tr><td class="tdlabel">Signature Date</td><td>'+t.signatureDate+"</td></tr>",t.updatedBy&&(i+='<tr><td class="tdlabel">Updated</td><td>'+t.updatedAt+"</td></tr>"),i+="</table></div>";var n=window.open("","PRINT","height=600,width=800");n.document.write("<html><head><title>"+document.title+"</title>"),n.document.write('<link href="css/house.css" rel="stylesheet" type="text/css">'),n.document.write('<link href="css/incidentReports.css" rel="stylesheet" type="text/css">'),n.document.write('</head><body id="incidentReport" class="PrintArea hhk-visitdialog hhk-tdbox">'),n.document.write("<h2>"+document.title+" - Incident Report</h2>"),n.document.write(i),n.document.write("</body></html>"),n.document.close(),n.focus(),n.addEventListener("load",function(){n.print()},!0),n.addEventListener("afterprint",function(){n.close(),s.incidentdialog.dialog("close")},!0)}}})):("success"==r.status&&n.alertMessage("Incident Saved successfully.","success"),i.incidentdialog.dialog("close"),e(i)),d.ajax.reload()):(r.gotopage&&(window.location=r.gotopage),r.error?n.alertMessage(r.error,"error"):n.alertMessage("An unknown error occurred.","alert"))}})}}t.fn.incidentViewer=function(n){var d=t('<div id="incidentDialog" class="hhk-tdbox hhk-visitdialog" title="Incident"><form><input type="hidden" name="reportId"><table><tr><td class="tdlabel">Incident Title</td><td><input type="text" name="incidentTitle"></td></tr><tr><td class="tdlabel">Incident Date</td><td><input type="text" name="incidentDate" class="incdate" readonly="readonly"></td></tr><tr><td class="tdlabel">Incident Description</td><td><textarea name="incidentDescription" rows="5"></textarea></td></tr><tr><td class="tdlabel">Incident Status</td><td><select name="incidentStatus" class="incidentStatus"><option value="a">Active</option><option value="r">Resolved</option><option value="h">On Hold</option><option value="d">Delete</option></select></td></tr><tr><td class="tdlabel">Incident Resolution</td><td><textarea name="incidentResolution" rows="5"></textarea></td></tr><tr><td class="tdlabel" style="width: 25%">Resolution Date</td><td><input type="text" name="resolutionDate" class="resdate" readonly="readonly"></td></tr><tr><td class="tdlabel" style="width: 25%">Signature<br><div style="color: #959595; display: block;">Use your mouse, finger or touch pen to sign</div><span></td><td><div class="signature-actions" style="text-align: right;"><div style="display: inline-block" class="hhk-clear-signature-btn hhk-report-button incident-edit ui-corner-all ui-state-default">Clear Signature</span></div><div style="display: inline-block" class="hhk-finish-signature-btn hhk-report-button incident-edit ui-corner-all ui-state-default">Finish Signature</span></div></div><div style="height: 141px;" class="jsignature"></div></td></tr><td class="tdlabel">Signature Date</td><td><input type="text" name="signatureDate" class="sigDate" readonly="readonly"></td></table></form></div>'),a=t.extend(!0,{},{guestId:0,psgId:0,rid:0,serviceURL:"ws_resv.php",newLabel:"New Incident",guestLabel:"Guest",visitorLabel:"Guest",tableAttrs:{class:"display compact",width:"100%"},newIncidentAttrs:{id:"incidentTitle",style:"width: 80%;",rows:2},alertMessage:function(t,e){}},n);a.dtCols=[{targets:[0],title:"Actions",data:"Action",sortable:!1,searchable:!1,render:function(e,i,n){var d,a,r,s;return d=e,a=n,r=t("<ul />").addClass("ui-widget ui-helper-clearfix hhk-ui-icons hhk-flex"),(s=t('<li title="Edit Incident" data-incidentid="'+d+'" />').addClass("hhk-report-button incident-edit ui-corner-all ui-state-default")).append(t('<span class="ui-icon ui-icon-pencil" />')),r.append(s),a.canDelete&&(s=t('<li title="Delete report" data-reportid="'+d+'" />').addClass("hhk-report-button incident-delete ui-corner-all ui-state-default")).append(t('<span class="ui-icon ui-icon-trash" />')),r.append(s),(s=t('<li title="Undo Delete" data-reportid="'+d+'" />').addClass("hhk-report-button incident-undodelete ui-corner-all ui-state-default").hide()).append(t('<span class="ui-icon ui-icon-arrowreturnthick-1-w" />')),r.append(s),t("<div />").append(r).html()}},{targets:[1],title:"Date",data:"Date",render:function(t,e){return dateRender(t,e,dateFormat)}},{targets:[2],title:a.visitorLabel,searchable:!0,sortable:!0,data:"Guest"},{targets:[3],title:"Title",searchable:!0,sortable:!1,width:"70%",className:"incidentTitle",data:"Title"},{targets:[4],title:"User",sortable:!1,searchable:!1,visible:!0,data:"User"},{targets:[5],title:"Status",sortable:!0,searchable:!0,visible:!0,data:"Status"}];var r=t(this);return r.incidentdialog=d,function n(d,a){if(a.guestId>0||a.psgId>0||a.rid>0){t('<div class="ui-button ui-corner-all ui-state-default" id="incident-create"><span class="ui-icon ui-icon-plus"></span>New Incident</div>').appendTo(d);var r,s,l,o=t("<table />").attr(a.tableAttrs).appendTo(d).on("draw.dt",function(e,i){var n=new t.fn.dataTable.Api(i).rows().data(),d=0,a=0,r=0;n.length>0?(t.each(n,function(t,e){"Active"==e.Status?d++:"On Hold"==e.Status?a++:"Resolved"==e.Status&&r++}),t("#incidentCounts").text(" - "+d+" Active | "+a+" On Hold | "+r+" Resolved")):t("#incidentCounts").text(" - 0")}).DataTable({columnDefs:a.dtCols,serverSide:!0,processing:!0,deferRender:!0,language:{sSearch:"Search Incidents:"},sorting:[[5,"asc"],[1,"desc"]],paging:!1,lengthMenu:[[5,10,25,-1],[5,10,25,"All"]],dom:'<"dtTop"if>rt<"dtBottom"lp><"clear">',ajax:{url:a.serviceURL,data:{cmd:"getIncidentList",guestId:a.guestId,psgId:a.psgId,rid:a.rid}},drawCallback:function(t){d.find(".hhk-report-button").button()},createdRow:function(e,i,n){t(e).attr("data-repid",i.ReportId)}});r=d,s=a,l=o,r.on("click","#incident-create",function(t){t.preventDefault(),e(r),r.incidentdialog.dialog("open")}),r.on("click",".incident-edit",function(i){i.preventDefault(),e(r);var n=t(i.target).parent().data("incidentid");t.ajax({url:s.serviceURL,dataType:"JSON",type:"post",data:{cmd:"getincidentreport",repid:n},success:function(t){t.title&&(!1===t.userCanEdit&&(r.incidentdialog.find("input[name=incidentTitle]").attr("readonly","readonly"),r.incidentdialog.find("input[name=incidentDate]").attr("readonly","readonly").datepicker("destroy"),r.incidentdialog.find("textarea[name=incidentDescription]").attr("readonly","readonly")),r.incidentdialog.find("input[name=reportId]").val(n),r.incidentdialog.find("input[name=incidentTitle]").val(t.title),r.incidentdialog.find("input[name=incidentDate]").val(t.reportDate),r.incidentdialog.find("textarea[name=incidentDescription]").val(t.description),r.incidentdialog.find("option[value="+t.status+"]").attr("selected","selected"),r.incidentdialog.find("textarea[name=incidentResolution]").val(t.resolution),r.incidentdialog.find("input[name=resolutionDate]").val(t.resolutionDate),t.signature&&r.incidentdialog.find(".jsignature").jSignature("setData",t.signature),r.incidentdialog.find("input[name=signatureDate]").val(t.signatureDate),r.incidentdialog.dialog("open"))}})}),r.incidentdialog.on("change",".incidentStatus",function(e){"r"==t(e.currentTarget).val()?r.incidentdialog.find(".resdate").datepicker("setDate","today"):r.incidentdialog.find(".resdate").datepicker("setDate","")}),r.incidentdialog.on("click",".hhk-finish-signature-btn",function(t){r.incidentdialog.find(".sigDate").datepicker("setDate","today")}),r.on("click",".incident-delete",function(e){var i=t(this).data("reportid"),n=t(this).closest("tr");e.preventDefault(),t.ajax({url:s.serviceURL,dataType:"JSON",type:"post",data:{cmd:"deleteIncident",idReport:i},success:function(t){t.idReport>0?(n.find("td:not(:first)").css("opacity","0.3"),n.find(".incident-action").hide(),n.find(".incident-delete").hide(),n.find(".incident-edit").hide(),n.find(".incident-undodelete").show()):s.alertMessage(t.error,"error")}})}),r.on("click",".incident-undodelete",function(e){var i=t(this).data("reportid"),n=t(this).parents("tr");e.preventDefault(),t.ajax({url:s.serviceURL,dataType:"JSON",type:"post",data:{cmd:"undoDeleteIncident",idReport:i},success:function(t){if(t.idReport>0){var e=l.row(n).data();l.row(n).data(e),n.find("td").css("opacity","1")}else s.alertMessage(t.error,"error")}})}),t(".dataTables_filter").addClass("ignrSave"),t(".dtBottom").addClass("ignrSave"),d.append(d.incidentdialog),d.incidentdialog.dialog({autoOpen:!1,modal:!0,width:getDialogWidth(800),open:function(e,i){t(document).find(".ui-widget-overlay").addClass("hhk-private-dialog")},close:function(e,i){t(document).find(".ui-widget-overlay").removeClass("hhk-private-dialog")},buttons:{Cancel:function(){d.incidentdialog.dialog("close"),e(d)},"Save and Print":function(){i(d,a,o,!0)},Save:function(){i(d,a,o)}}})}}(r,a),this}}(jQuery);