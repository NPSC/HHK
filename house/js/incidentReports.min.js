!function(s){function l(t){t.incidentdialog.find("input").val(""),t.incidentdialog.find("input").removeClass("ui-state-error"),t.incidentdialog.find("textarea").empty(),t.incidentdialog.find("textarea").val(""),t.incidentdialog.find("option").removeAttr("selected"),t.incidentdialog.find(".incidentStatus").val("a"),t.incidentdialog.find(".jsignature").empty(),t.incidentdialog.find(".jsignature").jSignature({width:"563px",height:"141px"}),t.incidentdialog.find(".hhk-clear-signature-btn").button(),t.incidentdialog.find(".hhk-finish-signature-btn").button(),t.incidentdialog.on("click",".hhk-clear-signature-btn",function(){t.incidentdialog.find(".jsignature").jSignature("clear"),t.incidentdialog.find(".sigDate").datepicker("setDate","")}),t.incidentdialog.find(".incdate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"}).datepicker("setDate","today"),t.incidentdialog.find(".resdate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"}),t.incidentdialog.find(".sigDate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"})}function a(e,i,n,d){var t,a,r=!1;null==d&&(d=!1),""==e.incidentdialog.find("input[name=incidentTitle]").val()?(r=!0,e.incidentdialog.find("input[name=incidentTitle]").addClass("ui-state-error")):e.incidentdialog.find("input[name=incidentTitle]").removeClass("ui-state-error"),""==e.incidentdialog.find("input[name=incidentDate]").val()?(r=!0,e.incidentdialog.find("input[name=incidentDate]").addClass("ui-state-error")):e.incidentdialog.find("input[name=incidentDate]").removeClass("ui-state-error"),1==r?i.alertMessage("Incident not saved. Check fields in red.","alert"):(t=e.incidentdialog.find("input[name=reportId]").val(),a=e.incidentdialog.find("form").serialize(),a+="&signature="+encodeURIComponent(e.incidentdialog.find(".jsignature").jSignature("getData")),a+=0<t?"&cmd=editIncident&repId="+t:"&cmd=saveIncident&guestId="+i.guestId+"&psgId="+i.psgId,s.ajax({url:i.serviceURL,dataType:"JSON",type:"post",data:a,success:function(t){0<t.idReport?(d&&function(t,e){null==e&&(e=0);s.ajax({url:t.serviceURL,dataType:"JSON",type:"post",data:{cmd:"getincidentreport",print:!0,repid:e},success:function(t){var e,i,n;t.title&&(e="","a"==t.status?e="Active":"h"==t.status?e="On Hold":"r"==t.status&&(e="Resolved"),i='<div id="incidentPrint">',t.guest&&(i+="<h3>"+guestLabel+'</h3><table cellpadding="10" style="margin-bottom: 2em;"><thead><tr><th>Name</th><th>Phone</th><th>Address</th></tr></thead><tbody><tr><td> '+t.guest.First+" "+t.guest.Last+"</td><td>"+t.guest.Phone+"</td>",t.guest.Address?i+="<td>"+t.guest.Address+"<br>"+t.guest.City+", "+t.guest.State+" "+t.guest.Zip+"</td>":i+="<td></td>",i+="</tr></tbody></table>"),i+='<h3>Incident</h3><table cellpadding="10"><tr><td class="tdlabel">Title</td><td>'+t.title+'</td></tr><tr><td class="tdlabel">Date</td><td>'+t.reportDate+'</td></tr><tr><td class="tdlabel">Author</td><td>'+t.createdBy+'</td></tr><tr><td class="tdlabel">Description</td><td>'+t.description+'</td></tr><tr><td class="tdlabel">Status</td><td>'+e+'</td></tr><tr><td class="tdlabel">Resolution</td><td>'+t.resolution+'</td></tr><tr><td class="tdlabel" style="width: 25%;">Resolution Date</td><td>'+t.resolutionDate+'</td></tr><tr><td class="tdlabel" style="width: 25%; height: 100px;">Signature</td>',t.signature?i+='<td><img src="'+t.signature+'"></td>':i+="<td></td>",i+='</tr><tr><td class="tdlabel">Signature Date</td><td>'+t.signatureDate+"</td></tr>",t.updatedBy&&(i+='<tr><td class="tdlabel">Updated</td><td>'+t.updatedBy+" - "+t.updatedAt+"</td></tr>"),i+="</table></div>",(n=window.open("","PRINT","height=600,width=800")).document.write("<html><head><title>"+document.title+"</title>"),n.document.write('<link href="css/house.css" rel="stylesheet" type="text/css">'),n.document.write('<link href="css/incidentReports.css" rel="stylesheet" type="text/css">'),n.document.write('</head><body class="PrintArea hhk-visitdialog hhk-tdbox">'),n.document.write("<h2>"+document.title+" - Incident Report</h2>"),n.document.write(i),n.document.write("</body></html>"),n.document.close(),n.focus(),n.print())}})}(i,t.idReport),n.ajax.reload(),e.incidentdialog.dialog("close"),l(e)):t.error?i.alertMessage(t.error,"alert"):i.alertMessage("An unknown error occurred.","alert")}}))}s.fn.incidentViewer=function(t){var e=s('<div id="incidentDialog" class="hhk-tdbox hhk-visitdialog" title="Incident"><form><input type="hidden" name="reportId"><table><tr><td class="tdlabel">Incident Title</td><td><input type="text" name="incidentTitle"></td></tr><tr><td class="tdlabel">Incident Date</td><td><input type="text" name="incidentDate" class="incdate" readonly="readonly"></td></tr><tr><td class="tdlabel">Incident Description</td><td><textarea name="incidentDescription" rows="5"></textarea></td></tr><tr><td class="tdlabel">Incident Status</td><td><select name="incidentStatus" class="incidentStatus"><option value="a">Active</option><option value="r">Resolved</option><option value="h">On Hold</option><option value="d">Delete</option></select></td></tr><tr><td class="tdlabel">Incident Resolution</td><td><textarea name="incidentResolution" rows="5"></textarea></td></tr><tr><td class="tdlabel" style="width: 25%">Resolution Date</td><td><input type="text" name="resolutionDate" class="resdate" readonly="readonly"></td></tr><tr><td class="tdlabel" style="width: 25%">Signature<br><div style="color: #959595; display: block;">Use your mouse, finger or touch pen to sign</div><span></td><td><div class="signature-actions" style="text-align: right;"><div style="display: inline-block" class="hhk-clear-signature-btn hhk-report-button incident-edit ui-corner-all ui-state-default">Clear Signature</span></div><div style="display: inline-block" class="hhk-finish-signature-btn hhk-report-button incident-edit ui-corner-all ui-state-default">Finish Signature</span></div></div><div style="height: 141px;" class="jsignature"></div></td></tr><td class="tdlabel">Signature Date</td><td><input type="text" name="signatureDate" class="sigDate" readonly="readonly"></td></table></form></div>'),i={guestId:0,psgId:0,rid:0,serviceURL:"ws_resv.php",newLabel:"New Incident",guestLabel:"Guest",visitorLabel:"Guest",tableAttrs:{class:"display compact",width:"100%"},newIncidentAttrs:{id:"incidentTitle",style:"width: 80%;",rows:2},alertMessage:function(t,e){},dtCols:[{targets:[0],title:"Actions",data:"Action",sortable:!1,searchable:!1,render:function(t,e,i){return n=t,d=s("<ul />").addClass("ui-widget ui-helper-clearfix hhk-ui-icons"),(a=s('<li title="Edit Incident" data-incidentid="'+n+'" />').addClass("hhk-report-button incident-edit ui-corner-all ui-state-default")).append(s('<span class="ui-icon ui-icon-pencil" />')),d.append(a),(a=s('<li title="Delete report" data-reportid="'+n+'" />').addClass("hhk-report-button incident-delete ui-corner-all ui-state-default")).append(s('<span class="ui-icon ui-icon-trash" />')),d.append(a),(a=s('<li title="Undo Delete" data-reportid="'+n+'" />').addClass("hhk-report-button incident-undodelete ui-corner-all ui-state-default").hide()).append(s('<span class="ui-icon ui-icon-arrowreturnthick-1-w" />')),d.append(a),s("<div />").append(d).html();var n,d,a}},{targets:[1],title:"Date",data:"Date",render:function(t,e){return dateRender(t,e,dateFormat)}},{targets:[2],title:'Guest',searchable:!0,sortable:!0,data:"Guest"},{targets:[3],title:"Title",searchable:!0,sortable:!1,width:"70%",className:"incidentTitle",data:"Title"},{targets:[4],title:"User",sortable:!1,searchable:!1,visible:!0,data:"User"},{targets:[5],title:"Status",sortable:!0,searchable:!0,visible:!0,data:"Status"}]},n=s.extend(!0,{},i,t),d=s(this);return d.incidentdialog=e,function(e,t){{var i;(0<t.guestId||0<t.psgId||0<t.rid)&&(s('<div class="ui-button ui-corner-all ui-state-default" id="incident-create"><span class="ui-icon ui-icon-plus"></span>New Incident</div>').appendTo(e),i=s("<table />").attr(t.tableAttrs).appendTo(e).on("draw.dt",function(t,e){var i=new s.fn.dataTable.Api(e).rows().data(),n=0,d=0,a=0;0<i.length?(s.each(i,function(t,e){"Active"==e.Status?n++:"On Hold"==e.Status?d++:"Resolved"==e.Status&&a++}),s("#incidentCounts").text(" - "+n+" Active | "+d+" On Hold | "+a+" Resolved")):s("#incidentCounts").text(" - 0")}).DataTable({columnDefs:t.dtCols,serverSide:!0,processing:!0,deferRender:!0,language:{sSearch:"Search Incidents:"},sorting:[[5,"asc"],[1,"desc"]],paging:!1,lengthMenu:[[5,10,25,-1],[5,10,25,"All"]],dom:'<"dtTop"if>rt<"dtBottom"lp><"clear">',ajax:{url:t.serviceURL,data:{cmd:"getIncidentList",guestId:t.guestId,psgId:t.psgId,rid:t.rid}},drawCallback:function(t){e.find(".hhk-report-button").button()},createdRow:function(t,e,i){s(t).attr("data-repid",e.ReportId)}}),function(i,n,d){i.on("click","#incident-create",function(t){t.preventDefault(),l(i),i.incidentdialog.dialog("open")}),i.on("click",".incident-edit",function(t){t.preventDefault(),l(i);var e=s(t.target).parent().data("incidentid");s.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:{cmd:"getincidentreport",repid:e},success:function(t){t.title&&(i.incidentdialog.find("input[name=reportId]").val(e),i.incidentdialog.find("input[name=incidentTitle]").val(t.title),i.incidentdialog.find("input[name=incidentDate]").val(t.reportDate),i.incidentdialog.find("textarea[name=incidentDescription]").val(t.description),i.incidentdialog.find("option[value="+t.status+"]").attr("selected","selected"),i.incidentdialog.find("textarea[name=incidentResolution]").val(t.resolution),i.incidentdialog.find("input[name=resolutionDate]").val(t.resolutionDate),t.signature&&i.incidentdialog.find(".jsignature").jSignature("setData",t.signature),i.incidentdialog.find("input[name=signatureDate]").val(t.signatureDate),i.incidentdialog.dialog("open"))}})}),i.incidentdialog.on("change",".incidentStatus",function(t){"r"==s(t.currentTarget).val()?i.incidentdialog.find(".resdate").datepicker("setDate","today"):i.incidentdialog.find(".resdate").datepicker("setDate","")}),i.incidentdialog.on("click",".hhk-finish-signature-btn",function(t){i.incidentdialog.find(".sigDate").datepicker("setDate","today")}),i.on("click",".incident-delete",function(t){var e=s(this).data("reportid"),i=s(this).closest("tr");t.preventDefault(),s.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:{cmd:"deleteIncident",idReport:e},success:function(t){0<t.idReport?(i.find("td:not(:first)").css("opacity","0.3"),i.find(".incident-action").hide(),i.find(".incident-delete").hide(),i.find(".incident-edit").hide(),i.find(".incident-undodelete").show()):n.alertMessage(t.error,"error")}})}),i.on("click",".incident-undodelete",function(t){var e=s(this).data("reportid"),i=s(this).parents("tr");t.preventDefault(),s.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:{cmd:"undoDeleteIncident",idReport:e},success:function(t){var e;0<t.idReport?(e=d.row(i).data(),d.row(i).data(e),i.find("td").css("opacity","1")):n.alertMessage(t.error,"error")}})})}(e,t,i),s(".dataTables_filter").addClass("ignrSave"),s(".dtBottom").addClass("ignrSave"),e.append(e.incidentdialog),e.incidentdialog.dialog({autoOpen:!1,modal:!0,width:800,buttons:{Cancel:function(){e.incidentdialog.dialog("close"),l(e)},"Save and Print":function(){a(e,t,i,!0)},Save:function(){a(e,t,i)}}}))}}(d,n),this}}(jQuery);
