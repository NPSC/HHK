!function($){function a(a){a.incidentdialog.find("input").val(""),a.incidentdialog.find("input").removeClass("ui-state-error"),a.incidentdialog.find("textarea").empty(),a.incidentdialog.find("textarea").val(""),a.incidentdialog.find("option").removeAttr("selected"),a.incidentdialog.find(".incidentStatus").val("a"),a.incidentdialog.find(".jsignature").empty(),a.incidentdialog.find(".jsignature").jSignature({width:"563px",height:"141px"}),a.incidentdialog.find(".hhk-clear-signature-btn").button(),a.incidentdialog.find(".hhk-finish-signature-btn").button(),a.incidentdialog.on("click",".hhk-clear-signature-btn",function(){a.incidentdialog.find(".jsignature").jSignature("clear"),a.incidentdialog.find(".sigDate").datepicker("setDate","")}),a.incidentdialog.find(".incdate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"}).datepicker("setDate","today"),a.incidentdialog.find(".resdate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"}),a.incidentdialog.find(".sigDate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"})}function b(b,d,j,g){var f=!1;if(null==g&&(g=!1),""==b.incidentdialog.find("input[name=incidentTitle]").val()?(f=!0,b.incidentdialog.find("input[name=incidentTitle]").addClass("ui-state-error")):b.incidentdialog.find("input[name=incidentTitle]").removeClass("ui-state-error"),""==b.incidentdialog.find("input[name=incidentDate]").val()?(f=!0,b.incidentdialog.find("input[name=incidentDate]").addClass("ui-state-error")):b.incidentdialog.find("input[name=incidentDate]").removeClass("ui-state-error"),!0==f)d.alertMessage("Incident not saved. Check fields in red.","alert");else{var h=b.incidentdialog.find("input[name=reportId]").val(),e=b.incidentdialog.find("form").serialize(),i=encodeURIComponent(b.incidentdialog.find(".jsignature").jSignature("getData"));e+="&signature="+i,h>0?e+="&cmd=editIncident&repId="+h:e+="&cmd=saveIncident&guestId="+d.guestId+"&psgId="+d.psgId,$.ajax({url:d.serviceURL,dataType:"JSON",type:"post",data:e,success:function(e){e.idReport>0?(g&&c(b,d,e.idReport),j.ajax.reload(),b.incidentdialog.dialog("close"),a(b)):e.error?d.alertMessage(e.error,"alert"):d.alertMessage("An unknown error occurred.","alert")}})}}function c(c,b,a){return null==a&&(a=0),$.ajax({url:b.serviceURL,dataType:"JSON",type:"post",data:{cmd:"getincidentreport",print:!0,repid:a},success:function(a){if(a.title){var e="";"a"==a.status?e="Active":"h"==a.status?e="On Hold":"r"==a.status&&(e="Resolved");var c='<div id="incidentPrint">';a.guest&&(c+="<h3>"+b.visitorLabel+'</h3><table cellpadding="10" style="margin-bottom: 2em;"><thead><tr><th>Name</th><th>Phone</th><th>Address</th></tr></thead><tbody><tr><td> '+a.guest.First+" "+a.guest.Last+"</td><td>"+a.guest.Phone+"</td>",a.guest.Address?c+="<td>"+a.guest.Address+"<br>"+a.guest.City+", "+a.guest.State+" "+a.guest.Zip+"</td>":c+="<td></td>",c+="</tr></tbody></table>"),c+='<h3>Incident</h3><table cellpadding="10"><tr><td class="tdlabel">Title</td><td>'+a.title+'</td></tr><tr><td class="tdlabel">Date</td><td>'+a.reportDate+'</td></tr><tr><td class="tdlabel">Author</td><td>'+a.createdBy+'</td></tr><tr><td class="tdlabel">Description</td><td>'+a.description+'</td></tr><tr><td class="tdlabel">Status</td><td>'+e+'</td></tr><tr><td class="tdlabel">Resolution</td><td>'+a.resolution+'</td></tr><tr><td class="tdlabel" style="width: 25%;">Resolution Date</td><td>'+a.resolutionDate+'</td></tr><tr><td class="tdlabel" style="width: 25%; height: 100px;">Signature</td>',a.signature?c+='<td><img src="'+a.signature+'"></td>':c+="<td></td>",c+='</tr><tr><td class="tdlabel">Signature Date</td><td>'+a.signatureDate+"</td></tr>",a.updatedBy&&(c+='<tr><td class="tdlabel">Updated</td><td>'+a.updatedBy+" - "+a.updatedAt+"</td></tr>"),c+="</table></div>";var d=window.open("","PRINT","height=600,width=800");d.document.write("<html><head><title>"+document.title+"</title>"),d.document.write('<link href="css/house.css" rel="stylesheet" type="text/css">'),d.document.write('<link href="css/incidentReports.css" rel="stylesheet" type="text/css">'),d.document.write('</head><body class="PrintArea hhk-visitdialog hhk-tdbox">'),d.document.write("<h2>"+document.title+" - Incident Report</h2>"),d.document.write(c),d.document.write("</body></html>"),d.document.close(),d.focus(),d.print()}}}),!0}$.fn.incidentViewer=function(e){var f=$('<div id="incidentDialog" class="hhk-tdbox hhk-visitdialog" title="Incident"><form><input type="hidden" name="reportId"><table><tr><td class="tdlabel">Incident Title</td><td><input type="text" name="incidentTitle"></td></tr><tr><td class="tdlabel">Incident Date</td><td><input type="text" name="incidentDate" class="incdate" readonly="readonly"></td></tr><tr><td class="tdlabel">Incident Description</td><td><textarea name="incidentDescription" rows="5"></textarea></td></tr><tr><td class="tdlabel">Incident Status</td><td><select name="incidentStatus" class="incidentStatus"><option value="a">Active</option><option value="r">Resolved</option><option value="h">On Hold</option><option value="d">Delete</option></select></td></tr><tr><td class="tdlabel">Incident Resolution</td><td><textarea name="incidentResolution" rows="5"></textarea></td></tr><tr><td class="tdlabel" style="width: 25%">Resolution Date</td><td><input type="text" name="resolutionDate" class="resdate" readonly="readonly"></td></tr><tr><td class="tdlabel" style="width: 25%">Signature<br><div style="color: #959595; display: block;">Use your mouse, finger or touch pen to sign</div><span></td><td><div class="signature-actions" style="text-align: right;"><div style="display: inline-block" class="hhk-clear-signature-btn hhk-report-button incident-edit ui-corner-all ui-state-default">Clear Signature</span></div><div style="display: inline-block" class="hhk-finish-signature-btn hhk-report-button incident-edit ui-corner-all ui-state-default">Finish Signature</span></div></div><div style="height: 141px;" class="jsignature"></div></td></tr><td class="tdlabel">Signature Date</td><td><input type="text" name="signatureDate" class="sigDate" readonly="readonly"></td></table></form></div>'),c=$.extend(!0,{},{guestId:0,psgId:0,rid:0,serviceURL:"ws_resv.php",newLabel:"New Incident",guestLabel:"Guest",visitorLabel:"Guest",tableAttrs:{class:"display compact",width:"100%"},newIncidentAttrs:{id:"incidentTitle",style:"width: 80%;",rows:2},alertMessage:function(a,b){}},e);c.dtCols=[{targets:[0],title:"Actions",data:"Action",sortable:!1,searchable:!1,render:function(d,e,f){var c,g,b,a;return c=d,b=$("<ul />").addClass("ui-widget ui-helper-clearfix hhk-ui-icons"),a=$('<li title="Edit Incident" data-incidentid="'+c+'" />').addClass("hhk-report-button incident-edit ui-corner-all ui-state-default"),a.append($('<span class="ui-icon ui-icon-pencil" />')),b.append(a),a=$('<li title="Delete report" data-reportid="'+c+'" />').addClass("hhk-report-button incident-delete ui-corner-all ui-state-default"),a.append($('<span class="ui-icon ui-icon-trash" />')),b.append(a),a=$('<li title="Undo Delete" data-reportid="'+c+'" />').addClass("hhk-report-button incident-undodelete ui-corner-all ui-state-default").hide(),a.append($('<span class="ui-icon ui-icon-arrowreturnthick-1-w" />')),b.append(a),$("<div />").append(b).html()}},{targets:[1],title:"Date",data:"Date",render:function(a,b){return dateRender(a,b,dateFormat)}},{targets:[2],title:c.visitorLabel,searchable:!0,sortable:!0,data:"Guest"},{targets:[3],title:"Title",searchable:!0,sortable:!1,width:"70%",className:"incidentTitle",data:"Title"},{targets:[4],title:"User",sortable:!1,searchable:!1,visible:!0,data:"User"},{targets:[5],title:"Status",sortable:!0,searchable:!0,visible:!0,data:"Status"}];var d=$(this);return d.incidentdialog=f,function i(e,c){if(c.guestId>0||c.psgId>0||c.rid>0){$('<div class="ui-button ui-corner-all ui-state-default" id="incident-create"><span class="ui-icon ui-icon-plus"></span>New Incident</div>').appendTo(e);var d,f,g,h=$("<table />").attr(c.tableAttrs).appendTo(e).on("draw.dt",function(f,b){var a=new $.fn.dataTable.Api(b).rows().data(),c=0,d=0,e=0;a.length>0?($.each(a,function(b,a){"Active"==a.Status?c++:"On Hold"==a.Status?d++:"Resolved"==a.Status&&e++}),$("#incidentCounts").text(" - "+c+" Active | "+d+" On Hold | "+e+" Resolved")):$("#incidentCounts").text(" - 0")}).DataTable({columnDefs:c.dtCols,serverSide:!0,processing:!0,deferRender:!0,language:{sSearch:"Search Incidents:"},sorting:[[5,"asc"],[1,"desc"]],paging:!1,lengthMenu:[[5,10,25,-1],[5,10,25,"All"]],dom:'<"dtTop"if>rt<"dtBottom"lp><"clear">',ajax:{url:c.serviceURL,data:{cmd:"getIncidentList",guestId:c.guestId,psgId:c.psgId,rid:c.rid}},drawCallback:function(a){e.find(".hhk-report-button").button()},createdRow:function(a,b,c){$(a).attr("data-repid",b.ReportId)}});d=e,f=c,g=h,d.on("click","#incident-create",function(b){b.preventDefault(),a(d),d.incidentdialog.dialog("open")}),d.on("click",".incident-edit",function(b){b.preventDefault(),a(d);var c=$(b.target).parent().data("incidentid");$.ajax({url:f.serviceURL,dataType:"JSON",type:"post",data:{cmd:"getincidentreport",repid:c},success:function(a){a.title&&(d.incidentdialog.find("input[name=reportId]").val(c),d.incidentdialog.find("input[name=incidentTitle]").val(a.title),d.incidentdialog.find("input[name=incidentDate]").val(a.reportDate),d.incidentdialog.find("textarea[name=incidentDescription]").val(a.description),d.incidentdialog.find("option[value="+a.status+"]").attr("selected","selected"),d.incidentdialog.find("textarea[name=incidentResolution]").val(a.resolution),d.incidentdialog.find("input[name=resolutionDate]").val(a.resolutionDate),a.signature&&d.incidentdialog.find(".jsignature").jSignature("setData",a.signature),d.incidentdialog.find("input[name=signatureDate]").val(a.signatureDate),d.incidentdialog.dialog("open"))}})}),d.incidentdialog.on("change",".incidentStatus",function(a){"r"==$(a.currentTarget).val()?d.incidentdialog.find(".resdate").datepicker("setDate","today"):d.incidentdialog.find(".resdate").datepicker("setDate","")}),d.incidentdialog.on("click",".hhk-finish-signature-btn",function(a){d.incidentdialog.find(".sigDate").datepicker("setDate","today")}),d.on("click",".incident-delete",function(a){var b=$(this).data("reportid"),c=$(this).closest("tr");a.preventDefault(),$.ajax({url:f.serviceURL,dataType:"JSON",type:"post",data:{cmd:"deleteIncident",idReport:b},success:function(a){a.idReport>0?(c.find("td:not(:first)").css("opacity","0.3"),c.find(".incident-action").hide(),c.find(".incident-delete").hide(),c.find(".incident-edit").hide(),c.find(".incident-undodelete").show()):f.alertMessage(a.error,"error")}})}),d.on("click",".incident-undodelete",function(a){var b=$(this).data("reportid"),c=$(this).parents("tr");a.preventDefault(),$.ajax({url:f.serviceURL,dataType:"JSON",type:"post",data:{cmd:"undoDeleteIncident",idReport:b},success:function(a){if(a.idReport>0){var b=g.row(c).data();g.row(c).data(b),c.find("td").css("opacity","1")}else f.alertMessage(a.error,"error")}})}),$(".dataTables_filter").addClass("ignrSave"),$(".dtBottom").addClass("ignrSave"),e.append(e.incidentdialog),e.incidentdialog.dialog({autoOpen:!1,modal:!0,width:getDialogWidth(800),buttons:{Cancel:function(){e.incidentdialog.dialog("close"),a(e)},"Save and Print":function(){b(e,c,h,!0)},Save:function(){b(e,c,h)}}})}}(d,c),this}}(jQuery)