function setupVisitNotes(e,t){return t.notesViewer({linkId:e,linkType:"visit",newNoteAttrs:{id:"taNewVNote",name:"taNewVNote"},alertMessage:function(e,t){flagAlertMessage(e,t)}}),t}function getVisitRoomList(e,t,a,i){i.prop("disabled",!0),$("#hhk-roomChsrtitle").addClass("hhk-loading"),$("#rmDepMessage").text("").hide();var n={cmd:"chgRoomList",idVisit:e,span:t,chgDate:a,selRescId:i.val()};$.post("ws_ckin.php",n,function(e){var t;i.prop("disabled",!1),$("#hhk-roomChsrtitle").removeClass("hhk-loading");try{e=$.parseJSON(e)}catch(e){return void alert("Parser error - "+e.message)}if(e.error)return e.gotopage&&window.open(e.gotopage),void flagAlertMessage(e.error,"error");e.sel&&(t=$(e.sel),i.children().remove(),t.children().appendTo(i),i.val(e.idResc).change())})}function viewHospitalStay(e,t,a){$.post("ws_resv.php",{cmd:"viewHS",idhs:e},function(i){if(i){try{i=$.parseJSON(i)}catch(e){return void alert("Bad JSON Encoding")}if(i.error)return i.gotopage&&window.open(i.gotopage,"_self"),void flagAlertMessage(i.error,"error");i.success&&(a.empty(),a.append($(i.success)),a.dialog({autoOpen:!0,width:1e3,resizable:!0,modal:!0,title:i.title?i.title:"Hospital Details",buttons:{Cancel:function(){$(this).dialog("close")},Save:function(){saveHospitalStay(e,t),$(this).dialog("close")}}}),$("#keysfees").length>0&&$("#keysfees").on("dialogclose",function(e,t){a.dialog("isOpen")&&a.dialog("close")}),createAutoComplete($(".hhk-hsdialog #txtAgentSch"),3,{cmd:"filter",add:"phone",basis:"ra"},getAgent),""===$(".hhk-hsdialog #a_txtLastName").val()&&$(".hhk-hsdialog .hhk-agentInfo").hide(),$(document).on("click","#a_delete",function(){$(".hhk-hsdialog #a_idName").val(""),$(".hhk-hsdialog input.hhk-agentInfo").val(""),$(".hhk-hsdialog .hhk-agentInfo").hide()}),""!==$(".hhk-hsdialog #a_idName").val()?$(".hhk-hsdialog input.hhk-agentInfo.name").attr("readonly","readonly"):$(".hhk-hsdialog input.hhk-agentInfo.name").removeAttr("readonly"),createAutoComplete($(".hhk-hsdialog #txtDocSch"),3,{cmd:"filter",basis:"doc"},getDoc),""===$(".hhk-hsdialog #d_txtLastName").val()&&$(".hhk-hsdialog .hhk-docInfo").hide(),""!==$(".hhk-hsdialog #d_idName").val()?$(".hhk-hsdialog input.hhk-docInfo.name").attr("readonly","readonly"):$(".hhk-hsdialog input.hhk-docInfo.name").removeAttr("readonly"),$(document).on("click","#d_delete",function(){$(".hhk-hsdialog #d_idName").val(""),$(".hhk-hsdialog input.hhk-docInfo").val(""),$(".hhk-hsdialog .hhk-docInfo").hide()}),$(".ckhsdate").datepicker({yearRange:"-01:+01",changeMonth:!0,changeYear:!0,autoSize:!0,dateFormat:"M d, yy"}))}else alert("Bad Reply from Server")})}function saveHospitalStay(e,t){var a=(a=[{name:"cmd",value:"saveHS"},{name:"idhs",value:e},{name:"idv",value:t}]).concat($(".hospital-stay").serializeArray());$.post("ws_resv.php",a,function(e){if(e){try{e=$.parseJSON(e)}catch(e){return void alert("Bad JSON Encoding")}if(e.error)return e.gotopage&&window.open(e.gotopage,"_self"),void flagAlertMessage(e.error,"error");e.success&&flagAlertMessage(e.success,"success")}else alert("Bad Reply from Server")})}var isCheckedOut=!1;function viewVisit(e,t,a,i,n,o,s){"use strict";$.post("ws_ckin.php",{cmd:"visitFees",idVisit:t,idGuest:e,action:n,span:o,ckoutdt:s},function(s){if(s){try{s=$.parseJSON(s)}catch(e){return void alert("Parser error - "+e.message)}if(s.error)return s.gotopage?void window.location.assign(s.gotopage):void flagAlertMessage(s.error,"error");var h=$("#keysfees");if(h.children().remove(),h.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog" style="font-size:0.8em;"/>').append($(s.success))),h.find(".ckdate").datepicker({yearRange:"-07:+01",changeMonth:!0,changeYear:!0,autoSize:!0,numberOfMonths:1,maxDate:0,dateFormat:"M d, yy",onSelect:function(){this.lastShown=(new Date).getTime()},beforeShow:function(){var e=(new Date).getTime();return void 0===this.lastShown||e-this.lastShown>500},onClose:function(){$(this).change()}}),h.find(".ckdateFut").datepicker({yearRange:"-02:+01",changeMonth:!0,changeYear:!0,autoSize:!0,numberOfMonths:1,minDate:0,dateFormat:"M d, yy",onSelect:function(){this.lastShown=(new Date).getTime()},beforeShow:function(){var e=(new Date).getTime();return void 0===this.lastShown||e-this.lastShown>500},onClose:function(){$(this).change()}}),h.css("background-color","#fff"),"ref"===n&&(h.css("background-color","#FEFF9B"),$(".hhk-ckoutDate").prop("disabled",!0)),$(".hhk-extVisitSw").length>0&&($(".hhk-extVisitSw").change(function(){this.checked?$(".hhk-extendVisit").show("fade"):$(".hhk-extendVisit").hide("fade")}),$(".hhk-extVisitSw").change()),$("#rateChgCB").length>0){var r=$("#chgRateDate");r.datepicker({changeMonth:!0,changeYear:!0,autoSize:!0,numberOfMonths:1,dateFormat:"M d, yy",maxDate:new Date(s.end),minDate:new Date(s.start)}),r.change(function(){""!==this.value&&r.siblings("input#rbReplaceRate").prop("checked",!0)}),$("input#rbReplaceRate").change(function(){this.checked&&""===r.val()?r.val($.datepicker.formatDate("M d, yy",new Date)):r.val("")}),$("#rateChgCB").change(function(){this.checked?($(".changeRateTd").show(),$("#showRateTd").hide("fade")):($(".changeRateTd").hide("fade"),$("#showRateTd").show())}),$("#rateChgCB").change()}$("#tblActiveVisit").on("click",".hhk-hospitalstay",function(e){e.preventDefault(),viewHospitalStay($(this).data("idhs"),t,$("#hsDialog"))}),$("#spnExPay").hide(),isCheckedOut=!1;var d=0,c=0,l=0;if($("#spnCfBalDue").length>0&&(d=parseFloat($("#spnCfBalDue").data("rmbal")),c=parseFloat($("#spnCfBalDue").data("vfee")),l=parseFloat($("#spnCfBalDue").data("totbal"))),$("input.hhk-ckoutCB").length>0)$("#tblStays").on("change","input.hhk-ckoutCB",function(){var s=!0,r=1,g=new Date,p={};if(!1===this.checked?$(this).next().val(""):""===$(this).next().val()&&$(this).next().val($.datepicker.formatDate("M d, yy",new Date)),$("input.hhk-ckoutCB").each(function(){if(!1===this.checked)s=!1;else if(""!=$(this).next().val()){var e=new Date($(this).next().val());p[$(this).next().data("gid")]=e.toDateString(),e.getTime()>g.getTime()?($(this).next().val(""),s=!1):e.getTime()>r&&(r=e.getTime())}}),!0===s){isCheckedOut=!0;var u=(g=new Date).getFullYear()+"-"+g.getMonth()+"-"+g.getDate(),f=new Date(r),v=f.getFullYear()+"-"+f.getMonth()+"-"+f.getDate();if(f.getTime()>g.getTime())return!1;if(u!==v&&"ref"!==n)return h.children().remove(),h.dialog("option","buttons",{}),h.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog"/>').append($('<div class="ui-autocomplete-loading" style="width:5em;">Loading</div>'))),void viewVisit(e,t,a,i,"ref",o,p);$(".hhk-kdrow").hide("fade"),$(".hhk-finalPayment").show("fade");var k=parseFloat($("#kdPaid").data("amt"));isNaN(k)&&(k=0),k>0?($("#DepRefundAmount").val((0-k).toFixed(2).toString()),$(".hhk-refundDeposit").show("fade")):($("#DepRefundAmount").val(""),$(".hhk-refundDeposit").hide("fade")),$("#cbDepRefundApply").trigger("change"),l<0?($("#guestCredit").val(d.toFixed(2).toString()),$("#feesCharges").val(""),$(".hhk-RoomCharge").hide(),$(".hhk-GuestCredit").show()):($("#feesCharges").val(d.toFixed(2).toString()),$("#guestCredit").val(""),$(".hhk-GuestCredit").hide(),$(".hhk-RoomCharge").show(),$("#visitFeeCb").length>0&&Math.abs(l)>=c&&$("#visitFeeCb").prop("checked",!0).prop("disabled",!0).trigger("change")),$("input#cbFinalPayment").change()}else{if("ref"===n)return h.children().remove(),h.dialog("option","buttons",{}),h.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog"/>').append($('<div class="ui-autocomplete-loading" style="width:5em;">Loading</div>'))),void viewVisit(e,t,a,i,"",o);isCheckedOut=!1,$(".hhk-finalPayment").hide("fade"),$(".hhk-GuestCredit").hide("fade"),$(".hhk-RoomCharge").hide("fade"),$("#feesCharges").val(""),$("#guestCredit").val(""),$(".hhk-refundDeposit").hide("fade"),$("#DepRefundAmount").val(""),$("input#cbFinalPayment").prop("checked",!1),$("input#cbFinalPayment").change(),$("#cbDepRefundApply").trigger("change"),$("#visitFeeCb").prop("checked",!1).prop("disabled",!1).trigger("change")}}),$("#tblStays").on("change","input.hhk-ckoutDate",function(){""!=$(this).val()?$(this).prev().prop("checked",!0):$(this).prev().prop("checked",!1);$("input.hhk-ckoutCB").change()}),$("#cbCoAll").button().click(function(){$("input.hhk-ckoutCB").each(function(){$(this).prop("checked",!0)}),$("input.hhk-ckoutCB").change()}),$("input.hhk-ckoutCB").change();else{isCheckedOut=!0,$(".hhk-finalPayment").show();var g=parseFloat($("#kdPaid").data("amt"));isNaN(g)?($("#DepRefundAmount").val(""),$(".hhk-refundDeposit").hide("fade")):($("#DepRefundAmount").val((0-g).toFixed(2).toString()),$(".hhk-refundDeposit").show("fade"),$("#cbDepRefundApply").trigger("change")),d<0?($("#guestCredit").val(d.toFixed(2).toString()),$("#feesCharges").val(""),$(".hhk-RoomCharge").hide(),$(".hhk-GuestCredit").show()):($("#feesCharges").val(d.toFixed(2).toString()),$("#guestCredit").val(""),$(".hhk-GuestCredit").hide(),$(".hhk-RoomCharge").show()),h.css("background-color","#F2F2F2")}setupPayments($("#selRateCategory"),t,o,$("#pmtRcpt"));var p=$("#btnFapp");p.length>0&&(p.button(),p.click(function(){getIncomeDiag(p.data("rid"))})),$("#btnAddGuest").length>0&&($("#btnAddGuest").button(),$("#btnAddGuest").click(function(){window.location.assign("CheckingIn.php?vid="+$(this).data("vid")+"&span="+$(this).data("span")+"&rid="+$(this).data("rid")+"&vstatus="+$(this).data("vstatus"))})),$("#selRateCategory").length>0&&($("#selRateCategory").change(function(){$(this).val()==fixedRate?($(".hhk-fxFixed").show("fade"),$(".hhk-fxAdj").hide("fade")):($(".hhk-fxFixed").hide("fade"),$(".hhk-fxAdj").show("fade"))}),$("#selRateCategory").change()),setupVisitNotes(t,h.find("#visitNoteViewer")),h.dialog("option","buttons",a),h.dialog("option","title",i),h.dialog("option","width",.92*$(window).width()),h.dialog("option","height",$(window).height()),h.dialog("open")}})}function saveFees(e,t,a,i,n){"use strict";var o=[],s=[],h=!1,r={cmd:"saveFees",idGuest:e,idVisit:t,span:a,rtntbl:!0===i?"1":"0",pbp:n};if($("input.hhk-expckout").each(function(){var e=$(this).attr("id").split("_");e.length>0&&(r[e[0]+"["+e[1]+"]"]=$(this).val())}),$("input.hhk-stayckin").each(function(){var e=$(this).attr("id").split("_");e.length>0&&(r[e[0]+"["+e[1]+"]"]=$(this).val())}),$("#undoCkout").length>0&&$("#undoCkout").prop("checked")&&(h=!0),(!isCheckedOut||!1!==verifyBalDisp()||!1!==h)&&!1!==verifyAmtTendrd()){if($("input.hhk-ckoutCB").each(function(){if(this.checked){var e=$(this).attr("id").split("_");if(e.length>0){r["stayActionCb["+e[1]+"]"]="on";var t=$("#stayCkOutDate_"+e[1]).datepicker("getDate");if(t){var a=new Date;t.setHours(a.getHours(),a.getMinutes(),0,0)}else t=new Date;$("#stayCkOutHour_"+e[1]).length>0&&(r["stayCkOutHour["+e[1]+"]"]=$("#stayCkOutHour_"+e[1]).val()),r["stayCkOutDate["+e[1]+"]"]=t.toJSON(),o.push($(this).data("nm")+", "+t.toDateString())}}}),$("input.hhk-removeCB").each(function(){if(this.checked){var e=$(this).attr("id").split("_");e.length>0&&(r[e[0]+"["+e[1]+"]"]="on",s.push($(this).data("nm")))}}),o.length>0){var d="Check Out:\n"+o.join("\n");if("1"===$("#EmptyExtend").val()&&$("#extendCb").prop("checked")&&o.length>=$("#currGuests").val()&&(d+="\nand extend the visit for "+$("#extendDays").val()+" days"),!1===confirm(d+"?"))return void $("#keysfees").dialog("close")}if(s.length>0&&!1===confirm("Remove:\n"+s.join("\n")+"?"))$("#keysfees").dialog("close");else{if($("#keyDepAmt").removeClass("ui-state-highlight"),$("#resvResource").length>0&&"0"!=$("#resvResource").val()){$("#resvChangeDate").removeClass("ui-state-highlight"),$("#chgmsg").text("");var c=$('<span id="chgmsg"/>');if(""==$("#resvChangeDate").val())return c.text("Enter a change room date."),c.css("color","red"),$("#moveTable").prepend($("<tr/>").append($('<td colspan="2">').append(c))),void $("#resvChangeDate").addClass("ui-state-highlight");var l=$("#resvChangeDate").datepicker("getDate");if(!l)return c.text("Something wrong with the change room date."),c.css("color","red"),$("#moveTable").prepend($("<tr/>").append($('<td colspan="2">').append(c))),void $("#resvChangeDate").addClass("ui-state-highlight");if(l>new Date)return c.text("Change room date can't be in the future."),c.css("color","red"),$("#moveTable").prepend($("<tr/>").append($('<td colspan="2">').append(c))),void $("#resvChangeDate").addClass("ui-state-highlight");if(!1===confirm("Change Rooms?"))return void $("#keysfees").dialog("close")}r.txtRibbonNote=$("#txtRibbonNote").val(),$("#taNewVNote").length>0&&""!==$("#taNewVNote").val()&&(r.taNewVNote=$("#taNewVNote").val()),$(".hhk-feeskeys").each(function(){if("checkbox"===$(this).attr("type"))!1!==this.checked&&(r[$(this).attr("id")]="on");else if($(this).hasClass("ckdate")){var e=$(this).datepicker("getDate");r[$(this).attr("id")]=e?e.toJSON():""}else"radio"===$(this).attr("type")?!1!==this.checked&&(r[$(this).attr("id")]=$(this).val()):r[$(this).attr("id")]=$(this).val()}),$("#keysfees").css("background-color","white"),$("#keysfees").empty().append('<div id="hhk-loading-spinner" style="width: 100%; height: 100%; margin-top: 100px; text-align: center"><img src="../images/ui-anim_basic_16x16.gif"><p>Working...</p></div>'),$.post("ws_ckin.php",r,function(i){try{i=$.parseJSON(i)}catch(e){return void alert("Parser error - "+e.message)}if(i.error)return i.gotopage&&window.location.assign(i.gotopage),void flagAlertMessage(i.error,"error");i.success&&i.openvisitviewer?($("#pmtRcpt").dialog("close"),viewVisit(e,t,{"Show Statement":function(){window.open("ShowStatement.php?vid="+t,"_blank")},"Show Registration Form":function(){window.open("ShowRegForm.php?vid="+t+"&span="+a,"_blank")},Save:function(){saveFees(e,t,a,!1,"register.php")},Cancel:function(){$(this).dialog("close")}},"Edit Visit #"+t+"-"+a,"",a)):($("#keysfees").dialog("close"),$("#pmtRcpt").dialog("close"));if(paymentRedirect(i,$("#xform")),"undefined"!=typeof refreshdTables&&refreshdTables(i),"undefined"!=typeof pageManager){var n={date1:new Date($("#gstDate").val()),date2:new Date($("#gstCoDate").val())};pageManager.doOnDatesChange(n)}i.success&&""!==i.success&&(flagAlertMessage(i.success,"success"),$("#calendar").length>0&&$("#calendar").fullCalendar("refetchEvents")),i.warning&&""!==i.warning&&flagAlertMessage(i.warning,"error"),i.receipt&&""!==i.receipt&&showReceipt("#pmtRcpt",i.receipt,"Payment Receipt"),i.invoiceNumber&&""!==i.invoiceNumber&&window.open("ShowInvoice.php?invnum="+i.invoiceNumber)})}}}function updateVisitMessage(e,t){$("#h3VisitMsgHdr").text(e),$("#spnVisitMsg").text(t),$("#visitMsg").effect("pulsate")}
