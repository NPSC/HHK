function setupVisitNotes(c,d){d.notesViewer({linkId:c,linkType:'visit',newNoteAttrs:{id:'taNewVNote',name:'taNewVNote'},alertMessage:function(a,b){flagAlertMessage(a,b)}});return d}function getVisitRoomList(c,d,e,f){f.prop('disabled',true);$('#hhk-roomChsrtitle').addClass('hhk-loading');$('#rmDepMessage').text('').hide();var g={cmd:'chgRoomList',idVisit:c,span:d,chgDate:e,selRescId:f.val()};$.post('ws_ckin.php',g,function(a){var b;f.prop('disabled',false);$('#hhk-roomChsrtitle').removeClass('hhk-loading');try{a=$.parseJSON(a)}catch(err){alert("Parser error - "+err.message);return}if(a.error){if(a.gotopage){window.open(a.gotopage)}flagAlertMessage(a.error,'error');return}if(a.sel){b=$(a.sel);f.children().remove();b.children().appendTo(f);f.val(a.idResc).change()}})}function viewHospitalStay(a,b){}var isCheckedOut=false;function viewVisit(o,p,q,r,s,t,u){"use strict";$.post('ws_ckin.php',{cmd:'visitFees',idVisit:p,idGuest:o,action:s,span:t,ckoutdt:u},function(h){"use strict";if(h){try{h=$.parseJSON(h)}catch(err){alert("Parser error - "+err.message);return}if(h.error){if(h.gotopage){window.location.assign(h.gotopage);return}flagAlertMessage(h.error,'error');return}var i=$('#keysfees');i.children().remove();i.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog" style="font-size:0.8em;"/>').append($(h.success)));i.find('.ckdate').datepicker({yearRange:'-07:+01',changeMonth:true,changeYear:true,autoSize:true,numberOfMonths:1,maxDate:0,dateFormat:'M d, yy',onSelect:function(){this.lastShown=new Date().getTime()},beforeShow:function(){var a=new Date().getTime();return this.lastShown===undefined||a-this.lastShown>500},onClose:function(){$(this).change()}});i.find('.ckdateFut').datepicker({yearRange:'-02:+01',changeMonth:true,changeYear:true,autoSize:true,numberOfMonths:1,minDate:0,dateFormat:'M d, yy',onSelect:function(){this.lastShown=new Date().getTime()},beforeShow:function(){var a=new Date().getTime();return this.lastShown===undefined||a-this.lastShown>500},onClose:function(){$(this).change()}});i.css('background-color','#fff');if(s==='ref'){i.css('background-color','#FEFF9B');$('.hhk-ckoutDate').prop('disabled',true)}if($('.hhk-extVisitSw').length>0){$('.hhk-extVisitSw').change(function(){if(this.checked){$('.hhk-extendVisit').show('fade')}else{$('.hhk-extendVisit').hide('fade')}});$('.hhk-extVisitSw').change()}if($('#rateChgCB').length>0){var j=$('#chgRateDate');j.datepicker({changeMonth:true,changeYear:true,autoSize:true,numberOfMonths:1,dateFormat:'M d, yy',maxDate:new Date(h.end),minDate:new Date(h.start)});j.change(function(){if(this.value!==''){j.siblings('input#rbReplaceRate').prop('checked',true)}});$('input#rbReplaceRate').change(function(){if(this.checked&&j.val()===''){j.val($.datepicker.formatDate('M d, yy',new Date()))}else{j.val('')}});$('#rateChgCB').change(function(){if(this.checked){$('.changeRateTd').show();$('#showRateTd').hide('fade')}else{$('.changeRateTd').hide('fade');$('#showRateTd').show()}});$('#rateChgCB').change()}$('#tblActiveVisit').on('click','.hhk-hospitalstay',function(a){a.preventDefault();viewHospitalStay($(this).data('idhs'),$('#hhk-HospitalTitle'))});$('#spnExPay').hide();isCheckedOut=false;var k=0.00;var l=0.00;if($('#spnCfBalDue').length>0){k=parseFloat($('#spnCfBalDue').data('bal'));l=parseFloat($('#spnCfBalDue').data('vfee'));k-=l}if($('input.hhk-ckoutCB').length>0){$('#tblStays').on('change','input.hhk-ckoutCB',function(){var a=true,coTime=1,b=new Date();if(this.checked===false){$(this).next().val('')}else if($(this).next().val()===''){$(this).next().val($.datepicker.formatDate('M d, yy',new Date()))}$('input.hhk-ckoutCB').each(function(){if(this.checked===false){a=false}else if($(this).next().val()!=''){var d=new Date($(this).next().val());if(d.getTime()>b.getTime()){$(this).next().val('');a=false}else if(d.getTime()>coTime){coTime=d.getTime()}}});if(a===true){isCheckedOut=true;var b=new Date();var c=b.getFullYear()+'-'+b.getMonth()+'-'+b.getDate();var e=new Date(coTime);var f=e.getFullYear()+'-'+e.getMonth()+'-'+e.getDate();if(e.getTime()>b.getTime()){return false}if(c!==f&&s!=='ref'){i.children().remove();i.dialog('option','buttons',{});i.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog"/>').append($('<div class="ui-autocomplete-loading" style="width:5em;">Loading</div>')));viewVisit(o,p,q,r,'ref',t,e.toDateString());return}$('.hhk-kdrow').hide('fade');$('.hhk-finalPayment').show('fade');var g=parseFloat($('#kdPaid').data('amt'));if(isNaN(g)){g=0}if(g>0){$('#DepRefundAmount').val((0-g).toFixed(2).toString());$('.hhk-refundDeposit').show('fade')}else{$('#DepRefundAmount').val('');$('.hhk-refundDeposit').hide('fade')}if(k<0){$('#guestCredit').val(k.toFixed(2).toString());$('#feesCharges').val('');$('.hhk-RoomCharge').hide();$('.hhk-GuestCredit').show();if($('#visitFeeCb').length>0&&Math.abs(k)>=l){$('#visitFeeCb').prop('checked',true).prop('disabled',true)}}else{$('#feesCharges').val(k.toFixed(2).toString());$('#guestCredit').val('');$('.hhk-GuestCredit').hide();$('.hhk-RoomCharge').show()}$('input#cbFinalPayment').change()}else if(s==='ref'){i.children().remove();i.dialog('option','buttons',{});i.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog"/>').append($('<div class="ui-autocomplete-loading" style="width:5em;">Loading</div>')));viewVisit(o,p,q,r,'',t);return}else{isCheckedOut=false;$('.hhk-finalPayment').hide('fade');$('.hhk-GuestCredit').hide();$('.hhk-RoomCharge').hide();$('#feesCharges').val('');$('#guestCredit').val('');$('.hhk-refundDeposit').hide('fade');$('#DepRefundAmount').val('');$('input#cbFinalPayment').prop('checked',false);$('input#cbFinalPayment').change()}});$('#tblStays').on('change','input.hhk-ckoutDate',function(){if($(this).val()!=''){var a=$(this).prev();a.prop('checked',true)}else{$(this).prev().prop('checked',false)}$('input.hhk-ckoutCB').change()});$('#cbCoAll').button().click(function(){$('input.hhk-ckoutCB').each(function(){$(this).prop('checked',true)});$('input.hhk-ckoutCB').change()});$('input.hhk-ckoutCB').change()}else if($('#cbFinalPayment').length>0){isCheckedOut=true;$('.hhk-finalPayment').show();var m=parseFloat($('#kdPaid').data('amt'));if(isNaN(m)){$('#DepRefundAmount').val('');$('.hhk-refundDeposit').hide('fade')}else{$('#DepRefundAmount').val((0-m).toFixed(2).toString());$('.hhk-refundDeposit').show('fade')}if(k<0){$('#guestCredit').val(k.toFixed(2).toString());$('#feesCharges').val('');$('.hhk-RoomCharge').hide();$('.hhk-GuestCredit').show()}else{$('#feesCharges').val(k.toFixed(2).toString());$('#guestCredit').val('');$('.hhk-GuestCredit').hide();$('.hhk-RoomCharge').show()}i.css('background-color','#F2F2F2')}setupPayments($('#selRateCategory'),p,t,$('#pmtRcpt'));if($('table#moveTable').length>0){$('table#moveTable').on('change','select',function(){$(this).removeClass('ui-state-error');var a=$(this).val();if(a==''){a=0}if($('#keyDepAmt').length>0&&h.resc[a]){if(h.resc[a].key===0){$('#spnDepAmt').data('amt','');$('#spnDepAmt').text('');$('#keyDepAmt').val('');$('#keyDepRx').prop("checked",false);$('.hhk-kdrow').hide()}else{$('#spnDepAmt').data('amt',h.resc[a].key);$('#spnDepAmt').text('($'+h.resc[a].key+')');$('#keyDepAmt').val(h.resc[a].key);$('.hhk-kdrow').show('fade')}amtPaid()}if(a>0&&h.resc[a]&&$('#myRescId').length>0){$('#rmChgMsg').text('').hide();$('#rmDepMessage').text('').hide();var b=$('#myRescId').data('idresc'),priceModel=$('#myRescId').data('pmdl');if(h.resc[b].rate!==h.resc[a].rate&&priceModel==='b'){$('#rmChgMsg').text('The room rate is different.').show('fade')}if(h.resc[b].key!==h.resc[a].key){var c='';$('#spnDepMsg').hide();$('#selDepDisposition').show('fade');if(h.resc[a].key==0){if($('#kdPaid').data('amt')!='0'){c='There is no deposit for this room.  Set the Deposit Status (above) accordingly.'}}else{c='The deposit for this room is $'+h.resc[a].key.toFixed(2).toString()}$('#rmDepMessage').text(c).show('fade')}else{$('#selDepDisposition').hide();$('#spnDepMsg').show('fade')}}$('#selRateCategory').change()});$('#selResource').change();$('#resvChangeDate').datepicker('option','onClose',function(a){$('#rbReplaceRoomnew').prop('checked',true);if(a!==''){getVisitRoomList(p,t,$('#resvChangeDate').val(),$('#selResource'))}})}var n=$('#btnFapp');if(n.length>0){n.button();n.click(function(){getIncomeDiag(n.data('rid'))})}if($('#btnAddGuest').length>0){$('#btnAddGuest').button();$('#btnAddGuest').click(function(){window.location.assign('CheckingIn.php?vid='+$(this).data('vid')+'&span='+$(this).data('span')+'&rid='+$(this).data('rid')+'&vstatus='+$(this).data('vstatus'))})}if($('#selRateCategory').length>0){$('#selRateCategory').change(function(){if($(this).val()==fixedRate){$('.hhk-fxFixed').show('fade');$('.hhk-fxAdj').hide('fade')}else{$('.hhk-fxFixed').hide('fade');$('.hhk-fxAdj').show('fade')}});$('#selRateCategory').change()}setupVisitNotes(p,i.find('#visitNoteViewer'));i.dialog('option','buttons',q);i.dialog('option','title',r);i.dialog('option','width',($(window).width()*.92));i.dialog('option','height',$(window).height());i.dialog('open')}})}function saveFees(d,e,f,g,h){"use strict";var i=[];var j=[];var k='0';var l=false;var m={cmd:'saveFees',idGuest:d,idVisit:e,span:f,rtntbl:(g===true?'1':'0'),pbp:h};$('input.hhk-expckout').each(function(){var a=$(this).attr('id').split('_');if(a.length>0){m[a[0]+'['+a[1]+']']=$(this).val()}});$('input.hhk-stayckin').each(function(){var a=$(this).attr('id').split('_');if(a.length>0){m[a[0]+'['+a[1]+']']=$(this).val()}});if($('#undoCkout').length>0&&$('#undoCkout').prop('checked')){l=true}if(isCheckedOut&&verifyBalDisp()===false&&l===false){return}if(verifyAmtTendrd()===false){return}$('input.hhk-ckoutCB').each(function(){if(this.checked){var a=$(this).attr('id').split('_');if(a.length>0){m['stayActionCb['+a[1]+']']='on';var b=$('#stayCkOutDate_'+a[1]).datepicker('getDate');if(b){var c=new Date();b.setHours(c.getHours(),c.getMinutes(),0,0)}else{b=new Date()}if($('#stayCkOutHour_'+a[1]).length>0){m['stayCkOutHour['+a[1]+']']=$('#stayCkOutHour_'+a[1]).val()}m['stayCkOutDate['+a[1]+']']=b.toJSON();i.push($(this).data('nm')+', '+b.toDateString())}}});$('input.hhk-removeCB').each(function(){if(this.checked){var a=$(this).attr('id').split('_');if(a.length>0){m[a[0]+'['+a[1]+']']='on';j.push($(this).data('nm'))}}});if(i.length>0){var n='Check Out:\n'+i.join('\n');if($('#EmptyExtend').val()==='1'&&$('#extendCb').prop('checked')&&i.length>=$('#currGuests').val()){n+='\nand extend the visit for '+$('#extendDays').val()+' days'}if(confirm(n+'?')===false){$('#keysfees').dialog("close");return}}if(j.length>0){if(confirm('Remove:\n'+j.join('\n')+'?')===false){$('#keysfees').dialog("close");return}}$('#keyDepAmt').removeClass('ui-state-highlight');if($('#resvResource').length>0){k=$('#resvResource').val();if(k!='0'){$('#resvChangeDate').removeClass('ui-state-highlight');$('#chgmsg').text('');var o=$('<span id="chgmsg"/>');if($('#resvChangeDate').val()==''){o.text("Enter a change room date.");o.css('color','red');$('#moveTable').prepend($('<tr/>').append($('<td colspan="2">').append(o)));$('#resvChangeDate').addClass('ui-state-highlight');return}var p=$('#resvChangeDate').datepicker("getDate");if(!p){o.text("Something wrong with the change room date.");o.css('color','red');$('#moveTable').prepend($('<tr/>').append($('<td colspan="2">').append(o)));$('#resvChangeDate').addClass('ui-state-highlight');return}if(p>new Date()){o.text("Change room date can't be in the future.");o.css('color','red');$('#moveTable').prepend($('<tr/>').append($('<td colspan="2">').append(o)));$('#resvChangeDate').addClass('ui-state-highlight');return}if(confirm('Change Rooms?')===false){$('#keysfees').dialog("close");return}}}if($('#taNewVNote').length>0&&$('#taNewVNote').val()!==''){m['taNewVNote']=$('#taNewVNote').val()}$('.hhk-feeskeys').each(function(){if($(this).attr('type')==='checkbox'){if(this.checked!==false){m[$(this).attr('id')]='on'}}else if($(this).hasClass('ckdate')){var a=$(this).datepicker('getDate');if(a){m[$(this).attr('id')]=a.toJSON()}else{m[$(this).attr('id')]=''}}else if($(this).attr('type')==='radio'){if(this.checked!==false){m[$(this).attr('id')]=this.value}}else{m[$(this).attr('id')]=this.value}});$('#keysfees').css('background-color','white');$('#keysfees').empty().append('<div id="hhk-loading-spinner" style="width: 100%; height: 100%; margin-top: 100px; text-align: center"><img src="../images/ui-anim_basic_16x16.gif"><p>Working...</p></div>');$.post('ws_ckin.php',m,function(a){try{a=$.parseJSON(a)}catch(err){alert("Parser error - "+err.message);return}if(a.error){if(a.gotopage){window.location.assign(a.gotopage)}flagAlertMessage(a.error,'error');return}$('#keysfees').dialog("close");paymentRedirect(a,$('#xform'));if(typeof refreshdTables!=='undefined'){refreshdTables(a)}if(typeof pageManager!=='undefined'){var b={'date1':new Date($('#gstDate').val()),'date2':new Date($('#gstCoDate').val())};pageManager.doOnDatesChange(b)}if(a.success&&a.success!==''){flagAlertMessage(a.success,'success');if($('#calendar').length>0){$('#calendar').fullCalendar('refetchEvents')}}if(a.receipt&&a.receipt!==''){showReceipt('#pmtRcpt',a.receipt,'Payment Receipt')}if(a.invoiceNumber&&a.invoiceNumber!==''){window.open('ShowInvoice.php?invnum='+a.invoiceNumber)}})}function updateVisitMessage(a,b){$('#h3VisitMsgHdr').text(a);$('#spnVisitMsg').text(b);$('#visitMsg').effect("pulsate")}
