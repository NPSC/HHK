/**
 * visitDialog.js
 *
 * @author    Eric K. Crane <ecrane@nonprofitsoftwarecorp.org>
 * @copyright 2010-2023 <nonprofitsoftwarecorp.org>
 * @license   GPL and MIT
 * @link      https://github.com/NPSC/HHK
 */ function setupVisitNotes(e, t) { return t.notesViewer({ linkId: e, linkType: "visit", newNoteAttrs: { id: "taNewVNote", name: "taNewVNote" }, alertMessage: function (e, t) { flagAlertMessage(e, t) } }), t } function viewHospitalStay(e, t, i) { $.post("ws_resv.php", { cmd: "viewHS", idhs: e }, function (a) { if (!a) { alert("Bad Reply from Server"); return } try { a = $.parseJSON(a) } catch (n) { alert("Bad JSON Encoding"); return } if (a.error) { a.gotopage && window.open(a.gotopage, "_self"), flagAlertMessage(a.error, "error"); return } if (a.success) { i.empty(), i.append($(a.success)), i.dialog({ autoOpen: !0, width: getDialogWidth(1e3), resizable: !0, modal: !0, title: a.title ? a.title : "Hospital Details", buttons: { Cancel: function () { $(this).dialog("close") }, Save: function () { saveHospitalStay(e, t), $(this).dialog("close") } } }), $("#keysfees").length > 0 && $("#keysfees").on("dialogclose", function (e, t) { i.dialog("isOpen") && i.dialog("close") }), createAutoComplete($(".hhk-hsdialog #txtAgentSch"), 3, { cmd: "filter", add: "phone", basis: "ra" }, getAgent), "" === $(".hhk-hsdialog #a_txtLastName").val() && $(".hhk-hsdialog .hhk-agentInfo").hide(), $(document).on("click", "#a_delete", function () { $(".hhk-hsdialog #a_idName").val(""), $(".hhk-hsdialog input.hhk-agentInfo").val(""), $(".hhk-hsdialog .hhk-agentInfo").hide() }), "" !== $(".hhk-hsdialog #a_idName").val() ? $(".hhk-hsdialog input.hhk-agentInfo.name").attr("readonly", "readonly") : $(".hhk-hsdialog input.hhk-agentInfo.name").removeAttr("readonly"), createAutoComplete($(".hhk-hsdialog #txtDocSch"), 3, { cmd: "filter", basis: "doc" }, getDoc), "" === $(".hhk-hsdialog #d_txtLastName").val() && $(".hhk-hsdialog .hhk-docInfo").hide(), "" !== $(".hhk-hsdialog #d_idName").val() ? $(".hhk-hsdialog input.hhk-docInfo.name").attr("readonly", "readonly") : $(".hhk-hsdialog input.hhk-docInfo.name").removeAttr("readonly"), $(document).on("click", "#d_delete", function () { $(".hhk-hsdialog #d_idName").val(""), $(".hhk-hsdialog input.hhk-docInfo").val(""), $(".hhk-hsdialog .hhk-docInfo").hide() }); let s = function (e) { "n" !== e.id && ($("#selDiagnosis").val(e.id), $("#selectedDiag").text(e.label).closest("tr").removeClass("d-none")) }; createAutoComplete($("#diagSearch"), 3, { cmd: "diagnosis" }, s, !1), $(document).on("click", "#delDiagnosis", function (e) { $("#selDiagnosis").val(""), $("#diagSearch").val(""), $(this).closest("tr").addClass("d-none") }), $(".ckhsdate").datepicker({ yearRange: "-01:+01", changeMonth: !0, changeYear: !0, autoSize: !0, numberOfMonths: 1, dateFormat: "M d, yy", showButtonPanel: !0, beforeShow: function (e) { setTimeout(function () { var t = $(e).datepicker("widget").find(".ui-datepicker-buttonpane"); t.empty(), $("<button>", { text: "Clear", click: function () { $.datepicker._clearDate(e) } }).appendTo(t).addClass("ui-datepicker-clear ui-state-default ui-priority-primary ui-corner-all") }, 1) }, onChangeMonthYear: function (e, t, i) { setTimeout(function () { var e = $(i).datepicker("widget").find(".ui-datepicker-buttonpane"); e.empty(), $("<button>", { text: "Clear", click: function () { $.datepicker._clearDate(i.input) } }).appendTo(e).addClass("ui-datepicker-clear ui-state-default ui-priority-primary ui-corner-all") }, 1) } }) } }) } function saveHospitalStay(e, t) { var i = [{ name: "cmd", value: "saveHS" }, { name: "idhs", value: e }, { name: "idv", value: t }], i = i.concat($(".hospital-stay").serializeArray()); $.post("ws_resv.php", i, function (e) { if (!e) { alert("Bad Reply from Server"); return } try { e = $.parseJSON(e) } catch (t) { alert("Bad JSON Encoding"); return } if (e.error) { e.gotopage && window.open(e.gotopage, "_self"), flagAlertMessage(e.error, "error"); return } e.success && flagAlertMessage(e.success, "success") }) } var isCheckedOut = !1; function viewVisit(e, t, i, a, n, s, o) { "use strict"; $.post("ws_ckin.php", { cmd: "visitFees", idVisit: t, idGuest: e, action: n, span: s, ckoutdt: o }, function (o) { if (null == o || "" == o) return; try { o = $.parseJSON(o) } catch (h) { alert("Parser error - " + h.message); return } if (o.error) { if (o.gotopage) { window.location.assign(o.gotopage); return } flagAlertMessage(o.error, "error"); return } var d = $("#keysfees"); if (0 == d.length || null === o.success || "" == o.success) return; if (d.children().remove(), d.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog" style="font-size:0.8em;"/>').append($(o.success))), d.find(".ckdate").datepicker({ yearRange: "-07:+01", changeMonth: !0, changeYear: !0, autoSize: !0, numberOfMonths: 1, maxDate: 0, dateFormat: "M d, yy" }), d.find(".ckdateFut").datepicker({ yearRange: "-01:+01", changeMonth: !0, changeYear: !0, autoSize: !0, numberOfMonths: 1, minDate: 0, dateFormat: "M d, yy" }), d.css("background-color", "#fff"), "ref" === n && (d.css("background-color", "#FEFF9B"), $(".hhk-ckoutDate").prop("disabled", !0)), $(".hhk-extVisitSw").length > 0 && ($("#extendDays").change(function () { $("#extendDays").removeClass("ui-state-error") }), $("#extendDate").change(function () { $("#rbOlpicker-ext").prop("checked", !0) }), $('input[name="rbOlpicker"]').change(function () { "ext" !== $(this).val() && $("#extendDate").val("") }), $(".hhk-extVisitSw").change(function () { this.checked ? ($("#rateChgCB").prop("checked", !1).change().prop("disabled", !0), $(".hhk-extendVisit").show("fade")) : ($(".hhk-extendVisit").hide("fade"), $("#rateChgCB").prop("disabled", isCheckedOut)) }), $(".hhk-extVisitSw").trigger("change")), $("#rateChgCB").length > 0) { let r = $("#chgRateDate"); r.datepicker({ changeMonth: !0, changeYear: !0, autoSize: !0, numberOfMonths: 1, dateFormat: "M d, yy", maxDate: new Date(o.end), minDate: new Date(o.start) }), r.change(function () { "" !== this.value && r.siblings("input#rbReplaceRate").prop("checked", !0) }), $("input#rbReplaceRate").change(function () { this.checked && "" === r.val() ? r.val($.datepicker.formatDate("M d, yy", new Date)) : r.val("") }), $("#rateChgCB").change(function () { this.checked ? ($(".hhk-extVisitSw").prop("checked", !1).change().prop("disabled", !0), $(".changeRateTd").show()) : ($(".changeRateTd").hide("fade"), $(".hhk-extVisitSw").prop("disabled", isCheckedOut)) }), $("#rateChgCB").change() } $("#tblActiveVisit").on("click", ".hhk-hospitalstay", function (e) { e.preventDefault(), viewHospitalStay($(this).data("idhs"), t, $("#hsDialog")) }), $("#spnExPay").hide(), isCheckedOut = !1; let c = 0, l = 0, u = 0; if ($("#spnCfBalDue").length > 0 && (c = parseFloat($("#spnCfBalDue").data("rmbal")), l = parseFloat($("#spnCfBalDue").data("vfee")), u = parseFloat($("#spnCfBalDue").data("totbal"))), $("input.hhk-ckoutCB").length > 0) $("#tblStays").on("change", "input.hhk-ckoutCB", function () { let o = !0, h = 1, r = new Date, p = {}; if (!1 === this.checked ? $(this).next().val("") : "" === $(this).next().val() && $(this).next().val($.datepicker.formatDate("M d, yy", new Date)), $("input.hhk-ckoutCB").each(function () { if (!1 === this.checked) o = !1; else if ("" != $(this).next().val()) { let e = new Date($(this).next().val()); p[$(this).next().data("gid")] = e.toDateString(), e.getTime() > r.getTime() ? ($(this).next().val(""), o = !1) : e.getTime() > h && (h = e.getTime()) } }), !0 === o) { isCheckedOut = !0; let g = r.getFullYear() + "-" + r.getMonth() + "-" + r.getDate(), k = new Date(h), f = k.getFullYear() + "-" + k.getMonth() + "-" + k.getDate(); if (k.getTime() > r.getTime()) return !1; if (g !== f && "ref" !== n) { d.children().remove(), d.dialog("option", "buttons", {}), d.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog"/>').append($('<div class="ui-autocomplete-loading" style="width:5em;">Loading</div>'))), viewVisit(e, t, i, a, "ref", s, p); return } $("#rateChgCB").prop("checked", !1).trigger("change").prop("disabled", !0), $(".hhk-extVisitSw").prop("checked", !1).trigger("change").prop("disabled", !0), $("#paymentAdjust").hide(), $(".hhk-kdrow").hide("fade"), $("#keyDepAmt").val(""); let v = parseFloat($("#DepRefundAmount").data("amt")); isNaN(v) && (v = 0), v > 0 ? ($("#DepRefundAmount").val(v.toFixed(2).toString()), $(".hhk-refundDeposit").show("fade")) : ($("#DepRefundAmount").val(""), $(".hhk-refundDeposit").hide("fade")), u < 0 ? ($("#guestCredit").val(c.toFixed(2).toString()), $("#feesCharges").val("")) : ($("#feesCharges").val(c.toFixed(2).toString()), $("#guestCredit").val(""), $("#visitFeeCb").length > 0 && Math.abs(u) >= l && $("#visitFeeCb").prop("checked", !0).prop("disabled", !0)), amtPaid() } else if ("ref" === n) { d.children().remove(), d.dialog("option", "buttons", {}), d.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog"/>').append($('<div class="ui-autocomplete-loading" style="width:5em;">Loading</div>'))), viewVisit(e, t, i, a, "", s); return } else isCheckedOut = !1, $("#feesCharges").val(""), $("#guestCredit").val(""), $("#feesPayment").val(""), $(".hhk-refundDeposit").hide("fade"), $("#DepRefundAmount").val(""), $("#visitFeeCb").prop("checked", !1).prop("disabled", !1), $("#rateChgCB").prop("checked", !1).prop("disabled", !1).change(), $(".hhk-extVisitSw").prop("checked", !1).prop("disabled", !1).change(), $("#paymentAdjust").show(), amtPaid() }), $("#tblStays").on("change", "input.hhk-ckoutDate", function () { "" != $(this).val() ? $(this).prev().prop("checked", !0) : $(this).prev().prop("checked", !1), $("input.hhk-ckoutCB").change() }), $("#cbCoAll").button().click(function () { $("input.hhk-ckoutCB").each(function () { $(this).prop("checked", !0) }), $("input.hhk-ckoutCB").change() }), $("input.hhk-ckoutCB").change(); else { isCheckedOut = !0, $(".hhk-kdrow").hide("fade"), $("#keyDepAmt").val(""); let p = parseFloat($("#kdPaid").data("amt")); isNaN(p) && (p = 0), p > 0 ? ($("#DepRefundAmount").val(p.toFixed(2).toString()), $(".hhk-refundDeposit").show("fade")) : ($("#DepRefundAmount").val(""), $(".hhk-refundDeposit").hide("fade")), c < 0 ? ($("#guestCredit").val(c.toFixed(2).toString()), $("#feesCharges").val("")) : ($("#feesCharges").val(c.toFixed(2).toString()), $("#guestCredit").val("")), d.css("background-color", "#F2F2F2") } setupPayments($("#selRateCategory").val(), t, s, $("#pmtRcpt"), "#keysfees"); let g = $("#btnFapp"); g.length > 0 && (g.button(), g.click(function () { getIncomeDiag(g.data("rid")) })), $("#btnAddGuest").length > 0 && ($("#btnAddGuest").button(), $("#btnAddGuest").click(function () { window.location.assign("CheckingIn.php?vid=" + $(this).data("vid") + "&span=" + $(this).data("span") + "&rid=" + $(this).data("rid") + "&vstatus=" + $(this).data("vstatus")) })), $("#selRateCategory").length > 0 && ($("#selRateCategory").change(function () { $(this).val() == fixedRate ? ($(".hhk-fxFixed").show("fade"), $(".hhk-fxAdj").hide("fade")) : ($(".hhk-fxFixed").hide("fade"), $(".hhk-fxAdj").show("fade")) }), $("#selRateCategory").change()), setupVisitNotes(t, d.find("#visitNoteViewer")), d.dialog("option", "buttons", i), d.dialog("option", "title", a), d.dialog("option", "width", .95 * $(window).width()), d.dialog("option", "height", $(window).height()), d.dialog("open") }) } function saveFees(e, t, i, a, n) { "use strict"; let s = [], o = [], h = !1, d = { cmd: "saveFees", idGuest: e, idVisit: t, span: i, rtntbl: !0 === a ? "1" : "0", pbp: n }; if ($("input.hhk-expckout").each(function () { let e = $(this).attr("id").split("_"); e.length > 0 && (d[e[0] + "[" + e[1] + "]"] = $(this).val()) }), $("input.hhk-stayckin").each(function () { let e = $(this).attr("id").split("_"); e.length > 0 && (d[e[0] + "[" + e[1] + "]"] = $(this).val()) }), $("#undoCkout").length > 0 && $("#undoCkout").prop("checked") && (h = !0), (!isCheckedOut || !1 !== verifyBalDisp() || !1 !== h) && !1 !== verifyAmtTendrd()) { if ($(".hhk-extVisitSw").length > 0 && $("#extendCb").prop("checked") && 1 > $("#extendDays").val()) { $("#extendDays").addClass("ui-state-error"), flagAlertMessage("Weekend Leave days must be filled in. ", "error"); return } if ($("input.hhk-ckoutCB").each(function () { if (this.checked) { let e = $(this).attr("id").split("_"); if (e.length > 0) { d["stayActionCb[" + e[1] + "]"] = "on"; var t = $("#stayCkOutDate_" + e[1]).datepicker("getDate"); if (t) { var i = new Date; t.setHours(i.getHours(), i.getMinutes(), 0, 0) } else t = new Date; $("#stayCkOutHour_" + e[1]).length > 0 && (d["stayCkOutHour[" + e[1] + "]"] = $("#stayCkOutHour_" + e[1]).val()), d["stayCkOutDate[" + e[1] + "]"] = t.toJSON(), s.push($(this).data("nm") + ", " + t.toDateString()) } } }), $("input.hhk-removeCB").each(function () { if (this.checked) { let e = $(this).attr("id").split("_"); e.length > 0 && (d[e[0] + "[" + e[1] + "]"] = "on", o.push($(this).data("nm"))) } }), s.length > 0 && !1 === confirm("Check Out:\n" + s.join("\n") + "?") || o.length > 0 && !1 === confirm("Remove:\n" + o.join("\n") + "?")) { $("#keysfees").dialog("close"); return } $("#keyDepAmt").removeClass("ui-state-highlight"), d.txtRibbonNote = $("#txtRibbonNote").val(), $("#taNewVNote").length > 0 && "" !== $("#taNewVNote").val() && (d.taNewVNote = $("#taNewVNote").val()), $("#noticeToCheckout").length > 0 && "" !== $("#noticeToCheckout").val() && (d.noticeToCheckout = $("#noticeToCheckout").val()), $(".hhk-feeskeys").each(function () { "checkbox" === $(this).attr("type") ? !1 !== this.checked && (d[$(this).attr("id")] = "on", d[$(this).attr("name")] = "on") : $(this).hasClass("ckdate") ? $(this).datepicker("getDate") ? d[$(this).attr("id")] = $(this).val() : d[$(this).attr("id")] = "" : "radio" === $(this).attr("type") ? !1 !== this.checked && (d[$(this).attr("id")] = $(this).val()) : (d[$(this).attr("id")] = $(this).val(), d[$(this).attr("name")] = $(this).val()) }), $("#keysfees").css("background-color", "white"), $("#keysfees").empty().append('<div id="hhk-loading-spinner" style="width: 100%; height: 100%; margin-top: 100px; text-align: center"><img src="../images/ui-anim_basic_16x16.gif"><p>Working...</p></div>'), $.post("ws_ckin.php", d, function (e) { try { e = $.parseJSON(e) } catch (t) { alert("Parser error - " + t.message); return } if (e.error) { e.gotopage && window.location.assign(e.gotopage), flagAlertMessage(e.error, "error"); return } if ($("#keysfees").dialog("close"), paymentRedirect(e, $("#xform")), "undefined" != typeof refreshdTables && refreshdTables(e), "undefined" != typeof pageManager) { var i = { date1: new Date($("#gstDate").val()), date2: new Date($("#gstCoDate").val()) }; pageManager.doOnDatesChange(i) } e.success && "" !== e.success && (flagAlertMessage(e.success, "success"), "undefined" != typeof calendar && calendar.refetchEvents()), e.warning && "" !== e.warning && flagAlertMessage(e.warning, "error"), e.receipt && "" !== e.receipt && showReceipt("#pmtRcpt", e.receipt, "Payment Receipt"), e.invoiceNumber && "" !== e.invoiceNumber && window.open("ShowInvoice.php?invnum=" + e.invoiceNumber) }) } } function updateVisitMessage(e, t) { $("#h3VisitMsgHdr").text(e), $("#spnVisitMsg").text(t), $("#visitMsg").effect("pulsate") }