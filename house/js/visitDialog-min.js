/**
 * visitDialog.js
 *
 * @author    Eric K. Crane <ecrane@nonprofitsoftwarecorp.org>
 * @copyright 2010-2017 <nonprofitsoftwarecorp.org>
 * @license   GPL and MIT
 * @link      https://github.com/NPSC/HHK
 */ /**
 * 
 * @param {int} vid
 * @param {$} $container
 * @returns {$}
 */ function setupVisitNotes(b,a){return a.notesViewer({linkId:b,linkType:"visit",newNoteAttrs:{id:"taNewVNote",name:"taNewVNote"},alertMessage:function(a,b){flagAlertMessage(a,b)}}),a}function viewHospitalStay(a,b,c){$.post("ws_resv.php",{cmd:"viewHS",idhs:a},function(d){if(!d){alert("Bad Reply from Server");return}try{d=$.parseJSON(d)}catch(e){alert("Bad JSON Encoding");return}if(d.error){d.gotopage&&window.open(d.gotopage,"_self"),flagAlertMessage(d.error,"error");return}d.success&&(c.empty(),c.append($(d.success)),c.dialog({autoOpen:!0,width:getDialogWidth(1e3),resizable:!0,modal:!0,title:d.title?d.title:"Hospital Details",buttons:{Cancel:function(){$(this).dialog("close")},Save:function(){saveHospitalStay(a,b),$(this).dialog("close")}}}),$("#keysfees").length>0&&$("#keysfees").on("dialogclose",function(a,b){c.dialog("isOpen")&&c.dialog("close")}),createAutoComplete($(".hhk-hsdialog #txtAgentSch"),3,{cmd:"filter",add:"phone",basis:"ra"},getAgent),""===$(".hhk-hsdialog #a_txtLastName").val()&&$(".hhk-hsdialog .hhk-agentInfo").hide(),$(document).on("click","#a_delete",function(){$(".hhk-hsdialog #a_idName").val(""),$(".hhk-hsdialog input.hhk-agentInfo").val(""),$(".hhk-hsdialog .hhk-agentInfo").hide()}),""!==$(".hhk-hsdialog #a_idName").val()?$(".hhk-hsdialog input.hhk-agentInfo.name").attr("readonly","readonly"):$(".hhk-hsdialog input.hhk-agentInfo.name").removeAttr("readonly"),createAutoComplete($(".hhk-hsdialog #txtDocSch"),3,{cmd:"filter",basis:"doc"},getDoc),""===$(".hhk-hsdialog #d_txtLastName").val()&&$(".hhk-hsdialog .hhk-docInfo").hide(),""!==$(".hhk-hsdialog #d_idName").val()?$(".hhk-hsdialog input.hhk-docInfo.name").attr("readonly","readonly"):$(".hhk-hsdialog input.hhk-docInfo.name").removeAttr("readonly"),$(document).on("click","#d_delete",function(){$(".hhk-hsdialog #d_idName").val(""),$(".hhk-hsdialog input.hhk-docInfo").val(""),$(".hhk-hsdialog .hhk-docInfo").hide()}),$(".ckhsdate").datepicker({yearRange:"-01:+01",changeMonth:!0,changeYear:!0,autoSize:!0,dateFormat:"M d, yy"}))})}function saveHospitalStay(b,c){var a=[{name:"cmd",value:"saveHS"},{name:"idhs",value:b},{name:"idv",value:c}],a=a.concat($(".hospital-stay").serializeArray());$.post("ws_resv.php",a,function(a){if(!a){alert("Bad Reply from Server");return}try{a=$.parseJSON(a)}catch(b){alert("Bad JSON Encoding");return}if(a.error){a.gotopage&&window.open(a.gotopage,"_self"),flagAlertMessage(a.error,"error");return}a.success&&flagAlertMessage(a.success,"success")})}var isCheckedOut=!1;function viewVisit(a,b,f,g,c,d,e){"use strict";$.post("ws_ckin.php",{cmd:"visitFees",idVisit:b,idGuest:a,action:c,span:d,ckoutdt:e},function(h){if(h){try{h=$.parseJSON(h)}catch(m){alert("Parser error - "+m.message);return}if(h.error){if(h.gotopage){window.location.assign(h.gotopage);return}flagAlertMessage(h.error,"error");return}var e=$("#keysfees");if(e.children().remove(),e.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog" style="font-size:0.8em;"/>').append($(h.success))),e.find(".ckdate").datepicker({yearRange:"-07:+01",changeMonth:!0,changeYear:!0,autoSize:!0,numberOfMonths:1,maxDate:0,dateFormat:"M d, yy"}),e.find(".ckdateFut").datepicker({yearRange:"-01:+01",changeMonth:!0,changeYear:!0,autoSize:!0,numberOfMonths:1,minDate:0,dateFormat:"M d, yy"}),e.css("background-color","#fff"),"ref"===c&&(e.css("background-color","#FEFF9B"),$(".hhk-ckoutDate").prop("disabled",!0)),$(".hhk-extVisitSw").length>0&&($("#extendDays").change(function(){$("#extendDays").removeClass("ui-state-error")}),$("#extendDate").change(function(){$("#rbOlpicker-ext").prop("checked",!0)}),$('input[name="rbOlpicker"]').change(function(){"ext"!==$(this).val()&&$("#extendDate").val("")}),$(".hhk-extVisitSw").change(function(){this.checked?($("#rateChgCB").prop("checked",!1).change().prop("disabled",!0),$(".hhk-extendVisit").show("fade")):($(".hhk-extendVisit").hide("fade"),$("#rateChgCB").prop("disabled",isCheckedOut))}),$(".hhk-extVisitSw").trigger("change")),$("#rateChgCB").length>0){let k=$("#chgRateDate");k.datepicker({changeMonth:!0,changeYear:!0,autoSize:!0,numberOfMonths:1,dateFormat:"M d, yy",maxDate:new Date(h.end),minDate:new Date(h.start)}),k.change(function(){""!==this.value&&k.siblings("input#rbReplaceRate").prop("checked",!0)}),$("input#rbReplaceRate").change(function(){this.checked&&""===k.val()?k.val($.datepicker.formatDate("M d, yy",new Date)):k.val("")}),$("#rateChgCB").change(function(){this.checked?($(".hhk-extVisitSw").prop("checked",!1).change().prop("disabled",!0),$(".changeRateTd").show()):($(".changeRateTd").hide("fade"),$(".hhk-extVisitSw").prop("disabled",isCheckedOut))}),$("#rateChgCB").change()}$("#tblActiveVisit").on("click",".hhk-hospitalstay",function(a){a.preventDefault(),viewHospitalStay($(this).data("idhs"),b,$("#hsDialog"))}),$("#spnExPay").hide(),isCheckedOut=!1;var i=0,n=0,o=0;if($("#spnCfBalDue").length>0&&(i=parseFloat($("#spnCfBalDue").data("rmbal")),n=parseFloat($("#spnCfBalDue").data("vfee")),o=parseFloat($("#spnCfBalDue").data("totbal"))),$("input.hhk-ckoutCB").length>0)$("#tblStays").on("change","input.hhk-ckoutCB",function(){var l=!0,m=1,h=new Date,p={};if(!1===this.checked?$(this).next().val(""):""===$(this).next().val()&&$(this).next().val($.datepicker.formatDate("M d, yy",new Date)),$("input.hhk-ckoutCB").each(function(){if(!1===this.checked)l=!1;else if(""!=$(this).next().val()){var a=new Date($(this).next().val());p[$(this).next().data("gid")]=a.toDateString(),a.getTime()>h.getTime()?($(this).next().val(""),l=!1):a.getTime()>m&&(m=a.getTime())}}),!0===l){isCheckedOut=!0;var h=new Date,q=h.getFullYear()+"-"+h.getMonth()+"-"+h.getDate(),j=new Date(m),r=j.getFullYear()+"-"+j.getMonth()+"-"+j.getDate();if(j.getTime()>h.getTime())return!1;if(q!==r&&"ref"!==c){e.children().remove(),e.dialog("option","buttons",{}),e.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog"/>').append($('<div class="ui-autocomplete-loading" style="width:5em;">Loading</div>'))),viewVisit(a,b,f,g,"ref",d,p);return}$("#rateChgCB").prop("checked",!1).trigger("change").prop("disabled",!0),$(".hhk-extVisitSw").prop("checked",!1).trigger("change").prop("disabled",!0),$("#paymentAdjust").prop("disabled",!0),$(".hhk-kdrow").hide("fade"),$(".hhk-finalPayment").show("fade");var k=parseFloat($("#kdPaid").data("amt"));isNaN(k)&&(k=0),k>0?($("#DepRefundAmount").val((0-k).toFixed(2).toString()),$(".hhk-refundDeposit").show("fade")):($("#DepRefundAmount").val(""),$(".hhk-refundDeposit").hide("fade")),$("#cbDepRefundApply").trigger("change"),o<0?($("#guestCredit").val(i.toFixed(2).toString()),$("#feesCharges").val(""),$(".hhk-RoomCharge").hide(),$(".hhk-GuestCredit").show()):($("#feesCharges").val(i.toFixed(2).toString()),$("#guestCredit").val(""),$(".hhk-GuestCredit").hide(),$(".hhk-RoomCharge").show(),$("#visitFeeCb").length>0&&Math.abs(o)>=n&&$("#visitFeeCb").prop("checked",!0).prop("disabled",!0).trigger("change")),$("input#cbFinalPayment").change()}else if("ref"===c){e.children().remove(),e.dialog("option","buttons",{}),e.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog"/>').append($('<div class="ui-autocomplete-loading" style="width:5em;">Loading</div>'))),viewVisit(a,b,f,g,"",d);return}else isCheckedOut=!1,$(".hhk-finalPayment").hide("fade"),$(".hhk-GuestCredit").hide("fade"),$(".hhk-RoomCharge").hide("fade"),$("#feesCharges").val(""),$("#guestCredit").val(""),$(".hhk-refundDeposit").hide("fade"),$("#DepRefundAmount").val(""),$("input#cbFinalPayment").prop("checked",!1),$("input#cbFinalPayment").change(),$("#cbDepRefundApply").trigger("change"),$("#visitFeeCb").prop("checked",!1).prop("disabled",!1).trigger("change"),$("#rateChgCB").prop("checked",!1).change().prop("disabled",!1),$(".hhk-extVisitSw").prop("checked",!1).change().prop("disabled",!1),$("#paymentAdjust").prop("disabled",!1)}),$("#tblStays").on("change","input.hhk-ckoutDate",function(){""!=$(this).val()?$(this).prev().prop("checked",!0):$(this).prev().prop("checked",!1),$("input.hhk-ckoutCB").change()}),$("#cbCoAll").button().click(function(){$("input.hhk-ckoutCB").each(function(){$(this).prop("checked",!0)}),$("input.hhk-ckoutCB").change()}),$("input.hhk-ckoutCB").change();else{isCheckedOut=!0,$(".hhk-finalPayment").show();var l=parseFloat($("#kdPaid").data("amt"));isNaN(l)?($("#DepRefundAmount").val(""),$(".hhk-refundDeposit").hide("fade")):($("#DepRefundAmount").val((0-l).toFixed(2).toString()),$(".hhk-refundDeposit").show("fade"),$("#cbDepRefundApply").trigger("change")),i<0?($("#guestCredit").val(i.toFixed(2).toString()),$("#feesCharges").val(""),$(".hhk-RoomCharge").hide(),$(".hhk-GuestCredit").show()):($("#feesCharges").val(i.toFixed(2).toString()),$("#guestCredit").val(""),$(".hhk-GuestCredit").hide(),$(".hhk-RoomCharge").show()),e.css("background-color","#F2F2F2")}setupPayments($("#selRateCategory"),b,d,$("#pmtRcpt"));let j=$("#btnFapp");j.length>0&&(j.button(),j.click(function(){getIncomeDiag(j.data("rid"))})),$("#btnAddGuest").length>0&&($("#btnAddGuest").button(),$("#btnAddGuest").click(function(){window.location.assign("CheckingIn.php?vid="+$(this).data("vid")+"&span="+$(this).data("span")+"&rid="+$(this).data("rid")+"&vstatus="+$(this).data("vstatus"))})),$("#selRateCategory").length>0&&($("#selRateCategory").change(function(){$(this).val()==fixedRate?($(".hhk-fxFixed").show("fade"),$(".hhk-fxAdj").hide("fade")):($(".hhk-fxFixed").hide("fade"),$(".hhk-fxAdj").show("fade"))}),$("#selRateCategory").change()),setupVisitNotes(b,e.find("#visitNoteViewer")),e.dialog("option","buttons",f),e.dialog("option","title",g),e.dialog("option","width",.92*$(window).width()),e.dialog("option","height",$(window).height()),e.dialog("open")}})}function saveFees(e,f,g,h,i){"use strict";let b=[],c=[],d=!1,a={cmd:"saveFees",idGuest:e,idVisit:f,span:g,rtntbl:!0===h?"1":"0",pbp:i};if($("input.hhk-expckout").each(function(){let b=$(this).attr("id").split("_");b.length>0&&(a[b[0]+"["+b[1]+"]"]=$(this).val())}),$("input.hhk-stayckin").each(function(){let b=$(this).attr("id").split("_");b.length>0&&(a[b[0]+"["+b[1]+"]"]=$(this).val())}),$("#undoCkout").length>0&&$("#undoCkout").prop("checked")&&(d=!0),(!isCheckedOut|| !1!==verifyBalDisp()|| !1!==d)&& !1!==verifyAmtTendrd()){if($(".hhk-extVisitSw").length>0&&$("#extendCb").prop("checked")&&1>$("#extendDays").val()){$("#extendDays").addClass("ui-state-error"),flagAlertMessage("Weekend Leave days must be filled in. ","error");return}if($("input.hhk-ckoutCB").each(function(){if(this.checked){let c=$(this).attr("id").split("_");if(c.length>0){a["stayActionCb["+c[1]+"]"]="on";var d=$("#stayCkOutDate_"+c[1]).datepicker("getDate");if(d){var e=new Date;d.setHours(e.getHours(),e.getMinutes(),0,0)}else d=new Date;$("#stayCkOutHour_"+c[1]).length>0&&(a["stayCkOutHour["+c[1]+"]"]=$("#stayCkOutHour_"+c[1]).val()),a["stayCkOutDate["+c[1]+"]"]=d.toJSON(),b.push($(this).data("nm")+", "+d.toDateString())}}}),$("input.hhk-removeCB").each(function(){if(this.checked){let b=$(this).attr("id").split("_");b.length>0&&(a[b[0]+"["+b[1]+"]"]="on",c.push($(this).data("nm")))}}),b.length>0&& !1===confirm("Check Out:\n"+b.join("\n")+"?")||c.length>0&& !1===confirm("Remove:\n"+c.join("\n")+"?")){$("#keysfees").dialog("close");return}$("#keyDepAmt").removeClass("ui-state-highlight"),a.txtRibbonNote=$("#txtRibbonNote").val(),$("#taNewVNote").length>0&&""!==$("#taNewVNote").val()&&(a.taNewVNote=$("#taNewVNote").val()),$("#noticeToCheckout").length>0&&""!==$("#noticeToCheckout").val()&&(a.noticeToCheckout=$("#noticeToCheckout").val()),$(".hhk-feeskeys").each(function(){if("checkbox"===$(this).attr("type"))!1!==this.checked&&(a[$(this).attr("id")]="on");else if($(this).hasClass("ckdate")){var b=$(this).datepicker("getDate");b?a[$(this).attr("id")]=b.toJSON():a[$(this).attr("id")]=""}else"radio"===$(this).attr("type")?!1!==this.checked&&(a[$(this).attr("id")]=$(this).val()):a[$(this).attr("id")]=$(this).val()}),$("#keysfees").css("background-color","white"),$("#keysfees").empty().append('<div id="hhk-loading-spinner" style="width: 100%; height: 100%; margin-top: 100px; text-align: center"><img src="../images/ui-anim_basic_16x16.gif"><p>Working...</p></div>'),$.post("ws_ckin.php",a,function(a){try{a=$.parseJSON(a)}catch(b){alert("Parser error - "+b.message);return}if(a.error){a.gotopage&&window.location.assign(a.gotopage),flagAlertMessage(a.error,"error");return}if($("#keysfees").dialog("close"),paymentRedirect(a,$("#xform")),"undefined"!=typeof refreshdTables&&refreshdTables(a),"undefined"!=typeof pageManager){var c={date1:new Date($("#gstDate").val()),date2:new Date($("#gstCoDate").val())};pageManager.doOnDatesChange(c)}a.success&&""!==a.success&&(flagAlertMessage(a.success,"success"),"undefined"!=typeof calendar&&calendar.refetchEvents()),a.warning&&""!==a.warning&&flagAlertMessage(a.warning,"error"),a.receipt&&""!==a.receipt&&showReceipt("#pmtRcpt",a.receipt,"Payment Receipt"),a.invoiceNumber&&""!==a.invoiceNumber&&window.open("ShowInvoice.php?invnum="+a.invoiceNumber)})}}function updateVisitMessage(a,b){$("#h3VisitMsgHdr").text(a),$("#spnVisitMsg").text(b),$("#visitMsg").effect("pulsate")}