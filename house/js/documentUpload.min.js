!function(e){e.fn.docUploader=function(t){var a=e.extend(!0,{},{guestId:0,psgId:0,rid:0,serviceURL:"ws_resc.php",newLabel:"New Document",visitorLabel:"Guest",tableAttrs:{class:"display compact",width:"100%"},alertMessage:function(e,t){}},t);a.dtCols=[{targets:[0],title:"Actions",data:"Action",sortable:!1,searchable:!1,width:"50px",render:function(t,a,d){var i,o,n,c;return i=t,o=d,n=e("<ul />").addClass("ui-widget ui-helper-clearfix hhk-ui-icons hhk-flex"),(c=e('<li title="Edit Doc" />').addClass("hhk-doc-button doc-edit ui-corner-all ui-state-default")).append(e('<span class="ui-icon ui-icon-pencil" />')),n.append(c),(c=e('<li title="Save Doc" />').addClass("hhk-doc-button doc-done doc-action ui-corner-all ui-state-default").hide()).append(e('<span class="ui-icon ui-icon-check" />')),n.append(c),(c=e('<li title="Cancel" />').addClass("hhk-doc-button doc-cancel doc-action ui-corner-all ui-state-default").hide()).append(e('<span class="ui-icon ui-icon-cancel" />')),n.append(c),(c=e('<li title="Delete Doc" data-docid="'+i+'" />').addClass("hhk-doc-button doc-delete ui-corner-all ui-state-default")).append(e('<span class="ui-icon ui-icon-trash" />')),n.append(c),(c=e('<li title="Undo Delete" data-docid="'+i+'" />').addClass("hhk-doc-button doc-undodelete ui-corner-all ui-state-default").hide()).append(e('<span class="ui-icon ui-icon-arrowreturnthick-1-w" />')),n.append(c),e("<div />").append(n).html()}},{targets:[1],title:"Date",data:"Date",width:"70px",render:function(e,t){return dateRender(e,t,dateFormat)}},{targets:[2],title:a.visitorLabel,searchable:!0,sortable:!0,className:"docGuest",data:"Guest",width:"150px"},{targets:[3],title:"Title",searchable:!0,sortable:!1,className:"docTitle",data:"Title"},{targets:[4],title:"User",sortable:!1,searchable:!1,visible:!0,data:"User",width:"100px"},{targets:[5],title:"View Doc",data:"View Doc",sortable:!1,searchable:!1,width:"50px",render:function(t,a,d){var i,o,n;return i=t,o=d,(n=e('<a data-docid="'+i+'" href="ws_resc.php?cmd=getdoc&docId='+i+'" target="_blank" />').addClass("hhk-doc-button doc-download ui-corner-all ui-state-default")).append('Open<span class="ui-icon ui-icon-extlink" style="margin-left: 0.5em;"></span>').button(),e("<div />").append(n).html()}},];var d=e(this);return d.uploader='<div id="docUploadBtn" class="ui-button ui-corner-all ui-widget"><span class="ui-icon ui-icon-plusthick" style="margin-right: 0.5em"></span>New Document</div>',function e(t,a){t.off("click","*")}(d,a),function t(a,d){if(d.guestId>0||d.psgId>0||d.rid>0){a.append(a.uploader);var i,o,n,c=e("<table />").attr(d.tableAttrs).appendTo(a).DataTable({columnDefs:d.dtCols,serverSide:!0,processing:!0,deferRender:!0,language:{sSearch:"Search Docs:"},sorting:[[1,"desc"]],paging:!1,lengthMenu:[[5,10,25,-1],[5,10,25,"All"]],dom:'<"dtTop"if>rt<"dtBottom"lp><"clear">',ajax:{url:d.serviceURL,data:{cmd:"getDocumentList",psgId:d.psgId}},drawCallback:function(e){a.find(".hhk-doc-button").button()}});i=a,o=d,n=c,i.on("click",".doc-edit",function(t){t.preventDefault();var a=e(this).closest("tr");let d=n.row(a).data();a.find(".docTitle").html('<input type="text" size="'+d.Title.length+'" id="editDocTitle" value="'+d.Title+'" class="p-1">'),a.find(".docGuest").html('<input type="text" size="'+d.Guest.length+'" id="editDocGuest" value="'+d.Guest+'" data-idguest="" class="p-1" readonly>');let i=function(e){a.find("#editDocGuest").attr("data-idguest",e.id).blur()},c={cmd:"filter",psg:o.psgId,basis:"psg"};createAutoComplete(a.find("#editDocGuest"),0,c,i,!1,null,null,!0),a.on("focus","#editDocGuest",function(){e(this).autocomplete("search","")}),e(this).closest("td").find(".doc-action").show(),e(this).closest("td").find(".doc-delete").hide(),e(this).hide()}),i.on("click",".doc-done",function(t){t.preventDefault();var a=e(this).closest("tr"),d=n.row(a).data(),i=a.find("#editDocTitle").val(),c=a.find("#editDocGuest").data("idguest"),l=d.DocId;(""!=i||""!=c)&&e.ajax({url:o.serviceURL,dataType:"JSON",type:"post",data:{cmd:"updatedoc",docId:l,docTitle:i,docGuestId:c},success:function(e){e.idDoc>0?n.ajax.reload(null,!1):e.error?o.alertMessage(e.error,"error"):o.alertMessage("An unknown error occurred.","alert")}})}),i.on("click",".doc-cancel",function(e){e.preventDefault(),n.ajax.reload(null,!1)}),i.on("click",".doc-delete",function(t){var a=e(this).data("docid"),d=e(this).closest("tr");t.preventDefault(),e.ajax({url:o.serviceURL,dataType:"JSON",type:"post",data:{cmd:"deletedoc",docId:a},success:function(t){if(t.idDoc>0){d.find("td:not(:first)").css("opacity","0.3");var a=d.find("#editDocTitle").val();d.find(".docTitle").html(a),d.find(".doc-action").hide(),d.find(".doc-delete").hide(),d.find(".doc-edit").hide(),d.find(".doc-undodelete").show(),e("#docTitle").val(""),e("#hhk-newNote").removeAttr("disabled").text(o.newLabel)}else o.alertMessage(t.error,"error")}})}),i.on("click",".doc-undodelete",function(t){var a=e(this).data("docid"),d=e(this).parents("tr");t.preventDefault(),e.ajax({url:o.serviceURL,dataType:"JSON",type:"post",data:{cmd:"undodeletedoc",docId:a},success:function(t){if(t.idDoc>0){var a=n.row(d).data();n.row(d).data(a),d.find("td").css("opacity","1"),e("#docTitle").val(""),e("#hhk-newNote").removeAttr("disabled").text(o.newLabel)}else o.alertMessage(t.error,"error")}})}),e(".dataTables_filter").addClass("ignrSave"),e(".dtBottom").addClass("ignrSave");var l="",s=window.uploader;a.on("click","#docUploadBtn",function(){e(s.container).removeClass().addClass("uppload-container"),s.updatePlugins(e=>[]),s.updateSettings({maxSize:[1500,1500],customClass:"docUploadContainer",uploader:function t(i){return(""==l||void 0==l)&&(l=i.name.substr(0,i.name.lastIndexOf("."))||i.name),new Promise(function(t,o){var n=new FormData;n.append("cmd","putdoc"),n.append("guestId",d.guestId),n.append("psgId",d.psgId),n.append("docTitle",l),n.append("mimetype",i.type),n.append("file",i),e.ajax({url:d.serviceURL,dataType:"JSON",type:"post",data:n,contentType:!1,processData:!1,success:function(d){d.idDoc>0?(c.ajax.reload(),function t(a){e(a.uploader).find("input").val("")}(a),t("success")):d.error?(o(d.error),flagAlertMessage("Error: "+d.error,!0)):(o("An unknown error occurred."),flagAlertMessage("Error: "+d.error,!0))}})})}}),e(document).on("change","input#docTitle",function(){l=e("input#docTitle").val()}),docuploadlocal=new Upploader.Local({maxFileSize:5e6,mimeTypes:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","image/jpeg","image/png"]}),s.use([docuploadlocal,new Upploader.Crop({hideAspectRatioSettings:!0})]),s.open()}),s.on("open",function(){e(s.container).hasClass("docUploadContainer")&&(l="",0==e(s.container).find("#docFields").length&&e(s.container).find(".uppload-service--local").prepend("<div class='hhk-flex' id='docFields'><input type='text' placeholder='Enter Document Title' class='input' id='docTitle'></div>"),0==e(s.container).find("#docUploadHelp").length&&e(s.container).find(".drop-area").append('<p id="docUploadHelp">Allowed filetypes: pdf, doc, docx, jpeg, png<br>Maximum File Size: 5MB</p>'),1==s.effects.length?e(s.container).find(".effects-tabs").hide():e(s.container).find(".effects-tabs").show())})}}(d,a),this}}(jQuery);