!function(e){e.fn.docUploader=function(t){var d={guestId:0,psgId:0,rid:0,serviceURL:"ws_resc.php",newLabel:"New Document",tableAttrs:{class:"display compact",width:"100%"},alertMessage:function(e,t){},dtCols:[{targets:[0],title:"Actions",data:"Action",sortable:!1,searchable:!1,render:function(t,d,o){return function(t,d){var o,a;return o=e("<ul />").addClass("ui-widget ui-helper-clearfix hhk-ui-icons"),(a=e('<li title="Edit Doc" data-docid="'+t+'" data-docTitle="'+d.Title+'" />').addClass("hhk-doc-button doc-edit ui-corner-all ui-state-default")).append(e('<span class="ui-icon ui-icon-pencil" />')),o.append(a),(a=e('<li title="Save Doc" />').addClass("hhk-doc-button doc-done doc-action ui-corner-all ui-state-default").hide()).append(e('<span class="ui-icon ui-icon-check" />')),o.append(a),(a=e('<li title="Cancel" data-titletext="'+d.Title+'" />').addClass("hhk-doc-button doc-cancel doc-action ui-corner-all ui-state-default").hide()).append(e('<span class="ui-icon ui-icon-cancel" />')),o.append(a),(a=e('<li title="Delete Doc" data-docid="'+t+'" />').addClass("hhk-doc-button doc-delete ui-corner-all ui-state-default")).append(e('<span class="ui-icon ui-icon-trash" />')),o.append(a),(a=e('<li title="Undo Delete" data-docid="'+t+'" />').addClass("hhk-doc-button doc-undodelete ui-corner-all ui-state-default").hide()).append(e('<span class="ui-icon ui-icon-arrowreturnthick-1-w" />')),o.append(a),e("<div />").append(o).html()}(t,o)}},{targets:[1],title:"Date",data:"Date",render:function(e,t){return dateRender(e,t,dateFormat)}},{targets:[2],title:"Guest",searchable:!0,sortable:!0,data:"Guest"},{targets:[3],title:"Title",searchable:!0,sortable:!1,className:"docTitle",data:"Title"},{targets:[4],title:"User",sortable:!1,searchable:!1,visible:!0,data:"User"},{targets:[5],title:"View Doc",data:"View Doc",sortable:!1,searchable:!1,render:function(t,d,o){return(i=e('<a data-docid="'+(a=t)+'" href="ws_resc.php?cmd=getdoc&docId='+a+'" target="_blank" />').addClass("hhk-doc-button doc-download ui-corner-all ui-state-default")).append('Open<span class="ui-icon ui-icon-extlink" style="margin-left: 0.5em;"></span>').button(),e("<div />").append(i).html();var a,i}}]},o=e.extend(!0,{},d,t),a=e(this);return a.uploader='<div id="docUploadBtn" class="ui-button ui-corner-all ui-widget"><span class="ui-icon ui-icon-plusthick" style="margin-right: 0.5em"></span>New Document</div>',function(t,d){if(d.guestId>0||d.psgId>0||d.rid>0){t.append(t.uploader);var o=e("<table />").attr(d.tableAttrs).appendTo(t),a=o.DataTable({columnDefs:d.dtCols,serverSide:!0,processing:!0,deferRender:!0,language:{sSearch:"Search Docs:"},sorting:[[1,"desc"]],paging:!1,lengthMenu:[[5,10,25,-1],[5,10,25,"All"]],dom:'<"dtTop"if>rt<"dtBottom"lp><"clear">',ajax:{url:d.serviceURL,data:{cmd:"getDocumentList",psgId:d.psgId}}});!function(t,d,o){t.on("click",".doc-edit",function(t){t.preventDefault(),e(this).closest("tr").find(".docTitle").html('<input type="text" style="width: 100%; height: '+e(this).closest("tr").find(".docTitle").height()+'px;" id="editDocTitle" value="'+e(this).data("doctitle")+'">'),e(this).closest("td").find(".doc-action").show(),e(this).closest("td").find(".doc-delete").hide(),e(this).hide()}),t.on("click",".doc-done",function(t){t.preventDefault();var a=e(this).closest("tr").find("#editDocTitle").val(),i=e(this).closest("td").find(".doc-edit").data("docid");""!=a&&e.ajax({url:d.serviceURL,dataType:"JSON",type:"post",data:{cmd:"updatedoctitle",docId:i,docTitle:a},success:function(e){e.idDoc>0?o.ajax.reload():e.error?d.alertMessage(e.error,"error"):d.alertMessage("An unknown error occurred.","alert")}}),e(this).closest("td").find(".doc-action").hide(),e(this).closest("td").find(".doc-edit").show(),e(this).closest("td").find(".doc-delete").show()}),t.on("click",".doc-cancel",function(t){t.preventDefault();var d=e(this).closest("tr").find("#editDocTitle").val();e(this).closest("tr").find(".docTitle").html(d),e(this).closest("td").find(".doc-action").hide(),e(this).closest("td").find(".doc-edit").show(),e(this).closest("td").find(".doc-delete").show()}),t.on("click",".doc-delete",function(t){var o=e(this).data("docid"),a=e(this).closest("tr");t.preventDefault(),e.ajax({url:d.serviceURL,dataType:"JSON",type:"post",data:{cmd:"deletedoc",docId:o},success:function(t){if(t.idDoc>0){a.find("td:not(:first)").css("opacity","0.3");var o=a.find("#editDocTitle").val();a.find(".docTitle").html(o),a.find(".doc-action").hide(),a.find(".doc-delete").hide(),a.find(".doc-edit").hide(),a.find(".doc-undodelete").show(),e("#docTitle").val(""),e("#hhk-newNote").removeAttr("disabled").text(d.newLabel)}else d.alertMessage(t.error,"error")}})}),t.on("click",".doc-undodelete",function(t){var a=e(this).data("docid");t.preventDefault(),e.ajax({url:d.serviceURL,dataType:"JSON",type:"post",data:{cmd:"undodeletedoc",docId:a},success:function(t){t.idDoc>0?(o.ajax.reload(),e("#docTitle").val(""),e("#hhk-newNote").removeAttr("disabled").text(d.newLabel)):d.alertMessage(t.error,"error")}})})}(t,d,a),e(".dataTables_filter").addClass("ignrSave"),e(".dtBottom").addClass("ignrSave"),newDocUppload=new Uppload({call:["#docUploadBtn"],maxFileSize:5e6,uploadFunction:function(i){var n=e(newDocUppload.modalElement).find("input#newDocTitle").val();return new Promise(function(l,c){var s=new FormData;s.append("cmd","putdoc"),s.append("guestId",d.guestId),s.append("psgId",d.psgId),s.append("docTitle",n),s.append("mimetype",i.type),s.append("file",i),e.ajax({url:d.serviceURL,dataType:"JSON",type:"post",data:s,contentType:!1,processData:!1,success:function(d){console.log(d),d.idDoc>0?(a.ajax.reload(),console.log(o),function(t){e(t.uploader).find("input").val("")}(t),l("success")):d.error?c(d.error):c("An unknown error occurred.")}})})},services:["upload"],defaultService:"upload",allowedTypes:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","image/jpg","image/png"]}),newDocUppload.on("pageChanged",function(t){"upload"==t?(e("#newDocTitle").prop("type","text"),e("#fileTypeText").show()):(e("#newDocTitle").prop("type","hidden"),e("#fileTypeText").hide())}),newDocUppload.on("fileSelected",function(t){console.log("Title: "+e("#newDocTitle").val()),console.log("Filename: "+t.name),""==e("#newDocTitle").val()&&e("#newDocTitle").val(t.name.replace(/\.[^\/.]+$/,""))}),e(newDocUppload.modalElement).find("section").append('<div style="display: block; position: absolute; top: 1.5em; width: 100%"><input type="text" name="docTitle" id="newDocTitle" placeholder="Enter Document Title" style="margin: 0 auto"></div>'),e(newDocUppload.modalElement).find("section").append('<div style="display: block; position: absolute; bottom: 1.5em; width: 100%; text-align: center;" id="fileTypeText">Allowed filetypes: pdf, doc, docx, image<br>Maximum File Size: 5MB</div>'),t.on("click","#docUploadBtn",function(e){e.preventDefault()}),newDocUppload.on("modalOpened",function(){e(newDocUppload.modalElement).find("input#newDocTitle").val("")})}}(a,o),this}}(jQuery);