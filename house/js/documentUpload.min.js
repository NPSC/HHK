!function(l){l.fn.docUploader=function(e){var t={guestId:0,psgId:0,rid:0,serviceURL:"ws_resc.php",newLabel:"New Document",tableAttrs:{class:"display compact",width:"100%"},alertMessage:function(e,t){},dtCols:[{targets:[0],title:"Actions",data:"Action",sortable:!1,searchable:!1,render:function(e,t,a){return d=e,o=a,i=l("<ul />").addClass("ui-widget ui-helper-clearfix hhk-ui-icons"),(c=l('<li title="Edit Doc" data-docid="'+d+'" data-docTitle="'+o.Title+'" />').addClass("hhk-doc-button doc-edit ui-corner-all ui-state-default")).append(l('<span class="ui-icon ui-icon-pencil" />')),i.append(c),(c=l('<li title="Save Doc" />').addClass("hhk-doc-button doc-done doc-action ui-corner-all ui-state-default").hide()).append(l('<span class="ui-icon ui-icon-check" />')),i.append(c),(c=l('<li title="Cancel" data-titletext="'+o.Title+'" />').addClass("hhk-doc-button doc-cancel doc-action ui-corner-all ui-state-default").hide()).append(l('<span class="ui-icon ui-icon-cancel" />')),i.append(c),(c=l('<li title="Delete Doc" data-docid="'+d+'" />').addClass("hhk-doc-button doc-delete ui-corner-all ui-state-default")).append(l('<span class="ui-icon ui-icon-trash" />')),i.append(c),(c=l('<li title="Undo Delete" data-docid="'+d+'" />').addClass("hhk-doc-button doc-undodelete ui-corner-all ui-state-default").hide()).append(l('<span class="ui-icon ui-icon-arrowreturnthick-1-w" />')),i.append(c),l("<div />").append(i).html();var d,o,i,c}},{targets:[1],title:"Date",data:"Date",render:function(e,t){return dateRender(e,t,dateFormat)}},{targets:[2],title:"Guest",searchable:!0,sortable:!0,data:"Guest"},{targets:[3],title:"Title",searchable:!0,sortable:!1,className:"docTitle",data:"Title"},{targets:[4],title:"User",sortable:!1,searchable:!1,visible:!0,data:"User"},{targets:[5],title:"View Doc",data:"View Doc",sortable:!1,searchable:!1,render:function(e,t,a){return(o=l('<a data-docid="'+(d=e)+'" href="ws_resc.php?cmd=getdoc&docId='+d+'" target="_blank" />').addClass("hhk-doc-button doc-download ui-corner-all ui-state-default")).append('Open<span class="ui-icon ui-icon-extlink" style="margin-left: 0.5em;"></span>').button(),l("<div />").append(o).html();var d,o}}]},a=l.extend(!0,{},t,e),d=l(this);return d.uploader='<div id="docUploadBtn" class="ui-button ui-corner-all ui-widget"><span class="ui-icon ui-icon-plusthick" style="margin-right: 0.5em"></span>New Document</div>',function(o,i){{var c,n;(0<i.guestId||0<i.psgId||0<i.rid)&&(o.append(o.uploader),c=l("<table />").attr(i.tableAttrs).appendTo(o).DataTable({columnDefs:i.dtCols,serverSide:!0,processing:!0,deferRender:!0,language:{sSearch:"Search Docs:"},sorting:[[1,"desc"]],paging:!1,lengthMenu:[[5,10,25,-1],[5,10,25,"All"]],dom:'<"dtTop"if>rt<"dtBottom"lp><"clear">',ajax:{url:i.serviceURL,data:{cmd:"getDocumentList",psgId:i.psgId}},drawCallback:function(e){o.find(".hhk-doc-button").button()}}),function(e,o,i){e.on("click",".doc-edit",function(e){e.preventDefault(),l(this).closest("tr").find(".docTitle").html('<input type="text" style="width: 100%; height: '+l(this).closest("tr").find(".docTitle").height()+'px;" id="editDocTitle" value="'+l(this).data("doctitle")+'">'),l(this).closest("td").find(".doc-action").show(),l(this).closest("td").find(".doc-delete").hide(),l(this).hide()}),e.on("click",".doc-done",function(e){e.preventDefault();var a=l(this).closest("tr"),d=a.find("#editDocTitle").val(),t=l(this).closest("td").find(".doc-edit").data("docid");""!=d&&l.ajax({url:o.serviceURL,dataType:"JSON",type:"post",data:{cmd:"updatedoctitle",docId:t,docTitle:d},success:function(e){var t;0<e.idDoc?((t=i.row(a).data()).Title=d,i.row(a).data(t)):e.error?o.alertMessage(e.error,"error"):o.alertMessage("An unknown error occurred.","alert")}})}),e.on("click",".doc-cancel",function(e){e.preventDefault();var t=l(this).closest("tr").find("#editDocTitle").val();l(this).closest("tr").find(".docTitle").html(t),l(this).closest("td").find(".doc-action").hide(),l(this).closest("td").find(".doc-edit").show(),l(this).closest("td").find(".doc-delete").show()}),e.on("click",".doc-delete",function(e){var t=l(this).data("docid"),a=l(this).closest("tr");e.preventDefault(),l.ajax({url:o.serviceURL,dataType:"JSON",type:"post",data:{cmd:"deletedoc",docId:t},success:function(e){var t;0<e.idDoc?(a.find("td:not(:first)").css("opacity","0.3"),t=a.find("#editDocTitle").val(),a.find(".docTitle").html(t),a.find(".doc-action").hide(),a.find(".doc-delete").hide(),a.find(".doc-edit").hide(),a.find(".doc-undodelete").show(),l("#docTitle").val(""),l("#hhk-newNote").removeAttr("disabled").text(o.newLabel)):o.alertMessage(e.error,"error")}})}),e.on("click",".doc-undodelete",function(e){var t=l(this).data("docid"),a=l(this).parents("tr");e.preventDefault(),l.ajax({url:o.serviceURL,dataType:"JSON",type:"post",data:{cmd:"undodeletedoc",docId:t},success:function(e){var t;0<e.idDoc?(t=i.row(a).data(),i.row(a).data(t),a.find("td").css("opacity","1"),l("#docTitle").val(""),l("#hhk-newNote").removeAttr("disabled").text(o.newLabel)):o.alertMessage(e.error,"error")}})})}(o,i,c),l(".dataTables_filter").addClass("ignrSave"),l(".dtBottom").addClass("ignrSave"),n="",DocUppload=new Upploader.Uppload({maxSize:[1500,1500],call:["#docUploadBtn"],lang:Upploader.en,uploader:function(d){return""!=n&&null!=n||(n=d.name.substr(0,d.name.lastIndexOf("."))||d.name),new Promise(function(t,a){var e=new FormData;e.append("cmd","putdoc"),e.append("guestId",i.guestId),e.append("psgId",i.psgId),e.append("docTitle",n),e.append("mimetype",d.type),e.append("file",d),l.ajax({url:i.serviceURL,dataType:"JSON",type:"post",data:e,contentType:!1,processData:!1,success:function(e){0<e.idDoc?(c.ajax.reload(),l(o.uploader).find("input").val(""),t("success")):(e.error?a(e.error):a("An unknown error occurred."),new Noty({type:"error",text:"Error: "+e.error}).show())}})})}}),DocUppload.on("open",function(){n="",l(DocUppload.container).find(".uppload-service--local").prepend("<input type='text' placeholder='Enter Document Title' class='input' id='docTitle'>"),l(DocUppload.container).find(".drop-area").append("<p>Allowed filetypes: pdf, doc, docx, jpeg, png<br>Maximum File Size: 5MB</p>"),1==DocUppload.effects.length?l(DocUppload.container).find(".effects-tabs").hide():l(DocUppload.container).find(".effects-tabs").show()}),l(document).on("change","input#docTitle",function(){n=l("input#docTitle").val()}),local=new Upploader.Local({maxFileSize:5e6,mimeTypes:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","image/jpeg","image/png"]}),DocUppload.use([local,new Upploader.Crop({hideAspectRatioSettings:!0})]))}}(d,a),this}}(jQuery);