!function(e){e.fn.docUploader=function(t){var a={guestId:0,psgId:0,rid:0,serviceURL:"ws_resc.php",newLabel:"New Document",tableAttrs:{class:"display compact",width:"100%"},alertMessage:function(e,t){},dtCols:[{targets:[0],title:"Actions",data:"Action",sortable:!1,searchable:!1,render:function(t,a,d){return function(t,a){var d,i;return d=e("<ul />").addClass("ui-widget ui-helper-clearfix hhk-ui-icons"),(i=e('<li title="Edit Doc" data-docid="'+t+'" data-docTitle="'+a.Title+'" />').addClass("hhk-doc-button doc-edit ui-corner-all ui-state-default")).append(e('<span class="ui-icon ui-icon-pencil" />')),d.append(i),(i=e('<li title="Save Doc" />').addClass("hhk-doc-button doc-done doc-action ui-corner-all ui-state-default").hide()).append(e('<span class="ui-icon ui-icon-check" />')),d.append(i),(i=e('<li title="Cancel" data-titletext="'+a.Title+'" />').addClass("hhk-doc-button doc-cancel doc-action ui-corner-all ui-state-default").hide()).append(e('<span class="ui-icon ui-icon-cancel" />')),d.append(i),(i=e('<li title="Delete Doc" data-docid="'+t+'" />').addClass("hhk-doc-button doc-delete ui-corner-all ui-state-default")).append(e('<span class="ui-icon ui-icon-trash" />')),d.append(i),(i=e('<li title="Undo Delete" data-docid="'+t+'" />').addClass("hhk-doc-button doc-undodelete ui-corner-all ui-state-default").hide()).append(e('<span class="ui-icon ui-icon-arrowreturnthick-1-w" />')),d.append(i),e("<div />").append(d).html()}(t,d)}},{targets:[1],title:"Date",data:"Date",render:function(e,t){return dateRender(e,t,dateFormat)}},{targets:[2],title:"Guest",searchable:!0,sortable:!0,data:"Guest"},{targets:[3],title:"Title",searchable:!0,sortable:!1,className:"docTitle",data:"Title"},{targets:[4],title:"User",sortable:!1,searchable:!1,visible:!0,data:"User"},{targets:[5],title:"View Doc",data:"View Doc",sortable:!1,searchable:!1,render:function(t,a,d){return(o=e('<a data-docid="'+(i=t)+'" href="ws_resc.php?cmd=getdoc&docId='+i+'" target="_blank" />').addClass("hhk-doc-button doc-download ui-corner-all ui-state-default")).append('Open<span class="ui-icon ui-icon-extlink" style="margin-left: 0.5em;"></span>').button(),e("<div />").append(o).html();var i,o}}]},d=e.extend(!0,{},a,t),i=e(this);return i.uploader='<div id="docUploadBtn" class="ui-button ui-corner-all ui-widget"><span class="ui-icon ui-icon-plusthick" style="margin-right: 0.5em"></span>New Document</div>',function(t,a){if(a.guestId>0||a.psgId>0||a.rid>0){t.append(t.uploader);var d=e("<table />").attr(a.tableAttrs).appendTo(t),i=d.DataTable({columnDefs:a.dtCols,serverSide:!0,processing:!0,deferRender:!0,language:{sSearch:"Search Docs:"},sorting:[[1,"desc"]],paging:!1,lengthMenu:[[5,10,25,-1],[5,10,25,"All"]],dom:'<"dtTop"if>rt<"dtBottom"lp><"clear">',ajax:{url:a.serviceURL,data:{cmd:"getDocumentList",psgId:a.psgId}},drawCallback:function(e){t.find(".hhk-doc-button").button()}});!function(t,a,d){t.on("click",".doc-edit",function(t){t.preventDefault(),e(this).closest("tr").find(".docTitle").html('<input type="text" style="width: 100%; height: '+e(this).closest("tr").find(".docTitle").height()+'px;" id="editDocTitle" value="'+e(this).data("doctitle")+'">'),e(this).closest("td").find(".doc-action").show(),e(this).closest("td").find(".doc-delete").hide(),e(this).hide()}),t.on("click",".doc-done",function(t){t.preventDefault();var i=e(this).closest("tr"),o=i.find("#editDocTitle").val(),n=e(this).closest("td").find(".doc-edit").data("docid");""!=o&&e.ajax({url:a.serviceURL,dataType:"JSON",type:"post",data:{cmd:"updatedoctitle",docId:n,docTitle:o},success:function(e){if(e.idDoc>0){var t=d.row(i).data();t.Title=o,d.row(i).data(t)}else e.error?a.alertMessage(e.error,"error"):a.alertMessage("An unknown error occurred.","alert")}})}),t.on("click",".doc-cancel",function(t){t.preventDefault();var a=e(this).closest("tr").find("#editDocTitle").val();e(this).closest("tr").find(".docTitle").html(a),e(this).closest("td").find(".doc-action").hide(),e(this).closest("td").find(".doc-edit").show(),e(this).closest("td").find(".doc-delete").show()}),t.on("click",".doc-delete",function(t){var d=e(this).data("docid"),i=e(this).closest("tr");t.preventDefault(),e.ajax({url:a.serviceURL,dataType:"JSON",type:"post",data:{cmd:"deletedoc",docId:d},success:function(t){if(t.idDoc>0){i.find("td:not(:first)").css("opacity","0.3");var d=i.find("#editDocTitle").val();i.find(".docTitle").html(d),i.find(".doc-action").hide(),i.find(".doc-delete").hide(),i.find(".doc-edit").hide(),i.find(".doc-undodelete").show(),e("#docTitle").val(""),e("#hhk-newNote").removeAttr("disabled").text(a.newLabel)}else a.alertMessage(t.error,"error")}})}),t.on("click",".doc-undodelete",function(t){var i=e(this).data("docid"),o=e(this).parents("tr");t.preventDefault(),e.ajax({url:a.serviceURL,dataType:"JSON",type:"post",data:{cmd:"undodeletedoc",docId:i},success:function(t){if(t.idDoc>0){var i=d.row(o).data();d.row(o).data(i),o.find("td").css("opacity","1"),e("#docTitle").val(""),e("#hhk-newNote").removeAttr("disabled").text(a.newLabel)}else a.alertMessage(t.error,"error")}})})}(t,a,i),e(".dataTables_filter").addClass("ignrSave"),e(".dtBottom").addClass("ignrSave");var o="";DocUppload=new Upploader.Uppload({maxSize:[1500,1500],call:["#docUploadBtn"],lang:Upploader.en,uploader:function(d){return""!=o&&null!=o||(o=d.name.substr(0,d.name.lastIndexOf("."))||d.name),new Promise(function(n,c){var l=new FormData;l.append("cmd","putdoc"),l.append("guestId",a.guestId),l.append("psgId",a.psgId),l.append("docTitle",o),l.append("mimetype",d.type),l.append("file",d),e.ajax({url:a.serviceURL,dataType:"JSON",type:"post",data:l,contentType:!1,processData:!1,success:function(a){a.idDoc>0?(i.ajax.reload(),function(t){e(t.uploader).find("input").val("")}(t),n("success")):a.error?c(a.error):c("An unknown error occurred.")}})})}}),DocUppload.on("open",function(){o="",e(DocUppload.container).find(".uppload-service--local").prepend("<input type='text' placeholder='Enter Document Title' class='input' id='docTitle'>"),e(DocUppload.container).find(".drop-area").append("<p>Allowed filetypes: pdf, doc, docx, jpeg, png<br>Maximum File Size: 5MB</p>")}),e(document).on("change","input#docTitle",function(){o=e("input#docTitle").val()}),local=new Upploader.Local({maxFileSize:5e6,mimeTypes:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","image/jpeg","image/png"]}),DocUppload.use([local,new Upploader.Crop({hideAspectRatioSettings:!0})])}}(i,d),this}}(jQuery);