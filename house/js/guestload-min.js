/* global getDoc, memberData, rctMkup, psgTabIndex, getAgent, pmtMkup, $,
  flagAlertMessage, saveFees, viewVisit, dateRender, dateFormat */ /**
 * guestload.js
 *
 * @author    Eric K. Crane <ecrane@nonprofitsoftwarecorp.org>
 * @copyright 2010-2017 <nonprofitsoftwarecorp.org>
 * @license   GPL and MIT
 * @link      https://github.com/NPSC/HHK
 */ function isNumber(a){return!isNaN(parseFloat(a))&&isFinite(a)}var dtCols=[{targets:[0],title:"Date",data:"Date",render:function(a,b){return dateRender(a,b,dateFormat)}},{targets:[1],title:"Type",searchable:!1,sortable:!1,data:"Type"},{targets:[2],title:"Sub-Type",searchable:!1,sortable:!1,data:"Sub-Type"},{targets:[3],title:"User",searchable:!1,sortable:!0,data:"User"},{targets:[4],visible:!1,data:"Id"},{targets:[5],title:"Log Text",sortable:!1,data:"Log Text"}];function relationReturn(c){var a=$.parseJSON(c);if(a.error)a.gotopage&&window.open(a.gotopage,"_self"),flagAlertMessage(a.error,"error");else if(a.success){if(a.rc&&a.markup){var b=$("#acm"+a.rc);b.children().remove();var d=$(a.markup);b.append(d.children())}flagAlertMessage(a.success,"success")}}function setupPsgNotes(b,a){return a.notesViewer({linkId:b,linkType:"psg",newNoteAttrs:{id:"psgNewNote",name:"psgNewNote"},alertMessage:function(a,b){flagAlertMessage(a,b)}}),a}function manageRelation(a,b,c,d){$.post("ws_admin.php",{id:a,rId:b,rc:c,cmd:d},relationReturn)}function paymentRefresh(){var a=$("#psgList").tabs("option","active");$("#psgList").tabs("load",a)}$(document).ready(function(){"use strict";var f,g,b,e,a=memberData,h=1,i="../admin/ws_gen.php?cmd=chglog&vw=vguest_audit_log&uid="+a.id;if($.widget("ui.autocomplete",$.ui.autocomplete,{_resizeMenu:function(){var a=this.menu.element;a.outerWidth(1.1*Math.max(a.width("").outerWidth()+1,this.element.outerWidth()))}}),$("#divFuncTabs").tabs({collapsible:!0}),$("#vIncidentContent").incidentViewer({guestLabel:a.guestLabel,visitorLabel:a.visitorLabel,guestId:a.id,psgId:a.idPsg,alertMessage:function(a,b){flagAlertMessage(a,b)}}),useDocUpload&&$("#vDocsContent").docUploader({visitorLabel:a.visitorLabel,guestId:a.id,psgId:a.idPsg,alertMessage:function(a,b){flagAlertMessage(a,b)}}),$("#submit").dialog({autoOpen:!1,resizable:!1,width:getDialogWidth(300),modal:!0,buttons:{Exit:function(){$(this).dialog("close")}}}),$("#keysfees").dialog({autoOpen:!1,resizable:!0,modal:!0,close:function(){$("div#submitButtons").show()},open:function(){$("div#submitButtons").hide()}}),$("#pmtRcpt").dialog({autoOpen:!1,resizable:!0,modal:!0,title:"Payment Receipt"}),$("#faDialog").dialog({autoOpen:!1,resizable:!0,width:getDialogWidth(600),modal:!0,title:"Income Chooser"}),""!==rctMkup&&showReceipt("#pmtRcpt",rctMkup),""!==pmtMkup&&$("#paymentMessage").html(pmtMkup).show(),$(".hhk-view-visit").click(function(d){var b=$(this).data("vid"),e=$(this).data("gid"),c=$(this).data("span");$(d.target).hasClass("hhk-hospitalstay")||(viewVisit(e,b,{"Show Statement":function(){window.open("ShowStatement.php?vid="+b,"_blank")},"Show Registration Form":function(){window.open("ShowRegForm.php?vid="+b+"&span="+c,"_blank")},Save:function(){saveFees(e,b,c,!1,"GuestEdit.php?id="+e+"&psg="+a.idPsg)},Cancel:function(){$(this).dialog("close")}},"Edit Visit #"+b+"-"+c,"",c),$("#divAlert1").hide())}),$("#resvAccordion").accordion({heightStyle:"content",collapsible:!0,active:!1,icons:!1}),$("div.hhk-relations").each(function(){var b=$(this).attr("name");$(this).on("click","td.hhk-deletelink",function(){a.id>0&&confirm($(this).attr("title")+"?")&&manageRelation(a.id,$(this).attr("name"),b,"delRel")}),$(this).on("click","td.hhk-newlink",function(){if(a.id>0){var c=$(this).attr("title");$("#hdnRelCode").val(b),$("#submit").dialog("option","title",c),$("#submit").dialog("open")}})}),$("#cbNoVehicle").change(function(){this.checked?$("#tblVehicle").hide():$("#tblVehicle").show()}),$("#cbNoVehicle").change(),$("#btnNextVeh, #exAll, #exNone").button(),$("#btnNextVeh").click(function(){$("#trVeh"+h).show("fade"),++h>4&&$("#btnNextVeh").hide("fade")}),$("#divNametabs").tabs({beforeActivate:function(b,a){"chglog"!==a.newTab.prop("id")||f||(f=$("#dataTbl").dataTable({columnDefs:dtCols,serverSide:!0,processing:!0,deferRender:!0,language:{search:"Search Log Text:"},sorting:[[0,"desc"]],displayLength:25,lengthMenu:[[25,50,100,-1],[25,50,100,"All"]],Dom:'<"top"ilf>rt<"bottom"ip>',ajax:{url:i}}))},collapsible:!0}),$("#btnSubmit, #btnReset, #btnCred").button(),$("#phEmlTabs").tabs(),$("#emergTabs").tabs(),$("#addrsTabs").tabs(),$("#InsTabs").tabs(),b=$("#psgList").tabs({collapsible:!0,beforeActivate:function(c,b){b.newPanel.length>0&&("fin"===b.newTab.prop("id")&&(getIncomeDiag(0,a.idReg),c.preventDefault()),"lipsg"!==b.newTab.prop("id")||g||(g=setupPsgNotes(a.idPsg,$("#psgNoteViewer"))))},load:function(b,a){"pmtsTable"===a.tab.prop("id")&&paymentsTable("feesTable","rptfeediv",paymentRefresh)}}),a.psgOnly&&b.tabs("disable"),b.tabs("enable",psgTabIndex),b.tabs("option","active",psgTabIndex),$("#cbnoReturn").change(function(){this.checked?$("#selnoReturn").show():$("#selnoReturn").hide()}),$("#cbnoReturn").change(),0===a.id)$("#divFuncTabs").tabs("option","disabled",[2,3,4]),$("#phEmlTabs").tabs("option","active",1),$("#phEmlTabs").tabs("option","disabled",[0]);else{var c=parseInt($("#addrsTabs").children("ul").data("actidx"),10);isNaN(c)&&(c=0),$("#addrsTabs").tabs("option","active",c)}if($.datepicker.setDefaults({yearRange:"-0:+02",changeMonth:!0,changeYear:!0,autoSize:!0,numberOfMonths:1,dateFormat:"M d, yy"}),$(".ckdate").datepicker({yearRange:"-02:+03"}),$(".ckbdate").datepicker({yearRange:"-99:+00",changeMonth:!0,changeYear:!0,autoSize:!0,maxDate:0,dateFormat:"M d, yy"}),$("#cbLastConfirmed").change(function(){$(this).prop("checked")?$("#txtLastConfirmed").datepicker("setDate","+0"):$("#txtLastConfirmed").val($("#txtLastConfirmed").prop("defaultValue"))}),$("#txtLastConfirmed").change(function(){$("#txtLastConfirmed").val()==$("#txtLastConfirmed").prop("defaultValue")?$("#cbLastConfirmed").prop("checked",!1):$("#cbLastConfirmed").prop("checked",!0)}),verifyAddrs("div#nameTab, div#hospitalSection"),addrPrefs(a),createZipAutoComplete($("input.hhk-zipsearch"),"ws_admin.php",e),$("#btnSubmit").click(function(){if("Saving>>>>"===$(this).val())return!1;$(this).val("Saving>>>>")}),$("#txtsearch").keypress(function(b){var a=$(this).val();"13"==b.keyCode&&(""!=a&&isNumber(parseInt(a,10))?(a>0&&window.location.assign("GuestEdit.php?id="+a),b.preventDefault()):(alert("Don't press the return key unless you enter an Id."),b.preventDefault()))}),$("#cbdeceased").change(function(){$(this).prop("checked")?$("#disp_deceased").show():$("#disp_deceased").hide()}),$("#cbbackgroundcheck").change(function(){$(this).prop("checked")?($("#txtBackgroundCheckDate").datepicker("setDate","+0"),$("#disp_backgroundcheck").show()):($("#txtBackgroundCheckDate").val(""),$("#disp_backgroundcheck").hide())}),$("select.hhk-multisel").each(function(){$(this).multiselect({selectedList:3})}),createAutoComplete($("#txtsearch"),3,{cmd:"role",mode:"mo",gp:"1"},function(a){a.id>0&&window.location.assign("GuestEdit.php?id="+a.id)}),createAutoComplete($("#txtMRNsearch"),3,{cmd:"role",mode:"mo",gp:"1",mrn:"1"},function(a){a.id>0&&window.location.assign("GuestEdit.php?id="+a.id)}),createAutoComplete($("#txtPhsearch"),5,{cmd:"role",mode:"mo",gp:"1"},function(a){a.id>0&&window.location.assign("GuestEdit.php?id="+a.id)}),createAutoComplete($("#txtRelSch"),3,{cmd:"srrel",basis:$("#hdnRelCode").val(),id:a.id},function(b){$.post("ws_admin.php",{rId:b.id,id:a.id,rc:$("#hdnRelCode").val(),cmd:"newRel"},relationReturn)}),""!==resultMessage&&flagAlertMessage(resultMessage,"alert"),$("input.hhk-check-button").click(function(){"exAll"===$(this).prop("id")?$("input.hhk-ex").prop("checked",!0):$("input.hhk-ex").prop("checked",!1)}),$("#divFuncTabs").show(),$(".hhk-showonload").show(),$("#txtsearch").focus(),$(document).find("bfh-states").each(function(){$(this).data("dirrty-initial-value",$(this).data("state"))}),$(document).find("bfh-country").each(function(){$(this).data("dirrty-initial-value",$(this).data("country"))}),$("#btnCred").click(function(){cardOnFile($(this).data("id"),$(this).data("idreg"),"GuestEdit.php?id="+$(this).data("id")+"&psg="+a.idPsg,$(this).data("indx"))}),setupCOF($("#trvdCHNameg"),$("#btnCred").data("indx")),$("#keysfees").mousedown(function(b){var a=$(b.target);"pudiv"!==a[0].id&&0===a.parents("#pudiv").length&&$("div#pudiv").remove()}),$("#form1").dirrty(),$("#btnActvtyGo").button().click(function(){$(".hhk-alert").hide();var d=$("#txtactstart").datepicker("getDate");if(null===d){$("#txtactstart").addClass("ui-state-highlight"),flagAlertMessage("Enter start date","alert");return}$("#txtactstart").removeClass("ui-state-highlight");var c=$("#txtactend").datepicker("getDate");null===c&&(c=new Date);var b={cmd:"actrpt",start:d.toLocaleDateString(),end:c.toLocaleDateString(),psg:a.idPsg};$("#cbVisits").prop("checked")&&(b.visit="on"),$("#cbReserv").prop("checked")&&(b.resv="on"),$("#cbHospStay").prop("checked")&&(b.hstay="on"),$.post("ws_resc.php",b,function(a){if(a){try{a=$.parseJSON(a)}catch(b){alert("Parser error - "+b.message);return}a.error?(a.gotopage&&window.open(a.gotopage,"_self"),flagAlertMessage(a.error,"error")):a.success&&($("#activityLog").remove(),$("#vvisitLog").append($('<div id="activityLog"/>').append($(a.success))),$(".hhk-viewvisit").css("cursor","pointer"),$("#activityLog").on("click",".hhk-viewvisit",function(){if($(this).data("visitid")){var a=$(this).data("visitid").split("_");if(2===a.length){var b={Save:function(){saveFees(0,a[0],a[1])},Cancel:function(){$(this).dialog("close")}};viewVisit(0,a[0],b,"View Visit","n",a[1])}}else $(this).data("reservid")&&window.location.assign("Reserve.php?rid="+$(this).data("reservid"))}))}})}),showGuestPhoto||useDocUpload){var d=window.uploader;$(document).on("click",".upload-guest-photo",function(){$(d.container).removeClass().addClass("uppload-container"),d.updatePlugins(a=>[]),d.updateSettings({maxSize:[500,500],customClass:"guestPhotouploadContainer",uploader:function(b){return new Promise(function(e,f){var c=new FormData;c.append("cmd","putguestphoto"),c.append("guestId",a.id),c.append("guestPhoto",b),$.ajax({type:"POST",url:"ws_resc.php",dataType:"json",data:c,contentType:!1,processData:!1,success:function(b){b.error?f(b.error):(e("success"),$("#guestPhoto").prop("src","ws_resc.php?cmd=getguestphoto&guestId="+a.id+"r&x="+new Date().getTime()),$(".delete-guest-photo").show()),d.navigate("local")},error:function(a){f(a)}})})}});var b=new Upploader.Local({maxFileSize:5e6,mimeTypes:["image/jpeg","image/png"]});window.camera=new Upploader.Camera,d.use([b,new Upploader.Crop({aspectRatio:1}),window.camera]),d.open()}),d.on("open",function(){1==d.effects.length?$(d.container).find(".effects-tabs").hide():$(d.container).find(".effects-tabs").show()}),d.on("close",function(){d.navigate("local");var a=d.services.filter(a=>"camera"==a.name);1==a.length&&a[0].stop()}),$(document).on("click","#hhk-guest-photo",function(a){a.preventDefault()}),$("#hhk-guest-photo").on({mouseenter:function(){$("#hhk-guest-photo-actions").show(),$("#hhk-guest-photo img").fadeTo(100,.5)},mouseleave:function(){$("#hhk-guest-photo-actions").hide(),$("#hhk-guest-photo img").fadeTo(100,1)}}),$(".delete-guest-photo").on("click",function(){confirm("Really Delete this photo?")&&$.ajax({type:"POST",url:"ws_resc.php",dataType:"json",data:{cmd:"deleteguestphoto",guestId:a.id},success:function(b){if(b.error){b.gotopage&&window.location.assign(b.gotopage),flagAlertMessage("Server error - "+b.error,"error");return}$("#guestPhoto").prop("src","ws_resc.php?cmd=getguestphoto&guestId="+a.id+"&rx="+new Date().getTime())},error:function(a){flagAlertMessage("AJAX error - "+a)}})})}})