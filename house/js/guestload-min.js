function isNumber(n){"use strict";return!isNaN(parseFloat(n))&&isFinite(n)}var dtCols=[{"targets":[0],"title":"Date",'data':'Date',render:function(a,b){return dateRender(a,b,dateFormat)}},{"targets":[1],"title":"Type","searchable":false,"sortable":false,"data":"Type"},{"targets":[2],"title":"Sub-Type","searchable":false,"sortable":false,"data":"Sub-Type"},{"targets":[3],"title":"User","searchable":false,"sortable":true,"data":"User"},{"targets":[4],"visible":false,"data":"Id"},{"targets":[5],"title":"Log Text","sortable":false,"data":"Log Text"}];function relationReturn(a){var b=$.parseJSON(a);if(b.error){if(b.gotopage){window.open(b.gotopage,'_self')}flagAlertMessage(b.error,'error')}else if(b.success){if(b.rc&&b.markup){var c=$('#acm'+b.rc);c.children().remove();var d=$(b.markup);c.append(d.children())}flagAlertMessage(b.success,'success')}}function setupPsgNotes(c,d){d.notesViewer({linkId:c,linkType:'psg',newNoteAttrs:{id:'psgNewNote',name:'psgNewNote'},alertMessage:function(a,b){flagAlertMessage(a,b)}});return d}function manageRelation(a,b,c,d){$.post('ws_admin.php',{'id':a,'rId':b,'rc':c,'cmd':d},relationReturn)}function paymentRefresh(){var a=$('#psgList').tabs('option','active');$('#psgList').tabs('load',a)}$(document).ready(function(){"use strict";var g=memberData;var h=1;var i='../admin/ws_gen.php?cmd=chglog&vw=vguest_audit_log&uid='+g.id;var j;var k,$psgList;$.widget("ui.autocomplete",$.ui.autocomplete,{_resizeMenu:function(){var a=this.menu.element;a.outerWidth(Math.max(a.width("").outerWidth()+1,this.element.outerWidth())*1.1)}});$("#divFuncTabs").tabs({collapsible:true});$('#vIncidentContent').incidentViewer({guestLabel:g.guestLabel,visitorLabel:g.visitorLabel,guestId:g.id,psgId:g.idPsg,alertMessage:function(a,b){flagAlertMessage(a,b)}});if(useDocUpload){$('#vDocsContent').docUploader({guestLabel:g.guestLabel,guestId:g.id,psgId:g.idPsg,alertMessage:function(a,b){flagAlertMessage(a,b)}})}$("#submit").dialog({autoOpen:false,resizable:false,width:300,modal:true,buttons:{"Exit":function(){$(this).dialog("close")}}});$('#keysfees').dialog({autoOpen:false,resizable:true,modal:true,close:function(){$('div#submitButtons').show()},open:function(){$('div#submitButtons').hide()}});$('#pmtRcpt').dialog({autoOpen:false,resizable:true,modal:true,title:'Payment Receipt'});$("#faDialog").dialog({autoOpen:false,resizable:true,width:650,modal:true,title:'Income Chooser'});if(rctMkup!==''){showReceipt('#pmtRcpt',rctMkup)}if(pmtMkup!==''){$('#paymentMessage').html(pmtMkup).show()}$('.hhk-view-visit').click(function(a){var b=$(this).data('vid');var c=$(this).data('gid');var d=$(this).data('span');var e=$(a.target);if(e.hasClass('hhk-hospitalstay')){return}var f={"Show Statement":function(){window.open('ShowStatement.php?vid='+b,'_blank')},"Show Registration Form":function(){window.open('ShowRegForm.php?vid='+b+'&span='+d,'_blank')},"Save":function(){saveFees(c,b,d,false,'GuestEdit.php?id='+c+'&psg='+g.idPsg)},"Cancel":function(){$(this).dialog("close")}};viewVisit(c,b,f,'Edit Visit #'+b+'-'+d,'',d);$('#divAlert1').hide()});$('#resvAccordion').accordion({heightStyle:"content",collapsible:true,active:false,icons:false});$('div.hhk-relations').each(function(){var b=$(this).attr('name');$(this).on('click','td.hhk-deletelink',function(){if(g.id>0){if(confirm($(this).attr('title')+'?')){manageRelation(g.id,$(this).attr('name'),b,'delRel')}}});$(this).on('click','td.hhk-newlink',function(){if(g.id>0){var a=$(this).attr('title');$('#hdnRelCode').val(b);$('#submit').dialog("option","title",a);$('#submit').dialog('open')}})});$('#cbNoVehicle').change(function(){if(this.checked){$('#tblVehicle').hide()}else{$('#tblVehicle').show()}});$('#cbNoVehicle').change();$('#btnNextVeh, #exAll, #exNone').button();$('#btnNextVeh').click(function(){$('#trVeh'+h).show('fade');h++;if(h>4){$('#btnNextVeh').hide('fade')}});$('#divNametabs').tabs({beforeActivate:function(b,c){var d=$('#vvisitLog').find('table');if(c.newTab.prop('id')==='visitLog'&&d.length===0){$.post('ws_ckin.php',{cmd:'gtvlog',idReg:g.idReg},function(a){if(a){try{a=$.parseJSON(a)}catch(err){alert("Parser error - "+err.message);return}if(a.error){if(a.gotopage){window.open(a.gotopage,'_self')}flagAlertMessage(a.error,'error')}else if(a.vlog){$('#vvisitLog').append($(a.vlog))}}})}else if(c.newTab.prop('id')==='chglog'&&!j){j=$('#dataTbl').dataTable({"columnDefs":dtCols,"serverSide":true,"processing":true,"deferRender":true,"language":{"search":"Search Log Text:"},"sorting":[[0,'desc']],"displayLength":25,"lengthMenu":[[25,50,100,-1],[25,50,100,"All"]],"Dom":'<"top"ilf>rt<"bottom"ip>',ajax:{url:i}})}},collapsible:true});$('#btnSubmit, #btnReset, #btnCred').button();$('#phEmlTabs').tabs();$('#emergTabs').tabs();$('#addrsTabs').tabs();$psgList=$('#psgList').tabs({collapsible:true,beforeActivate:function(a,b){if(b.newPanel.length>0){if(b.newTab.prop('id')==='fin'){getIncomeDiag(0,g.idReg);a.preventDefault()}if(b.newTab.prop('id')==='lipsg'&&!k){k=setupPsgNotes(g.idPsg,$('#psgNoteViewer'))}}},load:function(a,b){if(b.tab.prop('id')==='pmtsTable'){paymentsTable('feesTable','rptfeediv',paymentRefresh)}}});if(g.psgOnly){$psgList.tabs("disable")}$psgList.tabs("enable",psgTabIndex);$psgList.tabs("option","active",psgTabIndex);$('#psgList').on('click','.hhk-hospitalstay',function(a){a.preventDefault();viewHospitalStay($(this).data('idhs'))});$('#cbnoReturn').change(function(){if(this.checked){$('#selnoReturn').show()}else{$('#selnoReturn').hide()}});$('#cbnoReturn').change();if(g.id===0){$("#divFuncTabs").tabs("option","disabled",[2,3,4]);$('#phEmlTabs').tabs("option","active",1);$('#phEmlTabs').tabs("option","disabled",[0])}else{var l=parseInt($('#addrsTabs').children('ul').data('actidx'),10);if(isNaN(l)){l=0}$('#addrsTabs').tabs("option","active",l)}$.datepicker.setDefaults({yearRange:'-0:+02',changeMonth:true,changeYear:true,autoSize:true,numberOfMonths:1,dateFormat:'M d, yy'});$('.ckdate').datepicker({yearRange:'-02:+03'});$('.ckbdate').datepicker({yearRange:'-99:+00',changeMonth:true,changeYear:true,autoSize:true,maxDate:0,dateFormat:'M d, yy'});$('#cbLastConfirmed').change(function(){if($(this).prop('checked')){$('#txtLastConfirmed').datepicker('setDate','+0')}else{$('#txtLastConfirmed').val($('#txtLastConfirmed').prop('defaultValue'))}});$('#txtLastConfirmed').change(function(){if($('#txtLastConfirmed').val()==$('#txtLastConfirmed').prop('defaultValue')){$('#cbLastConfirmed').prop('checked',false)}else{$('#cbLastConfirmed').prop('checked',true)}});verifyAddrs('div#nameTab, div#hospitalSection');addrPrefs(g);var m;createZipAutoComplete($('input.hhk-zipsearch'),'ws_admin.php',m);$('#btnSubmit').click(function(){if($(this).val()==='Saving>>>>'){return false}$(this).val('Saving>>>>')});$('#txtsearch').keypress(function(a){var b=$(this).val();if(a.keyCode=='13'){if(b==''||!isNumber(parseInt(b,10))){alert("Don't press the return key unless you enter an Id.");a.preventDefault()}else{if(b>0){window.location.assign("GuestEdit.php?id="+b)}a.preventDefault()}}});$('#cbdeceased').change(function(){if($(this).prop('checked')){$('#disp_deceased').show()}else{$('#disp_deceased').hide()}});$('select.hhk-multisel').each(function(){$(this).multiselect({selectedList:3})});createAutoComplete($('#txtAgentSch'),3,{cmd:'filter',add:'phone',basis:'ra'},getAgent);if($('#a_txtLastName').val()===''){$('.hhk-agentInfo').hide()}createAutoComplete($('#txtDocSch'),3,{cmd:'filter',basis:'doc'},getDoc);if($('#d_txtLastName').val()===''){$('.hhk-docInfo').hide()}createAutoComplete($('#txtsearch'),3,{cmd:'role',mode:'mo',gp:'1'},function(a){if(a.id>0){window.location.assign("GuestEdit.php?id="+a.id)}});createAutoComplete($('#txtPhsearch'),5,{cmd:'role',mode:'mo',gp:'1'},function(a){if(a.id>0){window.location.assign("GuestEdit.php?id="+a.id)}});createAutoComplete($('#txtRelSch'),3,{cmd:'srrel',basis:$('#hdnRelCode').val(),id:g.id},function(a){$.post('ws_admin.php',{'rId':a.id,'id':g.id,'rc':$('#hdnRelCode').val(),'cmd':'newRel'},relationReturn)});if(resultMessage!==''){flagAlertMessage(resultMessage,'alert')}$('input.hhk-check-button').click(function(){if($(this).prop('id')==='exAll'){$('input.hhk-ex').prop('checked',true)}else{$('input.hhk-ex').prop('checked',false)}});$('#divFuncTabs').show();$('.hhk-showonload').show();$('#txtsearch').focus();$(document).find("bfh-states").each(function(){$(this).data("dirrty-initial-value",$(this).data('state'))});$(document).find("bfh-country").each(function(){$(this).data("dirrty-initial-value",$(this).data('country'))});$('#btnCred').click(function(){cardOnFile($(this).data('id'),$(this).data('idreg'),'GuestEdit.php?id='+$(this).data('id')+'&psg='+g.idPsg,$(this).data('indx'))});setupCOF($('#trvdCHNameg'),$('#btnCred').data('indx'));$('#keysfees').mousedown(function(a){var b=$(a.target);if(b[0].id!=='pudiv'&&b.parents("#"+'pudiv').length===0){$('div#pudiv').remove()}});$("#form1").dirrty();if(showGuestPhoto||useDocUpload){var n=window.uploader;$(document).on('click','.upload-guest-photo',function(){$(n.container).removeClass().addClass('uppload-container');n.updatePlugins(plugins=>[]);n.updateSettings({maxSize:[500,500],customClass:'guestPhotouploadContainer',uploader:function uploadFunction(e){return new Promise(function(b,c){var d=new FormData();d.append('cmd','putguestphoto');d.append('guestId',g.id);d.append('guestPhoto',e);$.ajax({type:"POST",url:"ws_resc.php",dataType:"json",data:d,contentType:false,processData:false,success:function(a){if(a.error){c(a.error)}else{b("success");$("#guestPhoto").prop("src","ws_resc.php?cmd=getguestphoto&guestId="+g.id+"r&x="+new Date().getTime());$(".delete-guest-photo").show()}n.navigate('local')},error:function(a){c(a)}})})},});var f=new Upploader.Local({maxFileSize:5000000,mimeTypes:["image/jpeg","image/png"]});window.camera=new Upploader.Camera()n.use([f,new Upploader.Crop({aspectRatio:1}),window.camera]);n.open()});n.on("open",function(){if(n.effects.length==1){$(n.container).find(".effects-tabs").hide()}else{$(n.container).find(".effects-tabs").show()}});n.on('close',function(){n.navigate('local');var a=n.services.filter(service=>service.name=='camera');if(a.length==1){a[0].stop()}});$(document).on("click","#hhk-guest-photo",function(e){e.preventDefault()});$("#hhk-guest-photo").on({mouseenter:function(){$("#hhk-guest-photo-actions").show();$("#hhk-guest-photo img").fadeTo(100,0.5)},mouseleave:function(){$("#hhk-guest-photo-actions").hide();$("#hhk-guest-photo img").fadeTo(100,1)}});$(".delete-guest-photo").on("click",function(){if(confirm("Really Delete this photo?")){$.ajax({type:"POST",url:"ws_resc.php",dataType:"json",data:{cmd:"deleteguestphoto",guestId:g.id},success:function(a){if(a.error){if(a.gotopage){window.location.assign(a.gotopage)}flagAlertMessage("Server error - "+a.error,'error');return}else{$("#guestPhoto").prop("src","ws_resc.php?cmd=getguestphoto&guestId="+g.id+"&rx="+new Date().getTime())}},error:function(a){flagAlertMessage("AJAX error - "+a)}})}})}});
