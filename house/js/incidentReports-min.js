!function(t){function e(t){t.incidentdialog.find("input").val(""),t.incidentdialog.find("input").removeClass("ui-state-error"),t.incidentdialog.find("textarea").empty(),t.incidentdialog.find("textarea").val(""),t.incidentdialog.find("option").removeAttr("selected"),t.incidentdialog.find(".incidentStatus").val("a"),t.incidentdialog.find(".jsignature").empty(),t.incidentdialog.find(".jsignature").jSignature({width:"563px",height:"141px"}),t.incidentdialog.find(".hhk-clear-signature-btn").button(),t.incidentdialog.find(".hhk-finish-signature-btn").button(),t.incidentdialog.on("click",".hhk-clear-signature-btn",function(){t.incidentdialog.find(".jsignature").jSignature("clear"),t.incidentdialog.find(".sigDate").datepicker("setDate","")}),t.incidentdialog.find(".incdate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"}).datepicker("setDate","today"),t.incidentdialog.find(".resdate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"}),t.incidentdialog.find(".sigDate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"})}function i(i,n,d,a){var s=!1;if(null==a&&(a=!1),""==i.incidentdialog.find("input[name=incidentTitle]").val()?(s=!0,i.incidentdialog.find("input[name=incidentTitle]").addClass("ui-state-error")):i.incidentdialog.find("input[name=incidentTitle]").removeClass("ui-state-error"),""==i.incidentdialog.find("input[name=incidentDate]").val()?(s=!0,i.incidentdialog.find("input[name=incidentDate]").addClass("ui-state-error")):i.incidentdialog.find("input[name=incidentDate]").removeClass("ui-state-error"),1==s)n.alertMessage("Incident not saved. Check fields in red.","alert");else{var r=i.incidentdialog.find("input[name=reportId]").val(),l=i.incidentdialog.find("form").serialize();l+="&signature="+encodeURIComponent(i.incidentdialog.find(".jsignature").jSignature("getData")),l+=r>0?"&cmd=editIncident&repId="+r:"&cmd=saveIncident&guestId="+n.guestId+"&psgId="+n.psgId,t.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:l,success:function(s){s.idReport>0?(a&&function(e,i,n){null==n&&(n=0);t.ajax({url:i.serviceURL,dataType:"JSON",type:"post",data:{cmd:"getincidentreport",print:!0,repid:n},success:function(t){if(t.title){var e="";"a"==t.status?e="Active":"h"==t.status?e="On Hold":"r"==t.status&&(e="Resolved");var i='<div id="incidentPrint">';t.guest&&(i+='<h3>Guest</h3><table cellpadding="10" style="margin-bottom: 2em;"><thead><tr><th>Name</th><th>Phone</th><th>Address</th></tr></thead><tbody><tr><td> '+t.guest.First+" "+t.guest.Last+"</td><td>"+t.guest.Phone+"</td>",t.guest.Address?i+="<td>"+t.guest.Address+"<br>"+t.guest.City+", "+t.guest.State+" "+t.guest.Zip+"</td>":i+="<td></td>",i+="</tr></tbody></table>"),i+='<h3>Incident</h3><table cellpadding="10"><tr><td class="tdlabel">Title</td><td>'+t.title+'</td></tr><tr><td class="tdlabel">Date</td><td>'+t.reportDate+'</td></tr><tr><td class="tdlabel">Author</td><td>'+t.createdBy+'</td></tr><tr><td class="tdlabel">Description</td><td>'+t.description+'</td></tr><tr><td class="tdlabel">Status</td><td>'+e+'</td></tr><tr><td class="tdlabel">Resolution</td><td>'+t.resolution+'</td></tr><tr><td class="tdlabel" style="width: 25%;">Resolution Date</td><td>'+t.resolutionDate+'</td></tr><tr><td class="tdlabel" style="width: 25%; height: 100px;">Signature</td>',t.signature?i+='<td><img src="'+t.signature+'"></td>':i+="<td></td>",i+='</tr><tr><td class="tdlabel">Signature Date</td><td>'+t.signatureDate+"</td></tr>",t.updatedBy&&(i+='<tr><td class="tdlabel">Updated</td><td>'+t.updatedBy+" - "+t.updatedAt+"</td></tr>"),i+="</table></div>";var n=window.open("","PRINT","height=600,width=800");n.document.write("<html><head><title>"+document.title+"</title>"),n.document.write('<link href="css/house.css" rel="stylesheet" type="text/css">'),n.document.write('<link href="css/incidentReports.css" rel="stylesheet" type="text/css">'),n.document.write('</head><body class="PrintArea hhk-visitdialog hhk-tdbox">'),n.document.write("<h2>"+document.title+" - Incident Report</h2>"),n.document.write(i),n.document.write("</body></html>"),n.document.close(),n.focus(),n.print()}}})}(0,n,s.idReport),d.ajax.reload(),i.incidentdialog.dialog("close"),e(i)):s.error?n.alertMessage(s.error,"alert"):n.alertMessage("An unknown error occurred.","alert")}})}}t.fn.incidentViewer=function(n){var d=t('<div id="incidentDialog" class="hhk-tdbox hhk-visitdialog" title="Incident"><form><input type="hidden" name="reportId"><table><tr><td class="tdlabel">Incident Title</td><td><input type="text" name="incidentTitle"></td></tr><tr><td class="tdlabel">Incident Date</td><td><input type="text" name="incidentDate" class="incdate" readonly="readonly"></td></tr><tr><td class="tdlabel">Incident Description</td><td><textarea name="incidentDescription" rows="5"></textarea></td></tr><tr><td class="tdlabel">Incident Status</td><td><select name="incidentStatus" class="incidentStatus"><option value="a">Active</option><option value="r">Resolved</option><option value="h">On Hold</option><option value="d">Delete</option></select></td></tr><tr><td class="tdlabel">Incident Resolution</td><td><textarea name="incidentResolution" rows="5"></textarea></td></tr><tr><td class="tdlabel" style="width: 25%">Resolution Date</td><td><input type="text" name="resolutionDate" class="resdate" readonly="readonly"></td></tr><tr><td class="tdlabel" style="width: 25%">Signature<br><div style="color: #959595; display: block;">Use your mouse, finger or touch pen to sign</div><span></td><td><div class="signature-actions" style="text-align: right;"><div style="display: inline-block" class="hhk-clear-signature-btn hhk-report-button incident-edit ui-corner-all ui-state-default">Clear Signature</span></div><div style="display: inline-block" class="hhk-finish-signature-btn hhk-report-button incident-edit ui-corner-all ui-state-default">Finish Signature</span></div></div><div style="height: 141px;" class="jsignature"></div></td></tr><td class="tdlabel">Signature Date</td><td><input type="text" name="signatureDate" class="sigDate" readonly="readonly"></td></table></form></div>'),a={guestId:0,psgId:0,rid:0,serviceURL:"ws_resv.php",newLabel:"New Incident",tableAttrs:{class:"display compact",width:"100%"},newIncidentAttrs:{id:"incidentTitle",style:"width: 80%;",rows:2},alertMessage:function(t,e){},dtCols:[{targets:[0],title:"Actions",data:"Action",sortable:!1,searchable:!1,render:function(e,i,n){return d=e,a=t("<ul />").addClass("ui-widget ui-helper-clearfix hhk-ui-icons"),(s=t('<li title="Edit Incident" data-incidentid="'+d+'" />').addClass("hhk-report-button incident-edit ui-corner-all ui-state-default")).append(t('<span class="ui-icon ui-icon-pencil" />')),a.append(s),(s=t('<li title="Delete report" data-reportid="'+d+'" />').addClass("hhk-report-button incident-delete ui-corner-all ui-state-default")).append(t('<span class="ui-icon ui-icon-trash" />')),a.append(s),(s=t('<li title="Undo Delete" data-reportid="'+d+'" />').addClass("hhk-report-button incident-undodelete ui-corner-all ui-state-default").hide()).append(t('<span class="ui-icon ui-icon-arrowreturnthick-1-w" />')),a.append(s),t("<div />").append(a).html();var d,a,s}},{targets:[1],title:"Date",data:"Date",render:function(t,e){return dateRender(t,e,dateFormat)}},{targets:[2],title:"Guest",searchable:!0,sortable:!0,data:"Guest"},{targets:[3],title:"Title",searchable:!0,sortable:!1,width:"70%",className:"incidentTitle",data:"Title"},{targets:[4],title:"User",sortable:!1,searchable:!1,visible:!0,data:"User"},{targets:[5],title:"Status",sortable:!0,searchable:!0,visible:!0,data:"Status"}]},s=t.extend(!0,{},a,n),r=t(this);return r.incidentdialog=d,function(n,d){if(d.guestId>0||d.psgId>0||d.rid>0){t('<button class="ui-button ui-corner-all ui-state-default" id="incident-create"><span class="ui-icon ui-icon-plus"></span>New Incident</button>').appendTo(n);var a=t("<table />").attr(d.tableAttrs).appendTo(n),s=a.on("draw.dt",function(e,i){var n=new t.fn.dataTable.Api(i),d=n.rows().data(),a=0,s=0,r=0;d.length>0?(t.each(d,function(t,e){"Active"==e.Status?a++:"On Hold"==e.Status?s++:"Resolved"==e.Status&&r++}),t("#incidentCounts").text(" - "+a+" Active | "+s+" On Hold | "+r+" Resolved")):t("#incidentCounts").text(" - 0")}).DataTable({columnDefs:d.dtCols,serverSide:!0,processing:!0,deferRender:!0,language:{sSearch:"Search Incidents:"},sorting:[[5,"asc"],[1,"desc"]],paging:!1,lengthMenu:[[5,10,25,-1],[5,10,25,"All"]],dom:'<"dtTop"if>rt<"dtBottom"lp><"clear">',ajax:{url:d.serviceURL,data:{cmd:"getIncidentList",guestId:d.guestId,psgId:d.psgId,rid:d.rid}}});!function(i,n,d){i.on("click","#incident-create",function(t){t.preventDefault(),e(i),i.incidentdialog.dialog("open")}),i.on("click",".incident-edit",function(d){d.preventDefault(),e(i);var a=t(d.target).parent().data("incidentid");t.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:{cmd:"getincidentreport",repid:a},success:function(t){t.title&&(i.incidentdialog.find("input[name=reportId]").val(a),i.incidentdialog.find("input[name=incidentTitle]").val(t.title),i.incidentdialog.find("input[name=incidentDate]").val(t.reportDate),i.incidentdialog.find("textarea[name=incidentDescription]").val(t.description),i.incidentdialog.find("option[value="+t.status+"]").attr("selected","selected"),i.incidentdialog.find("textarea[name=incidentResolution]").val(t.resolution),i.incidentdialog.find("input[name=resolutionDate]").val(t.resolutionDate),t.signature&&i.incidentdialog.find(".jsignature").jSignature("setData",t.signature),i.incidentdialog.find("input[name=signatureDate]").val(t.signatureDate),i.incidentdialog.dialog("open"))}})}),i.incidentdialog.on("change",".incidentStatus",function(e){var n=t(e.currentTarget);"r"==n.val()?i.incidentdialog.find(".resdate").datepicker("setDate","today"):i.incidentdialog.find(".resdate").datepicker("setDate","")}),i.incidentdialog.on("click",".hhk-finish-signature-btn",function(t){i.incidentdialog.find(".sigDate").datepicker("setDate","today")}),i.on("click",".incident-delete",function(e){var i=t(this).data("reportid"),d=t(this).closest("tr");e.preventDefault(),t.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:{cmd:"deleteIncident",idReport:i},success:function(t){t.idReport>0?(d.find("td:not(:first)").css("opacity","0.3"),d.find(".incident-action").hide(),d.find(".incident-delete").hide(),d.find(".incident-edit").hide(),d.find(".incident-undodelete").show()):n.alertMessage(t.error,"error")}})}),i.on("click",".incident-undodelete",function(e){var i=t(this).data("reportid");e.preventDefault(),t.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:{cmd:"undoDeleteIncident",idReport:i},success:function(t){t.idReport>0?d.ajax.reload():n.alertMessage(t.error,"error")}})})}(n,d,s),t(".dataTables_filter").addClass("ignrSave"),t(".dtBottom").addClass("ignrSave"),n.append(n.incidentdialog),n.incidentdialog.dialog({autoOpen:!1,modal:!0,width:800,buttons:{Cancel:function(){n.incidentdialog.dialog("close"),e(n)},"Save and Print":function(){i(n,d,s,!0)},Save:function(){i(n,d,s)}}})}}(r,s),this}}(jQuery);