!function(r){function s(t){t.incidentdialog.find("input").val(""),t.incidentdialog.find("input").removeClass("ui-state-error"),t.incidentdialog.find("textarea").empty(),t.incidentdialog.find("textarea").val(""),t.incidentdialog.find("option").removeAttr("selected"),t.incidentdialog.find(".incidentStatus").val("a"),t.incidentdialog.find(".jsignature").empty(),t.incidentdialog.find(".jsignature").jSignature({width:"563px",height:"141px"}),t.incidentdialog.find(".hhk-clear-signature-btn").button(),t.incidentdialog.find(".hhk-finish-signature-btn").button(),t.incidentdialog.on("click",".hhk-clear-signature-btn",function(){t.incidentdialog.find(".jsignature").jSignature("clear"),t.incidentdialog.find(".sigDate").datepicker("setDate","")}),t.incidentdialog.find(".incdate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"}).datepicker("setDate","today"),t.incidentdialog.find(".resdate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"}),t.incidentdialog.find(".sigDate").datepicker({autoSize:!0,dateFormat:"M d, yy",yearRange:"c-5:c+3"})}function a(e,i,n,d){var t=!1;if(null==d&&(d=!1),""==e.incidentdialog.find("input[name=incidentTitle]").val()?(t=!0,e.incidentdialog.find("input[name=incidentTitle]").addClass("ui-state-error")):e.incidentdialog.find("input[name=incidentTitle]").removeClass("ui-state-error"),""==e.incidentdialog.find("input[name=incidentDate]").val()?(t=!0,e.incidentdialog.find("input[name=incidentDate]").addClass("ui-state-error")):e.incidentdialog.find("input[name=incidentDate]").removeClass("ui-state-error"),1==t)i.alertMessage.call("Incident not saved. Check fields in red.","alert");else{var a=e.incidentdialog.find("input[name=reportId]").val(),l=e.incidentdialog.find("form").serialize();l+="&signature="+encodeURIComponent(e.incidentdialog.find(".jsignature").jSignature("getData")),l+=0<a?"&cmd=editIncident&repId="+a:"&cmd=saveIncident&guestId="+i.guestId+"&psgId="+i.psgId,r.ajax({url:i.serviceURL,dataType:"JSON",type:"post",data:l,success:function(t){0<t.idReport?(d&&function(t,e,i){null==i&&(i=0);r.ajax({url:e.serviceURL,dataType:"JSON",type:"post",data:{cmd:"getincidentreport",print:!0,repid:i},success:function(t){if(t.title){var e="";"a"==t.status?e="Active":"h"==t.status?e="On Hold":"r"==t.status&&(e="Resolved");var i='<div id="incidentPrint">';t.guest&&(i+='<h3>Guest</h3><table cellpadding="10" style="margin-bottom: 2em;"><thead><tr><th>Name</th><th>Phone</th><th>Address</th></tr></thead><tbody><tr><td> '+t.guest.First+" "+t.guest.Last+"</td><td>"+t.guest.Phone+"</td>",t.guest.Address?i+="<td>"+t.guest.Address+"<br>"+t.guest.City+", "+t.guest.State+" "+t.guest.Zip+"</td>":i+="<td></td>",i+="</tr></tbody></table>"),i+='<h3>Incident</h3><table cellpadding="10"><tr><td class="tdlabel">Title</td><td>'+t.title+'</td></tr><tr><td class="tdlabel">Date</td><td>'+t.reportDate+'</td></tr><tr><td class="tdlabel">Author</td><td>'+t.createdBy+'</td></tr><tr><td class="tdlabel">Description</td><td>'+t.description+'</td></tr><tr><td class="tdlabel">Status</td><td>'+e+'</td></tr><tr><td class="tdlabel">Resolution</td><td>'+t.resolution+'</td></tr><tr><td class="tdlabel" style="width: 25%;">Resolution Date</td><td>'+t.resolutionDate+'</td></tr><tr><td class="tdlabel" style="width: 25%; height: 100px;">Signature</td>',t.signature?i+='<td><img src="'+t.signature+'"></td>':i+="<td></td>",i+='</tr><tr><td class="tdlabel">Signature Date</td><td>'+t.signatureDate+"</td></tr>",t.updatedBy&&(i+='<tr><td class="tdlabel">Updated</td><td>'+t.updatedBy+" - "+t.updatedAt+"</td></tr>"),i+="</table></div>";var n=window.open("","PRINT","height=600,width=800");n.document.write("<html><head><title>"+document.title+"</title>"),n.document.write('<link href="css/house.css" rel="stylesheet" type="text/css">'),n.document.write('<link href="css/incidentReports.css" rel="stylesheet" type="text/css">'),n.document.write('</head><body class="PrintArea hhk-visitdialog hhk-tdbox">'),n.document.write("<h2>"+document.title+" - Incident Report</h2>"),n.document.write(i),n.document.write("</body></html>"),n.document.close(),n.focus(),n.print()}}})}(0,i,t.idReport),n.ajax.reload(),e.incidentdialog.dialog("close"),s(e)):t.error?i.alertMessage.call(t.error,"alert"):i.alertMessage.call("An unknown error occurred.","alert")}})}}r.fn.incidentViewer=function(t){var e=r('<div id="incidentDialog" class="hhk-tdbox hhk-visitdialog" title="Incident"><form><input type="hidden" name="reportId"><table><tr><td class="tdlabel">Incident Title</td><td><input type="text" name="incidentTitle"></td></tr><tr><td class="tdlabel">Incident Date</td><td><input type="text" name="incidentDate" class="incdate" readonly="readonly"></td></tr><tr><td class="tdlabel">Incident Description</td><td><textarea name="incidentDescription" rows="5"></textarea></td></tr><tr><td class="tdlabel">Incident Status</td><td><select name="incidentStatus" class="incidentStatus"><option value="a">Active</option><option value="r">Resolved</option><option value="h">On Hold</option><option value="d">Delete</option></select></td></tr><tr><td class="tdlabel">Incident Resolution</td><td><textarea name="incidentResolution" rows="5"></textarea></td></tr><tr><td class="tdlabel" style="width: 25%">Resolution Date</td><td><input type="text" name="resolutionDate" class="resdate" readonly="readonly"></td></tr><tr><td class="tdlabel" style="width: 25%">Signature<br><div style="color: #959595; display: block;">Use your mouse, finger or touch pen to sign</div><span></td><td><div class="signature-actions" style="text-align: right;"><div style="display: inline-block" class="hhk-clear-signature-btn hhk-report-button incident-edit ui-corner-all ui-state-default">Clear Signature</span></div><div style="display: inline-block" class="hhk-finish-signature-btn hhk-report-button incident-edit ui-corner-all ui-state-default">Finish Signature</span></div></div><div style="height: 141px;" class="jsignature"></div></td></tr><td class="tdlabel">Signature Date</td><td><input type="text" name="signatureDate" class="sigDate" readonly="readonly"></td></table></form></div>'),i={guestId:0,psgId:0,rid:0,serviceURL:"ws_resv.php",newLabel:"New Incident",tableAttrs:{class:"display compact",width:"100%"},newIncidentAttrs:{id:"incidentTitle",style:"width: 80%;",rows:2},alertMessage:function(t,e){},dtCols:[{targets:[0],title:"Actions",data:"Action",sortable:!1,searchable:!1,render:function(t,e,i){return function(t){var e,i;return e=r("<ul />").addClass("ui-widget ui-helper-clearfix hhk-ui-icons"),(i=r('<li title="Edit Incident" data-incidentid="'+t+'" />').addClass("hhk-report-button incident-edit ui-corner-all ui-state-default")).append(r('<span class="ui-icon ui-icon-pencil" />')),e.append(i),(i=r('<li title="Delete report" data-reportid="'+t+'" />').addClass("hhk-report-button incident-delete ui-corner-all ui-state-default")).append(r('<span class="ui-icon ui-icon-trash" />')),e.append(i),(i=r('<li title="Undo Delete" data-reportid="'+t+'" />').addClass("hhk-report-button incident-undodelete ui-corner-all ui-state-default").hide()).append(r('<span class="ui-icon ui-icon-arrowreturnthick-1-w" />')),e.append(i),r("<div />").append(e).html()}(t)}},{targets:[1],title:"Date",data:"Date",render:function(t,e){return dateRender(t,e,dateFormat)}},{targets:[2],title:"Guest",searchable:!0,sortable:!0,data:"Guest"},{targets:[3],title:"Title",searchable:!0,sortable:!1,width:"70%",className:"incidentTitle",data:"Title"},{targets:[4],title:"User",sortable:!1,searchable:!1,visible:!0,data:"User"},{targets:[5],title:"Status",sortable:!0,searchable:!0,visible:!0,data:"Status"}]},n=r.extend(!0,{},i,t),d=r(this);return d.incidentdialog=e,function(t,e){if(0<e.guestId||0<e.psgId||0<e.rid){r('<button class="ui-button ui-corner-all ui-state-default" id="incident-create"><span class="ui-icon ui-icon-plus"></span>New Incident</button>').appendTo(t);var i=r("<table />").attr(e.tableAttrs).appendTo(t).on("draw.dt",function(t,e){var i=new r.fn.dataTable.Api(e).rows().data(),n=0,d=0,a=0;0<i.length?(r.each(i,function(t,e){"Active"==e.Status?n++:"On Hold"==e.Status?d++:"Resolved"==e.Status&&a++}),r("#incidentCounts").text(" - "+n+" Active | "+d+" On Hold | "+a+" Resolved")):r("#incidentCounts").text(" - 0")}).DataTable({columnDefs:e.dtCols,serverSide:!0,processing:!0,deferRender:!0,language:{sSearch:"Search Incidents:"},sorting:[[5,"asc"],[1,"desc"]],paging:!1,lengthMenu:[[5,10,25,-1],[5,10,25,"All"]],dom:'<"dtTop"if>rt<"dtBottom"lp><"clear">',ajax:{url:e.serviceURL,data:{cmd:"getIncidentList",guestId:e.guestId,psgId:e.psgId,rid:e.rid}}});!function(i,n,d){i.on("click","#incident-create",function(t){t.preventDefault(),s(i),i.incidentdialog.dialog("open")}),i.on("click",".incident-edit",function(t){t.preventDefault(),s(i);var e=r(t.target).parent().data("incidentid");r.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:{cmd:"getincidentreport",repid:e},success:function(t){t.title&&(i.incidentdialog.find("input[name=reportId]").val(e),i.incidentdialog.find("input[name=incidentTitle]").val(t.title),i.incidentdialog.find("input[name=incidentDate]").val(t.reportDate),i.incidentdialog.find("textarea[name=incidentDescription]").val(t.description),i.incidentdialog.find("option[value="+t.status+"]").attr("selected","selected"),i.incidentdialog.find("textarea[name=incidentResolution]").val(t.resolution),i.incidentdialog.find("input[name=resolutionDate]").val(t.resolutionDate),t.signature&&i.incidentdialog.find(".jsignature").jSignature("setData",t.signature),i.incidentdialog.find("input[name=signatureDate]").val(t.signatureDate),i.incidentdialog.dialog("open"))}})}),i.incidentdialog.on("change",".incidentStatus",function(t){"r"==r(t.currentTarget).val()?i.incidentdialog.find(".resdate").datepicker("setDate","today"):i.incidentdialog.find(".resdate").datepicker("setDate","")}),i.incidentdialog.on("click",".hhk-finish-signature-btn",function(t){i.incidentdialog.find(".sigDate").datepicker("setDate","today")}),i.on("click",".incident-delete",function(t){var e=r(this).data("reportid"),i=r(this).closest("tr");t.preventDefault(),r.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:{cmd:"deleteIncident",idReport:e},success:function(t){0<t.idReport?(i.find("td:not(:first)").css("opacity","0.3"),i.find(".incident-action").hide(),i.find(".incident-delete").hide(),i.find(".incident-edit").hide(),i.find(".incident-undodelete").show()):n.alertMessage.call(t.error,"error")}})}),i.on("click",".incident-undodelete",function(t){var e=r(this).data("reportid");t.preventDefault(),r.ajax({url:n.serviceURL,dataType:"JSON",type:"post",data:{cmd:"undoDeleteIncident",idReport:e},success:function(t){0<t.idReport?d.ajax.reload():n.alertMessage.call(t.error,"error")}})})}(t,e,i),r(".dataTables_filter").addClass("ignrSave"),r(".dtBottom").addClass("ignrSave"),t.append(t.incidentdialog),t.incidentdialog.dialog({autoOpen:!1,modal:!0,width:800,buttons:{Cancel:function(){t.incidentdialog.dialog("close"),s(t)},"Save and Print":function(){a(t,e,i,!0)},Save:function(){a(t,e,i)}}})}}(d,n),this}}(jQuery);
