!function(e){e.fn.smsDialog=function(t){var s={smsTabs:`<div id="smsTabs" class="ui-tabs ui-corner-all, ui-widget ui-widget-content ui-tabs-vertical ui-helper-clearfix ui-corner-all">
    <ul class="ui-tabs-nav ui-corner-all ui-helper-reset ui-helper-clearfix ui-widget-header"></ul>
</div> `,msgsTabMkup:`<div id="msgsTabContent" class="hhk-overflow-x ui-tabs-panel ui-corner-all ui-widget-content">
<h4 class="msgTitle"></h4>
<div class="msgsContainer loading"></div>
<div class="newMsg hhk-flex">
    <textarea class="ui-widget-content ui-corner-all" maxlength="306" placeholder="Message..."></textarea>
    <button class="ui-button ui-corner-all sendMsg" name="sendMsg" title="Send Message"><i class="bi bi-send-fill"></i></button>
</div>
</div>`,allGuestsTabMkup:`<div id="allGuestsTabContent" class="hhk-overflow-x ui-tabs-panel ui-corner-all ui-widget-content">
<h4 class="msgTitle"></h4>
<div class="allRecipients ui-widget-content ui-corner-all">
    <h5>To</h5>
</div>
<div class="newMsg hhk-flex">
    <textarea class="ui-widget-content ui-corner-all" maxlength="306" placeholder="Message..."></textarea>
    <button class="ui-button ui-corner-all sendMsg" name="sendMsg" title="Send Message"><i class="bi bi-send-fill"></i></button>
</div>
</div>`,campaignTabMkup:`<div id="campaignTabContent" class="hhk-overflow-x ui-tabs-panel ui-corner-all ui-widget-content">
<h4 class="msgTitle"></h4>
<div class="allRecipients ui-widget-content ui-corner-all">
    <h5>To</h5>
</div>
<div class="newMsg hhk-flex">
    <textarea class="ui-widget-content ui-corner-all" maxlength="288" placeholder="Message..."></textarea>
    <button class="ui-button ui-corner-all sendCampaign" name="sendCampaign" title="Send Message"><i class="bi bi-send-fill"></i></button>
</div>
<div class="infoMsg hhk-flex ui-widget ui-widget-content ui-corner-all ui-state-highlight hhk-panel hhk-tdbox my-2 align-items-center justify-content-between" style="display:none">
    <div class="smsInfoMsg"></div>
    <button class="ui-button ui-corner-all btnBatchWait" name="btnBatchWait">Keep wating</button>
</div>
</div>`,msgMkup:`<div class="msgContainer hhk-flex"> 
    <div class="msg">
        <div class="msgContent ui-widget-content ui-corner-all"></div>
        <div class="msgMeta"></div>
    </div>
</div>`,sendIcon:'<i class="bi bi-send-fill"></i>'},n=e(document).find("#viewMsgsDialog");0==n.length&&(n=e('<div id="viewMsgsDialog" class="loading">'));var i,l,o,d,r=e.extend(!0,{},{guestId:0,psgId:0,resvId:0,visitId:0,spanId:0,campaign:!1,autoOpen:!1,dialogTitle:"Text Guests",serviceURL:"ws_resv.php",guestData:[]},t),g=e(this);return function e(a,t){a.off("click","*")}(n,r),i=n,l=s,o=r,(d=g).on("click",function(a){a.preventDefault(),function a(t,s,n){t.dialog({autoOpen:!1,position:{my:"top",at:"top+10%"},width:getDialogWidth(600),resizable:!0,modal:!0,title:n.dialogTitle,buttons:{Close:function(){e(this).dialog("close")}},close:function(a,t){e(this).empty().dialog("destroy")}})}(i,l,o),i.dialog("open")}),i.on("dialogopen",function(t,s){(function t(s,n,i){if(s.addClass("loading"),i.visitId||i.resvId||i.guestId){if(i.visitId)var l={cmd:"getVisitMsgsDialog",idVisit:i.visitId,idSpan:i.spanId};else if(i.resvId)var l={cmd:"getResvMsgsDialog",idResv:i.resvId};else if(i.guestId)var l={cmd:"getGuestMsgsDialog",idName:i.guestId};e.ajax({method:"get",url:i.serviceURL,data:l,dataType:"json",success:function(t){if(i.guestData=t,t.error){t.gotopage&&window.open(t.gotopage,"_self"),flagAlertMessage(t.error,"error"),s.dialog("close");return}i.guestData[0]&&i.guestData[0].Room?s.dialog("option","title","Text Guests in Room "+i.guestData[0].Room):i.guestData[0]&&i.guestData[0].dialogTitle&&s.dialog("option","title",i.guestData[0].dialogTitle);var l=0;if(e.each(i.guestData,function(e,a){1==a.isMobile&&l++}),i.guestData.length>1&&l>0){s.html(n.smsTabs),s.find("#smsTabs ul").append(e('<li><a href="#allGuestsTabContent">Current Guests</a></li>'));let o=[];e.each(i.guestData,function(a,t){li=e('<li><a href="#msgsTabContent">'+t.Name_Full+"</a></li>").data(t),0==t.isMobile&&o.push(a+1),s.find("#smsTabs ul").append(li)}),s.find("#smsTabs").append(n.msgsTabMkup+n.allGuestsTabMkup).tabs({active:0,disabled:o,create:function(t,l){l.tab&&l.tab.data("Name_Full")&&(l.panel.find(".msgTitle").text(l.tab.data("Name_Full")+" - "+l.tab.data("Phone_Num")),l.panel.find(".newMsg textarea").attr("placeholder","Message "+l.tab.data("Phone_Num")+"...").val(""),l.panel.find(".newMsg button[name=sendMsg]").data("idname",l.tab.data("idName")),a($msgsContainer=l.panel.find(".msgsContainer").empty().addClass("loading"),n,i,l.tab.data("idName"))),s.find("#allGuestsTabContent .msgTitle").text("Text All Guests"),s.find("#allGuestsTabContent .newMsg textarea").attr("placeholder","Message...").val(""),s.find("#allGuestsTabContent .newMsg button[name=sendMsg]").data("idname",""),s.find("#allGuestsTabContent .allRecipients").empty().html("<h5>To:</h5>"),e.each(i.guestData,function(e,a){a.isMobile&&s.find("#allGuestsTabContent .allRecipients").append("<span title='"+a.Phone_Num+"'>"+a.Name_Full+"</span>")})},beforeActivate:function(e,t){t.newTab&&t.newTab.data("Name_Full")&&(t.newPanel.find(".msgTitle").text(t.newTab.data("Name_Full")+" - "+t.newTab.data("Phone_Num")),t.newPanel.find(".newMsg textarea").attr("placeholder","Message "+t.newTab.data("Phone_Num")+"...").val(""),t.newPanel.find(".newMsg button[name=sendMsg]").data("idname",t.newTab.data("idName")),a($msgsContainer=t.newPanel.find(".msgsContainer").empty().addClass("loading"),n,i,t.newTab.data("idName")))}}).find("li").removeClass("ui-corner-top").addClass("ui-corner-left"),s.find("button").button(),s.removeClass("loading")}else 1==i.guestData.length&&1===l?(s.html(n.msgsTabMkup),s.find(".msgTitle").text(i.guestData[0].Name_Full+" - "+i.guestData[0].Phone_Num),s.find(".newMsg textarea").attr("placeholder","Message "+i.guestData[0].Phone_Num+"...").val(""),s.find(".newMsg button[name=sendMsg]").data("idname",i.guestData[0].idName),a($msgsContainer=s.find(".msgsContainer").empty().addClass("loading"),n,i,i.guestData[0].idName),s.removeClass("loading")):(0==i.guestData.length||0===l)&&(s.html("<div class='ui-state-error ui-corner-all p-2'>No guests have opted in to receive text messages.</div>"),s.removeClass("loading"))}})}else i.campaign?e.ajax({method:"get",url:i.serviceURL,data:{cmd:"getCampaignMsgsDialog",status:i.campaign},dataType:"json",success:function(a){if(i.guestData=a,a.error){a.gotopage&&window.open(a.gotopage,"_self"),flagAlertMessage(a.error,"error"),s.dialog("close");return}if(i.guestData.title&&s.dialog("option","title","Text "+i.guestData.title),i.guestData.contacts.length>0){s.html(n.campaignTabMkup),s.find(".msgTitle").text("Text "+i.guestData.title),s.find(".newMsg textarea").attr("placeholder","Message...").val("");var t="";e.each(i.guestData.contacts,function(e,a){t+=a.Name_First+" "+a.Name_Last+" - "+a.Phone_Num+"<br>"}),s.find(".allRecipients").empty().html("<h5>To:</h5><span class='hhk-tooltip' id='collapsedrecipients' title=''>"+i.guestData.title+" ("+i.guestData.contacts.length+")</span>"),s.find("#collapsedrecipients").tooltip({content:t}),s.removeClass("loading")}else 0==i.guestData.contacts.length&&(s.html("<div class='ui-state-error ui-corner-all p-2'>No guests have opted in to recieve text messages.</div>"),s.removeClass("loading"))}}):(s.html("<div class='ui-state-error ui-corner-all p-2'>No guests found.</div>"),s.removeClass("loading"))})(i,l,o)}),i.on("input",".newMsg textarea",function(){this.style.height="auto",this.style.height=this.scrollHeight+3+"px"}),i.on("click","#msgsTabContent .sendMsg",function(){var t=e(this);t.attr("disabled",!0).html("&nbsp;").addClass("loading");var s=e(this).data("idname"),n=e(this).parent(".newMsg").find("textarea").attr("disabled",!0),i=e(this).parents("#msgsTabContent").find(".msgsContainer"),d=n.val();e.ajax({method:"post",url:o.serviceURL,data:{cmd:"sendMsg",idName:s,msgText:d},dataType:"json",success:function(e){if(e.error){e.gotopage&&window.open(e.gotopage,"_self"),flagAlertMessage(e.error,"error"),t.attr("disabled",!1).html(l.sendIcon).removeClass("loading"),n.attr("disabled",!1);return}e.id&&(flagAlertMessage("Message sent successfully","success"),a(i,l,o,s),t.attr("disabled",!1).html(l.sendIcon).removeClass("loading"),n.val("").attr("disabled",!1))}})}),i.on("click","#allGuestsTabContent .sendMsg",function(){var a=e(this);a.attr("disabled",!0).html("&nbsp;").addClass("loading");var t=e(this).parent(".newMsg").find("textarea").attr("disabled",!0),s=t.val();if(o.visitId>0)var n={cmd:"sendVisitMsg",idVisit:o.visitId,idSpan:o.spanId,msgText:s};else if(o.resvId>0)var n={cmd:"sendResvMsg",idResv:o.resvId,msgText:s};else var n={};e.ajax({method:"post",url:o.serviceURL,data:n,dataType:"json",success:function(e){e.error&&(e.gotopage&&window.open(e.gotopage,"_self"),flagAlertMessage(e.error,"error")),e.success&&flagAlertMessage(e.success,"success"),a.attr("disabled",!1).html(l.sendIcon).removeClass("loading"),t.val("").attr("disabled",!1)}})}),i.on("click","#campaignTabContent .sendCampaign",function(){var a=e(this),t=e(this).parent(".newMsg").find("textarea"),s=t.val(),n=e(this).parents("#campaignTabContent").find(".infoMsg");s.length>0?(a.attr("disabled",!0).html("&nbsp;").addClass("loading"),t.attr("disabled",!0),e.ajax({method:"post",url:o.serviceURL,data:{cmd:"sendCampaign",status:o.guestData.status,msgText:s},dataType:"json",success:function(e){if(e.error){e.gotopage&&window.open(e.gotopage,"_self"),flagAlertMessage(e.error,"error"),a.attr("disabled",!1).html(l.sendIcon).removeClass("loading");return}e.success?(flagAlertMessage(e.success,"success"),a.attr("disabled",!1).html(l.sendIcon).removeClass("loading"),t.val("").attr("disabled",!1),i.dialog("close")):e.info&&(n.find(".smsInfoMsg").text(e.info),n.show(),delete e.info,n.find(".btnBatchWait").data("batchInfo",e),console.log(n.find(".btnBatchWait").data("batchInfo")))}})):flagAlertMessage("SMS Message... field cannot be blank.")}),i.on("click","#campaignTabContent .btnBatchWait",function(){var a=e(this),t=e(this).parents("#campaignTabContent").find(".newMsg textarea").attr("disabled",!0),s=t.val(),n=e(this).parents("#campaignTabContent").find(".infoMsg"),d=n.find(".btnBatchWait").data("batchInfo");n.hide(),e.ajax({method:"post",url:o.serviceURL,data:{cmd:"sendCampaign",msgText:s,...d},dataType:"json",success:function(e){if(e.error){e.gotopage&&window.open(e.gotopage,"_self"),flagAlertMessage(e.error,"error"),a.attr("disabled",!1).html(l.sendIcon).removeClass("loading");return}e.success?(flagAlertMessage(e.success,"success"),a.attr("disabled",!1).html(l.sendIcon).removeClass("loading"),t.val("").attr("disabled",!1),i.dialog("close")):e.info&&(n.find(".smsInfoMsg").text(e.info),n.show())}})}),this};function a(a,t,s,n){a.addClass("loading"),e.ajax({method:"get",url:s.serviceURL,data:{cmd:"loadMsgs",idName:n},dataType:"json",success:function(s){if(s.error){s.gotopage&&window.open(s.gotopage,"_self"),flagAlertMessage(s.error,"error");return}s.msgs&&($msgsTab=a.parent(),!1===s.subscriptionStatus?($msgsTab.find(".msgTitle").append("<span class='smsUnsubscribed ui-corner-all p-1 ui-state-error' title='The user has unsubscribed and will not receive any messages.'>Unsubscribed</span>"),$msgsTab.find(".newMsg").addClass("d-none")):$msgsTab.find(".newMsg").removeClass("d-none"),a.empty(),e.each(s.msgs,function(n,i){let l=e(t.msgMkup),o=moment(i.timestamp);l.find(".msgContent").text(i.text),"MT"==i.directionType?l.addClass("houseMsg").find(".msgMeta").text(s.siteName+" - "+o.calendar()):"MO"==i.directionType&&l.addClass("guestMsg").find(".msgMeta").text(s.Name_First+" - "+o.calendar()),a.append(l)}),a.removeClass("loading").scrollTop(a.prop("scrollHeight")))}})}}(jQuery);