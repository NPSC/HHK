/**
 * payments.js
 *
 *
 * @category  house
 * @package   Hospitality HouseKeeper
 * @author    Eric K. Crane <ecrane@nonprofitsoftwarecorp.org>
 * @copyright 2010-2023 <nonprofitsoftwarecorp.org>
 * @license   GPL and MIT
 * @link      https://github.com/NPSC
 */ var gblAdjustData=[],gblRtCalcParams={days:0,idRate:0,idVisit:0,fixedAmt:0,adjAmt:0,numGuests:0,idResv:0},gblRtCalcData=!1;function roundTo(e,t){void 0===t&&(t=0);let a=Math.pow(10,t);return Math.round(e=parseFloat((e*a).toFixed(11)))/a}function getApplyDiscDiag(e,t){"use strict";if(!e||""==e||0==e){flagAlertMessage("Order Number is missing","error");return}$.post("ws_ckin.php",{cmd:"getHPay",ord:e,arrDate:$("#spanvArrDate").text()},function(e){if(e){try{e=$.parseJSON(e)}catch(a){alert("Parser error - "+a.message);return}e.error?(e.gotopage&&window.location.assign(e.gotopage),flagAlertMessage(e.error,"error")):e.markup&&(t.children().remove(),t.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog" style="font-size:0.8em;"/>').append($(e.markup))),$("#cbAdjustType").buttonset(),$("#cbAdjustPmt1, #cbAdjustPmt2").change(function(){var e=$(this).data("hid"),t=$(this).data("sho");$("."+e).val(""),$("."+t).val(""),$("#housePayment").val(""),$("#housePayment").change(),$("."+t).show(),$("."+e).hide()}),gblAdjustData.disc=e.disc,gblAdjustData.addnl=e.addnl,$("#selAddnlChg, #selHouseDisc").change(function(){var e=parseFloat(gblAdjustData[$(this).data("amts")][$(this).val()]);$("#housePayment").val(e.toFixed(2)),$("#housePayment").change()}),$("#housePayment").change(function(){if($("#cbAdjustPmt2").prop("checked")&&$("#houseTax").length>0){var e=parseFloat($("#houseTax").data("tax")),t=parseFloat($("#housePayment").val().replace("$","").replace(",","")),a=0,i=0;isNaN(e)&&(e=0),isNaN(t)&&(t=0),a=e*t,i=t+a,$("#houseTax").val(a>0?a.toFixed(2):""),$("#totalHousePayment").val(i>0?i.toFixed(2):"")}}),$("#cbAdjustPmt1").length>0?($("#cbAdjustPmt1").prop("checked",!0),$("#cbAdjustPmt1").change()):($("#cbAdjustPmt2").prop("checked",!0),$("#cbAdjustPmt2").change()),t.dialog("option","buttons",{Save:function(){var e=parseFloat($("#housePayment").val().replace("$","").replace(",","")),t=parseFloat($("#houseTax").val()),a=$("#housePayment").data("vid"),i="",r=$.datepicker.formatDate("yy-mm-dd",$("#housePaymentDate").datepicker("getDate")),n=$("#housePaymentNote").val();isNaN(e)&&(e=0),isNaN(t)&&(t=0),i=$("#cbAdjustPmt1").prop("checked")?$("#cbAdjustPmt1").data("item"):$("#cbAdjustPmt2").data("item"),saveDiscountPayment(a,i,e,$("#selHouseDisc").val(),$("#selAddnlChg").val(),r,n),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}),t.dialog("option","title","Adjust Fees"),t.dialog("option","width",getDialogWidth(430)),t.dialog("open"))}})}function saveDiscountPayment(e,t,a,i,r,n,o){"use strict";$.post("ws_ckin.php",{cmd:"saveHPay",ord:e,item:t,amt:a,dsc:i,chg:r,adjDate:n,notes:o},function(e){if(e){try{e=$.parseJSON(e)}catch(t){alert("Parser error - "+t.message);return}if(e.error&&(e.gotopage&&window.location.assign(e.gotopage),flagAlertMessage(e.error,"error")),e.reply&&""!=e.reply&&(flagAlertMessage(e.reply,"success"),$("#keysfees").dialog("close")),e.receipt&&""!==e.receipt){$("#keysfees").length>0&&$("#keysfees").dialog("close");let a="number"==typeof e.idPayment&&e.idPayment,i="string"==typeof e.billToEmail?e.billToEmail:"";showReceipt("#pmtRcpt",e.receipt,"Payment Receipt",550,a,i)}}})}function getInvoicee(e,t,a){"use strict";let i=parseInt(e.id,10);!1===isNaN(i)&&i>0?($("#txtInvName"+a).val(e.value),$("#txtInvId"+a).val(i),setTaxExempt(e.taxExempt)):($("#txtInvName"+a).val(""),$("#txtInvId"+a).val(""),setTaxExempt(!1)),$("#txtOrderNum").val(t),$("#txtInvSearch").val(""),amtPaid()}function setTaxExempt(e){"1"==e?$(".hhk-TaxingItem").removeClass("hhk-applyTax").val("0.00"):$(".hhk-TaxingItem").addClass("hhk-applyTax")}function sendVoidReturn(e,t,a,i,r){if(!0!=e.prop("disabled")){e.addClass("hhk-loading-btn").prop("disabled",!0);var n={pid:a,bid:e.attr("id")};t&&"v"===t?n.cmd="void":t&&"rv"===t?n.cmd="revpmt":t&&"r"===t?(n.cmd="rtn",n.amt=i):t&&"ur"===t?(n.cmd="undoRtn",n.amt=i):t&&"vr"===t?n.cmd="voidret":t&&"d"===t&&(n.cmd="delWaive",n.iid=i),$.post("ws_ckin.php",n,function(t){e.removeClass("hhk-loading-btn");let a="";if(t){try{t=$.parseJSON(t)}catch(i){alert("Parser error - "+i.message);return}if(t.error&&(t.gotopage&&window.location.assign(t.gotopage),flagAlertMessage(t.error,"error")),t.reversal&&""!==t.reversal&&(a=t.reversal,r()),t.warning){flagAlertMessage(a+t.warning,"warning"),r();return}if(t.success&&(flagAlertMessage(a+t.success,"success"),r()),t.receipt&&t.idPayment){let n="number"==typeof t.idPayment&&t.idPayment,o="string"==typeof t.billToEmail?t.billToEmail:"";showReceipt("#pmtRcpt",t.receipt,"Receipt",550,n,o)}}})}}class UpdateTaxes{constructor(e){this.taxingItems=e}calcTax(e){let t=0;return this.taxingItems.length>0&&(this.taxingItems.each(function(){let a,i=roundTo(e*parseFloat($(this).data("taxrate")),2);$(this).val(i.toFixed(2).toString()),t+=i}),t<=0&&(t=0)),t}}class AmountVariables{constructor(e){var t=this;t.kdep=0,t.kdepCharge=0,t.vfee=0,t.visitfeeCharge=0,t.feePay=0,t.feePayPreTax=0,t.feePayText="",t.prePayRoomAmt=0,t.invAmt=0,t.invCharge=0,t.invPayment=0,t.heldAmt=0,t.chkingIn=0,t.reimburseAmt=0,t.totCharges=0,t.ckedInCharges=0,t.totPay=0,t.depRfAmt=0,t.depRfPay=0,t.roomBalTaxDue=0,t.feePayTaxAmt=0,t.overPayAmt=0,t.totReturns=0,t.totReturnTax=0,t.totReturnPreTax=0,t.isChdOut=e,t.roomBalDue=0,t.totRmBalDue=0,t.extraPayment=0}}class PayCtrls{constructor(){var e=this;e.keyDepAmt=$("#keyDepAmt"),e.keyDepCb=$("#keyDepRx"),e.depRefundCb=$("#cbDepRefundApply"),e.depRefundAmt=$("#DepRefundAmount"),e.visitFeeAmt=$("#visitFeeAmt"),e.visitFeeCb=$("#visitFeeCb"),e.feePayAmt=$("input#feesPayment"),e.feesCharges=$("#feesCharges"),e.totalPayment=$("#totalPayment"),e.cashTendered=$("#txtCashTendered"),e.extraPay=$("#extraPay"),e.invoiceCb=$(".hhk-payInvCb"),e.adjustBtn=$("#paymentAdjust"),e.msg=$("#payChooserMsg"),e.heldAmtTb=$("#heldAmount"),e.heldCb=$("#cbHeld"),e.reimburseVatCb=$("#cbReimburseVAT"),e.reimburseVatAmt=$("#reimburseVat"),e.hsDiscAmt=$("#HsDiscAmount"),e.houseWaiveCb=$("input#houseWaiveCb"),e.overPay=$("#txtOverPayAmt"),e.guestCredit=$("#guestCredit"),e.selBalTo=$("#selexcpay"),e.taxingItems=$(".hhk-TaxingItem.hhk-applyTax")}}function getPaymentData(e,t){if(e.visitFeeCb.length>0&&(t.visitfeeCharge=parseFloat($("#spnvfeeAmt").data("amt")),isNaN(t.vfee)||t.vfee<0||!1===e.visitFeeCb.prop("checked")?(t.vfee=0,e.visitFeeAmt.val("")):(t.vfee=t.visitfeeCharge,e.visitFeeAmt.val(t.visitfeeCharge.toFixed(2).toString()))),!t.isChdOut&&e.keyDepCb.length>0){t.kdepCharge=parseFloat($("#hdnKeyDepAmt").val());let a=parseFloat($("#kdPaid").data("amt"));isNaN(a)&&(a=0),isNaN(t.kdepCharge)||t.kdepCharge<=0||a>0?(t.kdepCharge=0,t.kdep=0,e.keyDepAmt.val(""),e.keyDepCb.prop("checked",!1),$(".hhk-kdrow").hide()):(!1===e.keyDepCb.prop("checked")?(e.keyDepAmt.val(""),t.kdep=0):(e.keyDepAmt.val(t.kdepCharge.toFixed(2).toString()),t.kdep=t.kdepCharge),$(".hhk-kdrow").show())}if(e.invoiceCb.length>0&&e.invoiceCb.each(function(){let e=parseInt($(this).data("invnum")),a=$("#"+e+"invPayAmt"),i=parseFloat($(this).data("invamt")),r;!0===$(this).prop("checked")?(a.prop("disabled",!1),""===a.val()&&a.val(i.toFixed(2).toString()),isNaN(r=parseFloat(a.val().replace("$","").replace(",","")))||0==r?(r=0,a.val("")):(Math.abs(r)>Math.abs(i)&&(r=i),a.val(r.toFixed(2).toString())),t.invAmt+=r,t.invCharge+=i):""!==a.val()&&(a.val(""),a.prop("disabled",!0))}),e.depRefundAmt.length>0&&t.isChdOut&&(t.depRfAmt=parseFloat(e.depRefundAmt.data("amt")),isNaN(t.depRfAmt)||t.depRfAmt<0||!1===e.depRefundCb.prop("checked")?(t.depRfPay=0,e.depRefundAmt.val("")):(t.depRfPay=t.depRfAmt,e.depRefundAmt.val((0-t.depRfAmt).toFixed(2).toString()))),e.heldCb.length>0){let i=parseInt(e.heldCb.data("prepay"));t.heldAmt=parseFloat(e.heldCb.data("amt")),t.chkingIn=parseInt(e.heldCb.data("chkingin")),isNaN(t.chkingIn)&&(t.chkingIn=0),(isNaN(t.heldAmt)||t.heldAmt<0||!1===e.heldCb.prop("checked"))&&(t.heldAmt=0),1==t.chkingIn?!0===e.heldCb.prop("checked")&&1==i?t.prePayRoomAmt=t.heldAmt:!1===e.heldCb.prop("checked")&&(t.prePayRoomAmt=0):t.prePayRoomAmt=0}e.reimburseVatCb.length>0&&(t.reimburseAmt=parseFloat(e.reimburseVatCb.data("amt")),(isNaN(t.reimburseAmt)||t.reimburseAmt<0||!1===e.reimburseVatCb.prop("checked"))&&(t.reimburseAmt=0))}function getPaymentAmount(e,t){if(e.feePayAmt.length>0){t.feePayText=e.feePayAmt.val().replace("$","").replace(",",""),t.feePayPreTax=roundTo(parseFloat(t.feePayText),2),(isNaN(t.feePayPreTax)||t.feePayPreTax<=0)&&(t.feePayPreTax=0),"0.00"===t.feePayText&&(t.feePayText="0"),"0"!==t.feePayText&&(t.feePayText="");let a=t.prePayRoomAmt-t.vfee-t.kdep-(t.invAmt<0?0:t.invAmt);a>0?t.feePayPreTax=a:t.prePayRoomAmt>0&&(t.feePayPreTax=0);let i=new UpdateTaxes(e.taxingItems);t.feePayTaxAmt=i.calcTax(t.feePayPreTax),t.feePayTaxAmt>t.roomBalTaxDue-t.totReturnTax&&t.isChdOut&&(t.feePayTaxAmt=t.roomBalTaxDue-t.totReturnTax<0?0:t.roomBalTaxDue-t.totReturnTax),t.feePay=t.feePayPreTax+t.feePayTaxAmt}if(e.extraPay.length>0){let r=e.extraPay.val().replace("$","").replace(",","");t.extraPayment=roundTo(parseFloat(r),2),(isNaN(t.extraPayment)||t.extraPayment<=0)&&(t.extraPayment=0),t.extraPayment.toFixed(2)>0?e.extraPay.val(t.extraPayment.toFixed(2).toString()):e.extraPay.val("")}}function doOverpayment(e,t){let a=t.feePay,i=0,r=new UpdateTaxes(e.taxingItems);if("r"===e.selBalTo.val()&&t.overPayAmt>0){t.totRmBalDue>0&&(i=t.totRmBalDue);let n=t.feePayPreTax-i;n>t.overPayAmt?(t.feePayPreTax-=n,t.overPayAmt-=n,$("#txtRtnAmount").val(""),$("#divReturnPay").hide(),e.selBalTo.val("")):t.overPayAmt>=n&&(n>=0&&(t.overPayAmt-=n,t.extraPayment>0&&(t.overPayAmt-=t.extraPayment,t.totPay-=t.extraPayment,e.extraPay.val(""),alert("Extra Payment amount is reduced to 0")),t.feePayPreTax=i),t.overPayAmt>0?($("#divReturnPay").show("fade"),$("#txtRtnAmount").val(t.overPayAmt.toFixed(2).toString())):($("#txtRtnAmount").val(""),$("#divReturnPay").hide(),e.selBalTo.val(""))),t.feePay=t.feePayPreTax+r.calcTax(t.feePayPreTax),t.totPay=t.totPay-a+t.feePay,a!=t.feePay&&alert("Pay Room Fees amount is reduced to: $"+t.feePay.toFixed(2).toString())}else $("#txtRtnAmount").val(""),$("#divReturnPay").hide();0>=t.overPayAmt.toFixed(2)?(e.overPay.val(""),$(".hhk-Overpayment").hide(),e.selBalTo.val("")):(e.overPay.val(t.overPayAmt.toFixed(2).toString()),$(".hhk-Overpayment").show("fade"))}function doHouseWaive(e,t){if(t.overPayAmt<0||0==t.overPayAmt&&t.totCharges>0){if($(".totalPaymentTr").show("fade"),$(".hhk-HouseDiscount").show(),e.houseWaiveCb.prop("checked")){let a=new UpdateTaxes(e.taxingItems),i=Math.max(t.roomBalDue-t.feePayPreTax,0)+t.invAmt+t.vfee-t.totReturns,r=0-t.overPayAmt;i>0?(e.hsDiscAmt.val(i.toFixed(2).toString()),t.totPay=Math.max(t.totCharges-i,0)-t.totReturns-t.roomBalTaxDue,t.totPay+=a.calcTax(t.feePayPreTax)):t.overPayAmt<0?(e.hsDiscAmt.val(r.toFixed(2).toString()),t.totPay-=r):(e.hsDiscAmt.val(""),$(".hhk-HouseDiscount").hide(),e.houseWaiveCb.prop("checked",!1))}else e.hsDiscAmt.val("")}else $(".hhk-HouseDiscount").hide(),$(".totalPaymentTr").hide(),e.hsDiscAmt.val(""),e.houseWaiveCb.prop("checked",!1)}function amtPaid(){"use strict";var e=new PayCtrls,t=new AmountVariables(isCheckedOut);if(e.msg.text("").hide(),t.roomBalDue=parseFloat($("#spnCfBalDue").data("rmbal")),isNaN(t.roomBalDue))t.roomBalDue=0;else{let a=parseFloat($("#spnCfBalDue").data("taxedrmbal"));e.taxingItems.each(function(){let e=parseFloat($(this).data("taxrate"));t.roomBalDue<0?t.roomBalTaxDue+=roundTo(a*e,2,"ceil"):t.roomBalTaxDue+=roundTo(t.roomBalDue*e,2)})}getPaymentData(e,t),getPaymentAmount(e,t),t.totReturns=+t.reimburseAmt+t.heldAmt+t.depRfPay,t.totPay=t.invAmt+t.vfee+t.kdep+t.feePay,t.isChdOut?($(".hhk-minPayment").show("fade"),e.hsDiscAmt.val(""),t.overPayAmt=0,t.totRmBalDue=roundTo(t.roomBalDue+t.roomBalTaxDue,2),t.totCharges=t.invAmt+t.visitfeeCharge+t.kdepCharge,t.totRmBalDue>0?(e.feesCharges.val(t.roomBalDue.toFixed(2).toString()),$(".hhk-GuestCredit").hide(),$(".hhk-RoomFees").show("fade"),$(".hhk-RoomCharge").show("fade"),$("#daystoPay").hide(),t.totCharges+=t.totRmBalDue):(e.guestCredit.val(t.totRmBalDue.toFixed(2).toString()),$(".hhk-RoomFees").hide(),$(".hhk-extraPayTr").show("fade"),$(".hhk-GuestCredit").show("fade"),t.totReturns-=t.totRmBalDue,t.totReturns+=t.extraPayment,t.totRmBalDue=0),t.totReturns>=t.totPay?(t.totReturns-=t.totPay,t.overPayAmt=t.totReturns,t.totPay=t.extraPayment):(t.overPayAmt=t.totPay-t.totCharges,t.totPay-=t.totReturns),doOverpayment(e,t),doHouseWaive(e,t)):($("#daystoPay").show("fade"),$(".hhk-RoomFees").show("fade"),$(".hhk-Overpayment").hide(),$(".totalPaymentTr").show("fade"),$(".hhk-HouseDiscount").hide(),$(".hhk-RoomCharge").hide(),$(".hhk-GuestCredit").hide(),$("#divReturnPay").hide(),$("#txtRtnAmount").val(""),e.hsDiscAmt.val(""),t.totPay-=t.totReturns),t.totPay>0?($(".paySelectTbl").show("fade"),$(".hhk-minPayment").show()):(t.totPay=0,$(".paySelectTbl").hide(),t.isChdOut||$(".hhk-minPayment").hide()),0===t.feePay?e.feePayAmt.val(t.feePayText):e.feePayAmt.val(t.feePayPreTax.toFixed(2).toString()),t.heldAmt.toFixed(2)>0?e.heldAmtTb.val((0-t.heldAmt).toFixed(2).toString()):e.heldAmtTb.val(""),t.reimburseAmt>0?e.reimburseVatAmt.val((0-t.reimburseAmt).toFixed(2).toString()):e.reimburseVatAmt.val(""),e.totalPayment.val(t.totPay.toFixed(2).toString()),$("#spnPayAmount").text("$"+t.totPay.toFixed(2).toString()),e.cashTendered.change()}function setupPayments(e,t,a,i,r){"use strict";var n=$("#PayTypeSel"),o=$(".tblCredit"),s=$(".tblCreditExpand"),d=new PayCtrls;0===o.length&&(o=$(".hhk-mcred")),n.length>0&&n.on("change",function(){$(".hhk-cashTndrd").hide(),$(".hhk-cknum").hide(),$("#tblInvoice").hide(),getInvoicee("",t,""),$(".hhk-transfer").hide(),$(".hhk-tfnum").hide(),o.hide(),s.hide(),console.log(s),console.log($(this).val()),$("#tdCashMsg").hide(),$(".paySelectNotes").show(),"cc"===$(this).val()?(o.show("fade"),0==$(document).find("input[name=rbUseCard]:checked").val()?s.show("fade"):s.hide("fade"),$(document).find("input[name=rbUseCard]:checked").trigger("change")):"ck"===$(this).val()?$(".hhk-cknum").show("fade"):"in"===$(this).val()?($("#tblInvoice").show("fade"),$(".paySelectNotes").hide()):"tf"===$(this).val()?$(".hhk-transfer").show("fade"):$(".hhk-cashTndrd").show("fade")}).trigger("change"),setupCOF(s);var l=$("#rtnTypeSel"),h=$(".tblCreditr");0===h.length&&(h=$(".hhk-mcredr")),l.length>0&&(l.change(function(){h.hide(),$(".hhk-transferr").hide(),$(".payReturnNotes").show(),$(".hhk-cknumr").hide(),"cc"===$(this).val()?h.show("fade"):"ck"===$(this).val()?$(".hhk-cknumr").show("fade"):"tf"===$(this).val()&&$(".hhk-transferr").show("fade")}),l.change()),d.selBalTo.length>0&&d.selBalTo.change(function(){amtPaid()}),d.houseWaiveCb.length>0&&d.houseWaiveCb.change(function(){amtPaid()}),d.keyDepCb.length>0&&d.keyDepCb.change(function(){amtPaid()}),d.depRefundCb.length>0&&d.depRefundCb.change(function(){amtPaid()}),d.heldCb.length>0&&d.heldCb.change(function(){amtPaid()}),d.reimburseVatCb.length>0&&d.reimburseVatCb.change(function(){amtPaid()}),d.invoiceCb.length>0&&(d.invoiceCb.change(function(){amtPaid()}),$(".hhk-payInvAmt").change(function(){amtPaid()})),d.visitFeeCb.length>0&&d.visitFeeCb.change(function(){amtPaid()}),d.feePayAmt.length>0&&d.feePayAmt.change(function(){$(this).removeClass("ui-state-error"),amtPaid()}),d.feesCharges.length>0&&d.feesCharges.click(function(){d.feePayAmt.val($(this).val()).focus(),d.feePayAmt.change()}),d.extraPay.length>0&&d.extraPay.change(function(){$(this).removeClass("ui-state-error"),amtPaid()}),d.cashTendered.length>0&&d.cashTendered.change(function(){d.cashTendered.removeClass("ui-state-highlight"),$("#tdCashMsg").hide();var e=parseFloat(d.totalPayment.val().replace(",",""));(isNaN(e)||e<0)&&(e=0);var t=parseFloat(d.cashTendered.val().replace("$","").replace(",",""));(isNaN(t)||t<0)&&(t=0,d.cashTendered.val(""));var a=t-e;a<0&&(a=0,d.cashTendered.addClass("ui-state-highlight")),$("#txtCashChange").text("$"+a.toFixed(2).toString())}),d.adjustBtn.length>0&&(d.adjustBtn.button(),d.adjustBtn.click(function(){getApplyDiscDiag(t,i)})),$("#divPmtMkup, #div-hhk-payments").on("click",".invAction",function(e){e.preventDefault(),("del"!=$(this).data("stat")||confirm("Delete Invoice "+$(this).data("inb")+(""!=$(this).data("payor")?" for "+$(this).data("payor"):"")+"?"))&&invoiceAction($(this).data("iid"),$(this).data("stat"),e.target.id,r,!0)}),createInvChooser(t,""),$("#daystoPay").change(function(){let t=parseInt($(this).val()),a=parseInt($(this).data("vid")),i=parseFloat($("#txtFixedRate").val()),r=parseInt($("#spnNumGuests").text()),n=d.feePayAmt,o=parseFloat($("#spnRcTax").data("tax")),s=parseFloat($("#seladjAmount").find(":selected").data("amount"));$(this).val(""),isNaN(r)&&(r=1),isNaN(i)&&(i=0),isNaN(o)&&(o=0),isNaN(s)&&(s=0),!isNaN(t)&&t>0&&daysCalculator(t,e,a,i,s,r,0,function(e){n.val(e.toFixed(2).toString()),n.change()})}),n.length>0?n.change():amtPaid()}function createInvChooser(e,t){$("#txtInvSearch"+t).length>0&&($("#txtInvSearch"+t).keypress(function(a){var i=$(this).val();"13"==a.keyCode&&(""!=i&&isNumber(parseInt(i,10))?$.getJSON("../house/roleSearch.php",{cmd:"filter",basis:"ba",letters:i},function(a){try{a=a[0]}catch(i){alert("Parser error - "+i.message);return}a&&a.error&&(a.gotopage&&(response(),window.open(a.gotopage)),a.value=a.error),getInvoicee(a,e,t)}):(alert("Don't press the return key unless you enter an Id."),a.preventDefault()))}),createAutoComplete($("#txtInvSearch"+t),3,{cmd:"filter",basis:"ba"},function(a){getInvoicee(a,e,t)},!1))}function daysCalculator(e,t,a,i,r,n,o,s){e>0&&(e!=gblRtCalcParams.days||t!=gblRtCalcParams.idRate||a!=gblRtCalcParams.idVisit||i!=gblRtCalcParams.fixedAmt||r!=gblRtCalcParams.adjAmt||n!=gblRtCalcParams.numGuests||o!=gblRtCalcParams.idResv)?(gblRtCalcParams={days:e,idRate:t,idVisit:a,fixedAmt:i,adjAmt:r,numGuests:n,idResv:o},$.post("ws_ckin.php",{cmd:"rtcalc",vid:a,rid:o,nites:e,rcat:t,fxd:i,adj:r,gsts:n},function(e){if(!e){alert("Bad Reply from Server");return}try{e=$.parseJSON(e)}catch(t){alert("Parser error - "+t.message);return}if(e.error){e.gotopage&&window.open(e.gotopage),flagAlertMessage(e.error,"error");return}if(e.amt){var a=parseFloat(e.amt);(isNaN(a)||a<0)&&(a=0),s(a),gblRtCalcData=e}})):gblRtCalcData.amt&&s(gblRtCalcData.amt)}function verifyBalDisp(){return""==$("#selexcpay").val()&&""!=$("#txtOverPayAmt").val()?($("#payChooserMsg").text('Set "Apply To" to the desired overpayment disposition. ').show(),$("#selexcpay").addClass("ui-state-highlight"),$("#pWarnings").text('Set "Apply To" to the desired overpayment disposition.').show(),!1):($("#payChooserMsg").text("").hide(),$("#selexcpay").removeClass("ui-state-highlight"),!0)}function verifyAmtTendrd(){"use strict";if(0===$("#PayTypeSel").length)return!0;let e=parseFloat($("#totalPayment").val().replace("$","").replace(",",""));if($("#tdCashMsg").hide("fade"),$("#tdInvceeMsg").text("").hide(),$("#tdChargeMsg").text("").hide(),"ca"===$("#PayTypeSel").val()){let t=parseFloat($("#txtCashTendered").val().replace("$","").replace(",","")),a=$("#remtotalPayment");if(a.length>0&&(e=parseFloat(a.val().replace("$","").replace(",",""))),(isNaN(e)||e<0)&&(e=0),(isNaN(t)||t<0)&&(t=0),e>0&&t<=0)return $("#tdCashMsg").text('Enter the amount paid into "Amount Tendered" ').show(),$("#pWarnings").text('Enter the amount paid into "Amount Tendered"').show(),!1;if(e>0&&t<e)return $("#tdCashMsg").text("Amount tendered is not enough ").show("fade"),$("#pWarnings").text("Amount tendered is not enough").show(),!1}else if("in"===$("#PayTypeSel").val()){let i=parseInt($("#txtInvId").val(),10);if((isNaN(i)||i<1)&&0!=e)return $("#tdInvceeMsg").text("The Invoicee is missing. ").show("fade"),!1}else if("cc"===$("#PayTypeSel").val()&&$("#selccgw").length>0&&""===$("#selccgw").val())return $("#tdChargeMsg").text("Select a location.").show("fade"),!1;return!0}function showReceipt(e,t,a,i,r=!1,n=""){var o=$(e);let s=$("<div class='ml-3'><i class='bi bi-printer-fill mr-3'></i>Print</div>"),d=$("<div class='ml-3'><i class='bi bi-send-fill mr-3'></i>Email</div>"),l=$("<a href='ws_ckin.php?cmd=downloadReceipt&paymentId="+r+"' class='ml-3'><i class='bi bi-cloud-arrow-down-fill mr-3'></i>Download</a>");var h={mode:"popup",popClose:!1,popHt:500,popWd:400,popX:200,popY:200,popTitle:a};i="1"==$(t).data("merchcopy")?900:550,o.children().remove(),o.append($(t).addClass("ReceiptPrintArea").css("max-width",i+"px")),s.button().click(function(){$(".ReceiptPrintArea").printArea(h),o.dialog("close")}),d.button().click(function(){!0!=d.prop("disabled")&&(d.prop("disabled",!0).find("i").removeClass("bi bi-send-fill").addClass("spinner-border spinner-border-sm"),fetch("ws_ckin.php",{method:"POST",headers:{accept:"application/json"},body:new URLSearchParams({cmd:"emailReceipt",paymentId:r,emailAddress:n})}).then(e=>{if(d.prop("disabled",!1).find("i").addClass("bi bi-send-fill").removeClass("spinner-border spinner-border-sm"),!e.ok)throw Error(e.status);return e.json()}).then(e=>{e.success?flagAlertMessage(e.success,"success"):e.error&&flagAlertMessage(e.error,"error")}).catch(e=>{flagAlertMessage(e,"error")}))}),l.button();let c=$("<div class='my-2'>").append(s);!1!==r&&(""!==n&&c.append(d),c.append(l)),o.prepend(c),o.dialog("option","title",a),o.dialog("option","buttons",{}),o.dialog("option","width",i),o.dialog("open"),h.popHt=$("#pmtRcpt").height(),h.popWd=$("#pmtRcpt").width()}function reprintReceipt(e,t){$.post("ws_ckin.php",{cmd:"getPrx",pid:e},function(a){if(a){try{a=$.parseJSON(a)}catch(i){alert("Parser error - "+i.message);return}a.error&&(a.gotopage&&window.location.assign(a.gotopage),flagAlertMessage(a.error,"error"));let r="string"==typeof a.billToEmail?a.billToEmail:"";showReceipt(t,a.receipt,"Receipt Copy",550,e,r)}})}function paymentRedirect(e,t,a){"use strict";if(e){if(console.log("redirect called"),e.hostedError)flagAlertMessage(e.hostedError,"error");else if(e.cvtx)window.location.assign(e.cvtx);else if(e.xfer&&t.length>0){if(t.children("input").remove(),t.prop("action",e.xfer),e.paymentId&&""!=e.paymentId)t.append($('<input type="hidden" name="PaymentID" value="'+e.paymentId+'"/>'));else if(e.cardId&&""!=e.cardId)t.append($('<input type="hidden" name="CardID" value="'+e.cardId+'"/>'));else{flagAlertMessage("PaymentId and CardId are missing!","error");return}t.submit()}else if(e.inctx)$("#contentDiv").empty().append($("<p>Processing Credit Payment...</p>")),InstaMed.launch(e.inctx),$("#instamed").css("visibility","visible").css("margin-top","50px;");else if(e.deluxehpf){var i="payment"==e.deluxehpf.cmd?"Enter Payment Details":"Add New Card On File",r="payment"==e.deluxehpf.cmd?"Submit Payment":"Save Card On File";a&&void 0!=a.idVisit&&void 0!=a.span?i+=" for Visit "+a.idVisit+"-"+a.span:a&&void 0!=a.resvId&&(i+=" for Reservation "+a.resvId);var n=$("#deluxeDialog");n.html(""),"payment"==e.deluxehpf.cmd&&e.deluxehpf.payAmount>0&&n.html('<div class="row justify-content-center mt-3" id="deluxePayInfo"><div class="col" style="text-align: center;"><label class="mx-1">Payment Amount</label><input class="mx-1" size="10" disabled="" value="$ '+e.deluxehpf.payAmount.toFixed(2)+'" id="deluxePayAmount" type="text"></div></div>'),n.append('<div class="row justify-content-center mt-3"><div class="col" style="text-align: center;"><label class="mx-1">Cardholder Name</label><input class="mx-1" id="deluxeCardHolderName" type="text" size="30"></div></div>'),n.attr("style","overflow-y: hidden;").dialog({modal:!0,width:getDialogWidth(650),height:450,autoOpen:!0,title:i,open:function(t,i){var o={containerId:"deluxeDialog",xtoken:e.deluxehpf.hpfToken,xrtype:"Generate Token",xbtntext:r,xmsrattached:e.deluxehpf.useSwipe,xswptext:"Please Swipe Card now...",xPM:1};HostedForm.init(o,{onSuccess(t){let i={hpfData:t,token:t.data.token,nameOnCard:t.data.nameOnCard,expDate:t.data.expDate,cardType:t.data.cardType,maskedPan:t.data.maskedPan,cmd:e.deluxehpf.cmd,pbp:e.deluxehpf.pbp},r=n.find("#deluxeCardHolderName").val();"CardHolder"==i.nameOnCard&&r.length>0&&(i.nameOnCard=r),e.deluxehpf.idGroup&&(i.psg=e.deluxehpf.idGroup),e.deluxehpf.idPayor&&(i.id=e.deluxehpf.idPayor),e.deluxehpf.invoiceNum&&(i.invoiceNum=e.deluxehpf.invoiceNum),n.empty().append('<div id="hhk-loading-spinner" style="width: 100%; height: 100%; margin-top: 100px; text-align: center"><img src="../images/ui-anim_basic_16x16.gif"><p>Working...</p></div>'),$.post(encodeURI(e.deluxehpf.pbp),i,function(e){if(e){try{e=$.parseJSON(e)}catch(t){alert("Parser error - "+t.message);return}if(e.error&&(e.gotopage&&window.location.assign(e.gotopage),flagAlertMessage(e.error,"error")),e.COFmkup&&($("#tblupCredit"+e.idx).remove(),$("#upCreditfs").prepend($(e.COFmkup)),setupCOF($(".tblCreditExpand"+e.idx),e.idx)),void 0!==a&&void 0!==a.resvId&&$("#btnDone").click(),e.gotopage&&window.location.assign(e.gotopage),e.success&&""!==e.success&&flagAlertMessage(e.success,"success"),e.warning&&""!==e.warning&&flagAlertMessage(e.warning,"error"),e.receipt&&""!==e.receipt){let i="number"==typeof e.idPayment&&e.idPayment,r="string"==typeof e.billToEmail?e.billToEmail:"";showReceipt("#pmtRcpt",e.receipt,"Payment Receipt",550,i,r)}n.dialog("close")}})},onFailure(e){console.log(JSON.stringify(e))},onInvalid(e){console.log(JSON.stringify(e))}}).then(e=>{e.renderHpf()})},close:function(e,t){$(this).find("iframe").remove(),$(this).dialog("destroy").empty()}})}}}function setupCOF(e,t){null==t&&(t=""),e.length>0&&($(document).find("input[name=rbUseCard"+t+"]").on("change",function(){0==$(this).val()&&!0===$(this).prop("checked")||!0===$(this).prop("checked")&&"checkbox"===$(this).prop("type")?e.show("fade"):(e.hide("fade"),$("#btnvrKeyNumber"+t).prop("checked",!1).change(),$("#txtvdNewCardName"+t).val("")),$("#tdChargeMsg"+t).text("").hide("fade"),$("#selccgw"+t).removeClass("ui-state-highlight")}),($(document).find("input[name=rbUseCard"+t+"]:checked").val()>0||!1===$(document).find("input[name=rbUseCard"+t+"]").prop("checked")&&"checkbox"===$(document).find("input[name=rbUseCard"+t+"]").prop("type"))&&e.hide("fade"),$(document).find("input[name=rbUseCard"+t+"]").trigger("change"),$("#btnvrKeyNumber"+t).length>0&&($("#btnvrKeyNumber"+t).change(function(){0==$("input[name=rbUseCard"+t+"]:checked").val()&&!0==$("#btnvrKeyNumber"+t).prop("checked")||!0===$("input[name=rbUseCard"+t+"]").prop("checked")&&"checkbox"===$("input[name=rbUseCard"+t+"]").prop("type")?$("#trvdCHName"+t).show("fade"):($("#trvdCHName"+t).hide("fade"),$("#txtvdNewCardName"+t).val(""))}),$("#btnvrKeyNumber"+t).change()),$("#txtvdNewCardName"+t).length>0&&$("#txtvdNewCardName"+t).keydown(function(e){var t=e.which||e.keycode;return t>=48&&t<=57||t>=96&&t<=105?($("#lhnameerror").show(),!1):($("#lhnameerror").hide(),!0)}))}function cardOnFile(e,t,a,i){if($("#tdChargeMsg"+i).text("").hide(),$("#selccgw"+i).length>0&&(0==$("input[name=rbUseCard"+i+"]:checked").val()||!0===$("input[name=rbUseCard"+i+"]").prop("checked"))&&($("#selccgw"+i).removeClass("ui-state-highlight"),0===$("#selccgw"+i).val().length))return $("#tdChargeMsg"+i).text("Select a location.").show("fade"),$("#selccgw"+i).addClass("ui-state-highlight"),!1;var r={cmd:"cof",idGuest:e,idGrp:t,pbp:a,index:i};$("#tblupCredit"+i).find("input").each(function(){"checkbox"===$(this).attr("type")?!1!==this.checked&&(r[$(this).attr("id")]="on"):"radio"===$(this).attr("type")?!1!==this.checked&&(r[$(this).attr("id")]=this.value):r[$(this).attr("id")]=this.value}),$("#selccgw"+i).length>0&&(r["selccgw"+i]=$("#selccgw"+i).val()),$("#selChargeType"+i).length>0&&(r["selChargeType"+i]=$("#selChargeType"+i).val()),$.post("ws_ckin.php",r,function(e){if(e){try{e=$.parseJSON(e)}catch(t){alert("Parser error - "+t.message);return}if(e.error){e.gotopage&&window.location.assign(e.gotopage),flagAlertMessage(e.error,"error");return}e.hostedError&&flagAlertMessage(e.hostedError,"error"),paymentRedirect(e,$("#xform")),(e.success&&""!=e.success||e.COFmsg&&""!=e.COFmsg)&&flagAlertMessage((void 0===e.success?"":e.success)+(void 0===e.COFmsg?"":e.COFmsg),"success"),e.COFmkup&&""!==e.COFmkup&&($("#tblupCredit"+i).remove(),$("#upCreditfs").prepend($(e.COFmkup)),setupCOF($(".tblCreditExpand"+i),i))}})}function paymentsTable(e,t,a){$("#"+e).DataTable({columnDefs:[{targets:[9,10],type:"date",render:function(e,t,a){return dateRender(e,t)}},{targets:[12],type:"date",render:function(e,t,a){return dateRender(e,t,"MMM D, YYYY h:mm a")}}],dom:'<"top"if><"hhk-overflow-x"rt><"bottom"lp><"clear">',displayLength:50,order:[[8,"asc"]],lengthMenu:[[25,50,-1],[25,50,"All"]],drawCallback:function(){$("#"+t).find("input[type=button]").button()}}),$("#btnPayHistRef").button().click(function(){a()}),$("#"+t).on("click",".invAction",function(e){invoiceAction($(this).data("iid"),"view",e.target.id)}),$("#"+t).on("click",".hhk-voidPmt",function(){var e=$(this),t=parseFloat(e.data("amt"));"Saving..."!==e.val()&&confirm("Void/Reverse this payment for $"+t.toFixed(2).toString()+"?")&&(e.val("Saving..."),sendVoidReturn(e,"rv",e.data("pid"),null,a))}),$("#"+t).on("click",".hhk-voidRefundPmt",function(){var e=$(this);"Saving..."!==e.val()&&confirm("Void this Return?")&&(e.val("Saving...").addClass("hhk-loading-btn"),sendVoidReturn(e,"vr",e.data("pid"),null,a))}),$("#"+t).on("click",".hhk-returnPmt",function(){var e=$(this),t=parseFloat(e.data("amt"));"Saving..."!==e.val()&&confirm("Return this payment for $"+t.toFixed(2).toString()+"?")&&(e.val("Saving...").addClass("hhk-loading-btn"),sendVoidReturn(e,"r",e.data("pid"),t,a))}),$("#"+t).on("click",".hhk-undoReturnPmt",function(){var e=$(this),t=parseFloat(e.data("amt"));"Saving..."!==e.val()&&confirm("Undo this Return/Refund for $"+t.toFixed(2).toString()+"?")&&(e.val("Saving...").addClass("hhk-loading-btn"),sendVoidReturn(e,"ur",e.data("pid"),null,a))}),$("#"+t).on("click",".hhk-deleteWaive",function(){var e=$(this);"Deleting..."!==e.val()&&confirm("Delete this House payment?")&&(e.val("Deleting...").addClass("hhk-loading-btn"),sendVoidReturn(e,"d",e.data("ilid"),e.data("iid"),null,a))}),$("#"+t).on("click",".pmtRecpt",function(){reprintReceipt($(this).data("pid"),"#pmtRcpt")}),$("#"+t).mousedown(function(e){var t=$(e.target);"pudiv"!==t[0].id&&0===t.parents("#pudiv").length&&$("div#pudiv").remove()})}