/**
 * payments.js
 *
 *
 * @category  house
 * @package   Hospitality HouseKeeper
 * @author    Eric K. Crane <ecrane@nonprofitsoftwarecorp.org>
 * @copyright 2010-2017 <nonprofitsoftwarecorp.org>
 * @license   GPL and MIT
 * @link      https://github.com/NPSC
 */ var gblAdjustData=[];function getApplyDiscDiag(e,t){"use strict";if(!e||""==e||0==e){flagAlertMessage("Order Number is missing","error");return}$.post("ws_ckin.php",{cmd:"getHPay",ord:e,arrDate:$("#spanvArrDate").text()},function(e){if(e){try{e=$.parseJSON(e)}catch(a){alert("Parser error - "+a.message);return}e.error?(e.gotopage&&window.location.assign(e.gotopage),flagAlertMessage(e.error,"error")):e.markup&&(t.children().remove(),t.append($('<div class="hhk-panel hhk-tdbox hhk-visitdialog" style="font-size:0.8em;"/>').append($(e.markup))),$("#cbAdjustType").buttonset(),$("#cbAdjustPmt1, #cbAdjustPmt2").change(function(){var e=$(this).data("hid"),t=$(this).data("sho");$("."+e).val(""),$("."+t).val(""),$("#housePayment").val(""),$("#housePayment").change(),$("."+t).show(),$("."+e).hide()}),gblAdjustData.disc=e.disc,gblAdjustData.addnl=e.addnl,$("#selAddnlChg, #selHouseDisc").change(function(){var e=parseFloat(gblAdjustData[$(this).data("amts")][$(this).val()]);$("#housePayment").val(e.toFixed(2)),$("#housePayment").change()}),$("#housePayment").change(function(){if($("#cbAdjustPmt2").prop("checked")&&$("#houseTax").length>0){var e=parseFloat($("#houseTax").data("tax")),t=parseFloat($("#housePayment").val().replace("$","").replace(",","")),a=0,n=0;isNaN(e)&&(e=0),isNaN(t)&&(t=0),a=e*t,n=t+a,$("#houseTax").val(a>0?a.toFixed(2):""),$("#totalHousePayment").val(n>0?n.toFixed(2):"")}}),$("#cbAdjustPmt1").length>0?($("#cbAdjustPmt1").prop("checked",!0),$("#cbAdjustPmt1").change()):($("#cbAdjustPmt2").prop("checked",!0),$("#cbAdjustPmt2").change()),t.dialog("option","buttons",{Save:function(){var e=parseFloat($("#housePayment").val().replace("$","").replace(",","")),t=parseFloat($("#houseTax").val()),a=$("#housePayment").data("vid"),n="",i=$.datepicker.formatDate("yy-mm-dd",$("#housePaymentDate").datepicker("getDate")),r=$("#housePaymentNote").val();isNaN(e)&&(e=0),isNaN(t)&&(t=0),n=$("#cbAdjustPmt1").prop("checked")?$("#cbAdjustPmt1").data("item"):$("#cbAdjustPmt2").data("item"),saveDiscountPayment(a,n,e,$("#selHouseDisc").val(),$("#selAddnlChg").val(),i,r),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}),t.dialog("option","title","Adjust Fees"),t.dialog("option","width",getDialogWidth(430)),t.dialog("open"))}})}function saveDiscountPayment(e,t,a,n,i,r,o){"use strict";$.post("ws_ckin.php",{cmd:"saveHPay",ord:e,item:t,amt:a,dsc:n,chg:i,adjDate:r,notes:o},function(e){if(e){try{e=$.parseJSON(e)}catch(t){alert("Parser error - "+t.message);return}e.error&&(e.gotopage&&window.location.assign(e.gotopage),flagAlertMessage(e.error,"error")),e.reply&&""!=e.reply&&(flagAlertMessage(e.reply,"success"),$("#keysfees").dialog("close")),e.receipt&&""!==e.receipt&&($("#keysfees").length>0&&$("#keysfees").dialog("close"),showReceipt("#pmtRcpt",e.receipt,"Payment Receipt"))}})}function getInvoicee(e,t,a){"use strict";var n=parseInt(e.id,10);!1===isNaN(n)&&n>0?($("#txtInvName"+a).val(e.value),$("#txtInvId"+a).val(n),setTaxExempt(e.taxExempt)):($("#txtInvName"+a).val(""),$("#txtInvId"+a).val(""),setTaxExempt(!1)),$("#txtOrderNum").val(t),$("#txtInvSearch"+a).val("")}function setTaxExempt(e){"1"==e?$(".hhk-TaxingItem").removeClass("hhk-applyTax").val("0.00").parent("tr").hide():$(".hhk-TaxingItem").addClass("hhk-applyTax").parent("tr").show(),amtPaid()}function sendVoidReturn(e,t,a,n,i){var r={pid:a,bid:e};t&&"v"===t?r.cmd="void":t&&"rv"===t?r.cmd="revpmt":t&&"r"===t?(r.cmd="rtn",r.amt=n):t&&"ur"===t?(r.cmd="undoRtn",r.amt=n):t&&"vr"===t?r.cmd="voidret":t&&"d"===t&&(r.cmd="delWaive",r.iid=n),$.post("ws_ckin.php",r,function(e){var t="";if(e){try{e=$.parseJSON(e)}catch(a){alert("Parser error - "+a.message);return}if(e.error){e.gotopage&&window.location.assign(e.gotopage),flagAlertMessage(e.error,"error");return}if(e.reversal&&""!==e.reversal&&(t=e.reversal,i()),e.warning){flagAlertMessage(t+e.warning,"warning"),i();return}e.success&&(flagAlertMessage(t+e.success,"success"),i()),e.receipt&&showReceipt("#pmtRcpt",e.receipt,"Receipt")}})}var payCtrls=function(){var e=this;e.keyDepAmt=$("#keyDepAmt"),e.keyDepCb=$("#keyDepRx"),e.depRefundCb=$("#cbDepRefundApply"),e.depRefundAmt=$("#DepRefundAmount"),e.visitFeeAmt=$("#visitFeeAmt"),e.visitFeeCb=$("#visitFeeCb"),e.feePayAmt=$("input#feesPayment"),e.feesCharges=$("#feesCharges"),e.totalPayment=$("#totalPayment"),e.totalCharges=$("#totalCharges"),e.cashTendered=$("#txtCashTendered"),e.invoiceCb=$(".hhk-payInvCb"),e.adjustBtn=$("#paymentAdjust"),e.msg=$("#payChooserMsg"),e.heldAmtTb=$("#heldAmount"),e.heldCb=$("#cbHeld"),e.reimburseVatCb=$("#cbReimburseVAT"),e.reimburseVatAmt=$("#reimburseVat"),e.hsDiscAmt=$("#HsDiscAmount"),e.finalPaymentCb=$("input#cbFinalPayment"),e.overPay=$("#txtOverPayAmt"),e.guestCredit=$("#guestCredit"),e.selBalTo=$("#selexcpay")};function roundTo(e,t){void 0===t&&(t=0);var a=Math.pow(10,t);return Math.round(e=parseFloat((e*a).toFixed(11)))/a}function amtPaid(){"use strict";var e=new payCtrls,t=0,a=0,n=0,i=0,r="",o=0,s=0,d=0,h=0,c=0,l=0,p=0,u=0,m=0,v=0,g=0,f=0,y=0,b=isCheckedOut,C=parseFloat($("#spnCfBalDue").data("rmbal")),k=parseFloat($("#spnCfBalDue").data("taxedrmbal")),x=(parseFloat($("#spnCfBalDue").data("totbal")),$(".hhk-TaxingItem.hhk-applyTax"));if(isNaN(C)?C=0:x.each(function(){var e=parseFloat($(this).data("taxrate"));C<0?u+=roundTo(k*e,2,"ceil"):u+=roundTo(C*e,2)}),e.msg.text("").hide(),e.visitFeeCb.length>0&&(isNaN(a=parseFloat($("#spnvfeeAmt").data("amt")))||a<0||!1===e.visitFeeCb.prop("checked")?(a=0,e.visitFeeAmt.val("")):e.visitFeeAmt.val(a.toFixed(2).toString())),!b&&e.keyDepCb.length>0&&(isNaN(t=parseFloat($("#hdnKeyDepAmt").val()))||t<0||!1===e.keyDepCb.prop("checked")?(t=0,e.keyDepAmt.val("")):(e.keyDepAmt.val(t.toFixed(2).toString()),$(".hhk-kdrow").show())),e.invoiceCb.length>0&&e.invoiceCb.each(function(){var e,t=parseInt($(this).data("invnum")),a=$("#"+t+"invPayAmt"),n=parseFloat($(this).data("invamt"));!0===$(this).prop("checked")?(a.prop("disabled",!1),""===a.val()&&a.val(n.toFixed(2).toString()),isNaN(e=parseFloat(a.val().replace("$","").replace(",","")))||0==e?(e=0,a.val("")):(Math.abs(e)>Math.abs(n)&&(e=n),a.val(e.toFixed(2).toString())),o+=e):""!==a.val()&&(a.val(""),a.prop("disabled",!0))}),e.depRefundAmt.length>0&&b&&(isNaN(p=parseFloat(e.depRefundAmt.data("amt")))||p<0||!1===e.depRefundCb.prop("checked")?(p=0,e.depRefundAmt.val("")):e.depRefundAmt.val((0-p).toFixed(2).toString())),e.heldCb.length>0&&(isNaN(s=parseFloat(e.heldCb.data("amt")))||s<0||!1===e.heldCb.prop("checked"))&&(s=0),e.reimburseVatCb.length>0&&(isNaN(d=parseFloat(e.reimburseVatCb.data("amt")))||d<0||!1===e.reimburseVatCb.prop("checked"))&&(d=0),g=s+p+d,x.each(function(){var e;f+=roundTo(g/(1+parseFloat($(this).data("taxrate"))),2)}),f>u&&(f=u),y=g-f,e.feePayAmt.length>0&&(i=roundTo(parseFloat(r=e.feePayAmt.val().replace("$","").replace(",","")),2),"0.00"===r&&(r="0"),"0"!==r&&(r=""),(isNaN(i)||i<=0)&&(i=0),x.length>0&&(x.each(function(){var e,t=roundTo(i*parseFloat($(this).data("taxrate")),2);$(this).val(t.toFixed(2).toString()),m+=t}),m>u-f&&b&&(m=u-f),m<=0&&(m=0)),n=i+m),b){$(".hhk-minPayment").show("fade"),v=0,e.hsDiscAmt.val("");var P=roundTo(C+u,2);if(C>=0?(e.feesCharges.val(P.toFixed(2).toString()),$(".hhk-GuestCredit").hide(),$(".hhk-RoomCharge").show()):(e.guestCredit.val(P.toFixed(2).toString()),$(".hhk-RoomCharge").hide(),$(".hhk-GuestCredit").show(),o>0&&(P+o<=0?(P+=o,o=0):(o=P+o,P=0)),a>0&&(P+a<=0?(P+=a,a=0):(a=P+a,P=0))),(h=a+o+P-g)>=(l=a+o+n)&&h>0){var A=roundTo(a+o+C-y-i,2);if(A>0){if(e.finalPaymentCb.prop("checked")){var w=roundTo(u-(m+f),2);e.hsDiscAmt.val(A.toFixed(2).toString()),e.feesCharges.val((P-w).toFixed(2).toString()),h-=w,l=n}else e.hsDiscAmt.val("");$(".hhk-Overpayment").hide(),$(".hhk-HouseDiscount").show("fade")}else e.finalPaymentCb.prop("checked",!1),e.hsDiscAmt.val(""),$(".hhk-HouseDiscount").hide(),$(".hhk-Overpayment").hide();e.selBalTo.val(""),$("#txtRtnAmount").val(""),$("#divReturnPay").hide()}else e.finalPaymentCb.prop("checked",!1),e.hsDiscAmt.val(""),v=h>=0?l-h:a+n-h,"r"===e.selBalTo.val()?(h>=0?(i>v&&alert("Pay Room Fees amount is reduced to: $"+(i-v).toFixed(2).toString()),i-=v,n=i+m,v=0,e.selBalTo.val(""),$("#txtRtnAmount").val(""),$("#divReturnPay").hide()):(n>0&&alert("Pay Room Fees amount is reduced to: $0.00"),v-=n,i=0,m=0,x.each(function(){$(this).val("")}),n=0,$("#divReturnPay").show("fade"),$("#txtRtnAmount").val(v.toFixed(2).toString())),l=a+o+n-v):($("#txtRtnAmount").val(""),$("#divReturnPay").hide()),v.toFixed(2)>0?($(".hhk-Overpayment").show("fade"),$(".hhk-HouseDiscount").hide()):($(".hhk-Overpayment").hide(),$(".hhk-HouseDiscount").hide())}else(h=a+t+o+n)>0&&s>0?s>h?(s=h,h=0):h-=s:h<0&&s>0?h-=s:e.heldCb.length>0&&e.heldAmtTb.val(""),h>0&&d>0?d>h?d=0:h-=d:h<0&&d>0?h-=d:e.reimburseVatCb.length>0&&(d=0),$(".hhk-Overpayment").hide(),$(".hhk-HouseDiscount").hide(),e.hsDiscAmt.val(""),v=0,l=h,c=a+t+o+n;l>0||l<0&&!b?($(".paySelectTbl").show("fade"),$(".hhk-minPayment").show("fade"),l<0&&!b&&$("#txtRtnAmount").val((0-l).toFixed(2).toString())):(l=0,$(".paySelectTbl").hide(),$("#divReturnPay").hide(),!1===b&&0===c?($(".hhk-minPayment").hide(),s=0,d=0):$(".hhk-minPayment").show("fade")),0===n?e.feePayAmt.val(r):e.feePayAmt.val(i.toFixed(2).toString()),0==v.toFixed(2)?e.overPay.val(""):e.overPay.val(v.toFixed(2).toString()),s.toFixed(2)>0?e.heldAmtTb.val((0-s).toFixed(2).toString()):e.heldAmtTb.val(""),d>0?e.reimburseVatAmt.val((0-d).toFixed(2).toString()):e.reimburseVatAmt.val(""),e.totalCharges.val(h.toFixed(2).toString()),e.totalPayment.val(l.toFixed(2).toString()),$("#spnPayAmount").text("$"+l.toFixed(2).toString()),e.cashTendered.change()}function setupPayments(e,t,a,n){"use strict";var i=$("#PayTypeSel"),r=$(".tblCredit"),o=$("#trvdCHName"),s=new payCtrls;0===r.length&&(r=$(".hhk-mcred")),i.length>0&&(i.change(function(){$(".hhk-cashTndrd").hide(),$(".hhk-cknum").hide(),$("#tblInvoice").hide(),getInvoicee("",t,""),$(".hhk-transfer").hide(),$(".hhk-tfnum").hide(),r.hide(),o.hide(),$("#tdCashMsg").hide(),$(".paySelectNotes").show(),"cc"===$(this).val()?(r.show("fade"),0==$("input[name=rbUseCard]:checked").val()&&o.show()):"ck"===$(this).val()?$(".hhk-cknum").show("fade"):"in"===$(this).val()?($("#tblInvoice").show("fade"),$(".paySelectNotes").hide()):"tf"===$(this).val()?$(".hhk-transfer").show("fade"):$(".hhk-cashTndrd").show("fade")}),i.change()),setupCOF(o);var d=$("#rtnTypeSel"),h=$(".tblCreditr");0===h.length&&(h=$(".hhk-mcredr")),d.length>0&&(d.change(function(){h.hide(),$(".hhk-transferr").hide(),$(".payReturnNotes").show(),$(".hhk-cknumr").hide(),"cc"===$(this).val()?h.show("fade"):"ck"===$(this).val()?$(".hhk-cknumr").show("fade"):"tf"===$(this).val()&&$(".hhk-transferr").show("fade")}),d.change()),s.selBalTo.length>0&&s.selBalTo.change(function(){amtPaid()}),s.finalPaymentCb.length>0&&s.finalPaymentCb.change(function(){amtPaid()}),s.keyDepCb.length>0&&s.keyDepCb.change(function(){amtPaid()}),s.depRefundCb.length>0&&s.depRefundCb.change(function(){amtPaid()}),s.heldCb.length>0&&s.heldCb.change(function(){amtPaid()}),s.reimburseVatCb.length>0&&s.reimburseVatCb.change(function(){amtPaid()}),s.invoiceCb.length>0&&(s.invoiceCb.change(function(){amtPaid()}),$(".hhk-payInvAmt").change(function(){amtPaid()})),s.visitFeeCb.length>0&&s.visitFeeCb.change(function(){amtPaid()}),s.feePayAmt.length>0&&s.feePayAmt.change(function(){$(this).removeClass("ui-state-error"),amtPaid()}),s.cashTendered.length>0&&s.cashTendered.change(function(){s.cashTendered.removeClass("ui-state-highlight"),$("#tdCashMsg").hide();var e=parseFloat(s.totalPayment.val().replace(",",""));(isNaN(e)||e<0)&&(e=0);var t=parseFloat(s.cashTendered.val().replace("$","").replace(",",""));(isNaN(t)||t<0)&&(t=0,s.cashTendered.val(""));var a=t-e;a<0&&(a=0,s.cashTendered.addClass("ui-state-highlight")),$("#txtCashChange").text("$"+a.toFixed(2).toString())}),s.adjustBtn.length>0&&(s.adjustBtn.button(),s.adjustBtn.click(function(){getApplyDiscDiag(t,n)})),$("#divPmtMkup").on("click",".invAction",function(e){e.preventDefault(),("del"!=$(this).data("stat")||confirm("Delete this Invoice?"))&&invoiceAction($(this).data("iid"),$(this).data("stat"),e.target.id,"#keysfees",!0)}),createInvChooser(t,""),$("#daystoPay").change(function(){var t=parseInt($(this).val()),a=parseInt($(this).data("vid")),n=parseFloat($("#txtFixedRate").val()),i=parseInt($("#spnNumGuests").text()),r=s.feePayAmt,o=parseFloat($("#spnRcTax").data("tax")),d=parseFloat($("#seladjAmount").find(":selected").data("amount"));$(this).val(""),isNaN(i)&&(i=1),isNaN(n)&&(n=0),isNaN(o)&&(o=0),isNaN(d)&&(d=0),!isNaN(t)&&t>0&&daysCalculator(t,e.val(),a,n,d,i,0,function(e){r.val(e.toFixed(2).toString()),r.change()})}),amtPaid()}function createInvChooser(e,t){$("#txtInvSearch"+t).length>0&&($("#txtInvSearch"+t).keypress(function(a){var n=$(this).val();"13"==a.keyCode&&(""!=n&&isNumber(parseInt(n,10))?$.getJSON("../house/roleSearch.php",{cmd:"filter",basis:"ba",letters:n},function(a){try{a=a[0]}catch(n){alert("Parser error - "+n.message);return}a&&a.error&&(a.gotopage&&(response(),window.open(a.gotopage)),a.value=a.error),getInvoicee(a,e,t)}):(alert("Don't press the return key unless you enter an Id."),a.preventDefault()))}),createAutoComplete($("#txtInvSearch"+t),3,{cmd:"filter",basis:"ba"},function(a){getInvoicee(a,e,t)},!1))}function daysCalculator(e,t,a,n,i,r,o,s){e>0&&$.post("ws_ckin.php",{cmd:"rtcalc",vid:a,rid:o,nites:e,rcat:t,fxd:n,adj:i,gsts:r},function(e){if(!e){alert("Bad Reply from Server");return}try{e=$.parseJSON(e)}catch(t){alert("Parser error - "+t.message);return}if(e.error){e.gotopage&&window.open(e.gotopage),flagAlertMessage(e.error,"error");return}if(e.amt){var a=parseFloat(e.amt);(isNaN(a)||a<0)&&(a=0),s(a)}})}function verifyBalDisp(){return""==$("#selexcpay").val()&&""!=$("#txtOverPayAmt").val()?($("#payChooserMsg").text('Set "Apply To" to the desired overpayment disposition. ').show(),$("#selexcpay").addClass("ui-state-highlight"),$("#pWarnings").text('Set "Apply To" to the desired overpayment disposition.').show(),!1):($("#payChooserMsg").text("").hide(),$("#selexcpay").removeClass("ui-state-highlight"),!0)}function verifyAmtTendrd(){"use strict";if(0===$("#PayTypeSel").length)return!0;var e=parseFloat($("#totalPayment").val().replace("$","").replace(",",""));if($("#tdCashMsg").hide("fade"),$("#tdInvceeMsg").text("").hide(),$("#tdChargeMsg").text("").hide(),"ca"===$("#PayTypeSel").val()){var t=parseFloat($("#txtCashTendered").val().replace("$","").replace(",","")),a=$("#remtotalPayment");if(a.length>0&&(e=parseFloat(a.val().replace("$","").replace(",",""))),(isNaN(e)||e<0)&&(e=0),(isNaN(t)||t<0)&&(t=0),e>0&&t<=0)return $("#tdCashMsg").text('Enter the amount paid into "Amount Tendered" ').show(),$("#pWarnings").text('Enter the amount paid into "Amount Tendered"').show(),!1;if(e>0&&t<e)return $("#tdCashMsg").text("Amount tendered is not enough ").show("fade"),$("#pWarnings").text("Amount tendered is not enough").show(),!1}else if("in"===$("#PayTypeSel").val()){var n=parseInt($("#txtInvId").val(),10);if((isNaN(n)||n<1)&&0!=e)return $("#tdInvceeMsg").text("The Invoicee is missing. ").show("fade"),!1}else if("cc"===$("#PayTypeSel").val()&&$("#selccgw").length>0&&""===$("#selccgw").val())return $("#tdChargeMsg").text("Select a location.").show("fade"),!1;return!0}function showReceipt(e,t,a,n){var i=$(e),r=$("<div id='print_button' style='margin-left:1em;'>Print</div>"),o={mode:"popup",popClose:!1,popHt:500,popWd:400,popX:200,popY:200,popTitle:a};void 0!==n&&n||(n="1"==$(t).data("merchcopy")?900:550),i.children().remove(),i.append($(t).addClass("ReceiptArea").css("max-width",n+"px")),r.button(),r.click(function(){$(".ReceiptArea").printArea(o),i.dialog("close")}),i.prepend(r),i.dialog("option","title",a),i.dialog("option","buttons",{}),i.dialog("option","width",n),i.dialog("open"),o.popHt=$("#pmtRcpt").height(),o.popWd=$("#pmtRcpt").width()}function reprintReceipt(e,t){$.post("ws_ckin.php",{cmd:"getPrx",pid:e},function(e){if(e){try{e=$.parseJSON(e)}catch(a){alert("Parser error - "+a.message);return}e.error&&(e.gotopage&&window.location.assign(e.gotopage),flagAlertMessage(e.error,"error")),showReceipt(t,e.receipt,"Receipt Copy")}})}function paymentRedirect(e,t){"use strict";if(e){if(e.hostedError)flagAlertMessage(e.hostedError,"error");else if(e.cvtx)window.location.assign(e.cvtx);else if(e.xfer&&t.length>0){if(t.children("input").remove(),t.prop("action",e.xfer),e.paymentId&&""!=e.paymentId)t.append($('<input type="hidden" name="PaymentID" value="'+e.paymentId+'"/>'));else if(e.cardId&&""!=e.cardId)t.append($('<input type="hidden" name="CardID" value="'+e.cardId+'"/>'));else{flagAlertMessage("PaymentId and CardId are missing!","error");return}t.submit()}else e.inctx&&($("#contentDiv").empty().append($("<p>Processing Credit Payment...</p>")),InstaMed.launch(e.inctx),$("#instamed").css("visibility","visible").css("margin-top","50px;"))}}function setupCOF(e,t){null==t&&(t=""),e.length>0&&($("input[name=rbUseCard"+t+"]").on("change",function(){0==$(this).val()||!0===$(this).prop("checked")&&"checkbox"===$(this).prop("type")?e.show():(e.hide(),$("#btnvrKeyNumber"+t).prop("checked",!1).change(),$("#txtvdNewCardName"+t).val("")),$("#tdChargeMsg"+t).text("").hide(),$("#selccgw"+t).removeClass("ui-state-highlight")}),($("input[name=rbUseCard"+t+"]:checked").val()>0||!1===$("input[name=rbUseCard"+t+"]").prop("checked")&&"checkbox"===$("input[name=rbUseCard"+t+"]").prop("type"))&&e.hide(),$("#btnvrKeyNumber"+t).length>0&&($("#btnvrKeyNumber"+t).change(function(){0==$("input[name=rbUseCard"+t+"]:checked").val()||!0===$("input[name=rbUseCard"+t+"]").prop("checked")&&"checkbox"===$("input[name=rbUseCard"+t+"]").prop("type")?$("#txtvdNewCardName"+t).show():($("#txtvdNewCardName"+t).hide(),$("#txtvdNewCardName"+t).val(""))}),$("#btnvrKeyNumber"+t).change()),$("#txtvdNewCardName"+t).length>0&&$("#txtvdNewCardName"+t).keydown(function(e){var t=e.which||e.keycode;return t>=48&&t<=57||t>=96&&t<=105?($("#lhnameerror").show(),!1):($("#lhnameerror").hide(),!0)}))}function cardOnFile(e,t,a,n){if($("#tdChargeMsg"+n).text("").hide(),$("#selccgw"+n).length>0&&(0==$("input[name=rbUseCard"+n+"]:checked").val()||!0===$("input[name=rbUseCard"+n+"]").prop("checked"))&&($("#selccgw"+n).removeClass("ui-state-highlight"),0===$("#selccgw"+n+" option:selected").length))return $("#tdChargeMsg"+n).text("Select a location.").show("fade"),$("#selccgw"+n).addClass("ui-state-highlight"),!1;var i={cmd:"cof",idGuest:e,idGrp:t,pbp:a,index:n};$("#tblupCredit"+n).find("input").each(function(){"checkbox"===$(this).attr("type")?!1!==this.checked&&(i[$(this).attr("id")]="on"):"radio"===$(this).attr("type")?!1!==this.checked&&(i[$(this).attr("id")]=this.value):i[$(this).attr("id")]=this.value}),$("#selccgw"+n).length>0&&(i["selccgw"+n]=$("#selccgw"+n).val()),$("#selChargeType"+n).length>0&&(i["selChargeType"+n]=$("#selChargeType"+n).val()),$.post("ws_ckin.php",i,function(e){if(e){try{e=$.parseJSON(e)}catch(t){alert("Parser error - "+t.message);return}if(e.error){e.gotopage&&window.location.assign(e.gotopage),flagAlertMessage(e.error,"error");return}e.hostedError&&flagAlertMessage(e.hostedError,"error"),paymentRedirect(e,$("#xform")),(e.success&&""!=e.success||e.COFmsg&&""!=e.COFmsg)&&flagAlertMessage((void 0===e.success?"":e.success)+(void 0===e.COFmsg?"":e.COFmsg),"success"),e.COFmkup&&""!==e.COFmkup&&($("#tblupCredit"+n).remove(),$("#upCreditfs").prepend($(e.COFmkup)),setupCOF($("#trvdCHName"+n),n))}})}function paymentsTable(e,t,a){$("#"+e).dataTable({columnDefs:[{targets:8,type:"date",render:function(e,t,a){return dateRender(e,t)}},{targets:9,type:"date",render:function(e,t,a){return dateRender(e,t)}}],dom:'<"top"if><"hhk-overflow-x hhk-tbl-wrap"rt><"bottom"lp><"clear">',displayLength:50,order:[[8,"asc"]],lengthMenu:[[25,50,-1],[25,50,"All"]]}).on("draw",function(){$("#"+t).find("input[type=button]").button()}),$("#"+t).find("input[type=button]").button(),$("#btnPayHistRef").button().click(function(){a()}),$("#"+t).on("click",".invAction",function(e){invoiceAction($(this).data("iid"),"view",e.target.id)}),$("#"+t).on("click",".hhk-voidPmt",function(){var e=$(this),t=parseFloat(e.data("amt"));"Saving..."!==e.val()&&confirm("Void/Reverse this payment for $"+t.toFixed(2).toString()+"?")&&(e.val("Saving..."),sendVoidReturn(e.attr("id"),"rv",e.data("pid"),null,a))}),$("#"+t).on("click",".hhk-voidRefundPmt",function(){var e=$(this);"Saving..."!==e.val()&&confirm("Void this Return?")&&(e.val("Saving..."),sendVoidReturn(e.attr("id"),"vr",e.data("pid"),null,a))}),$("#"+t).on("click",".hhk-returnPmt",function(){var e=$(this),t=parseFloat(e.data("amt"));"Saving..."!==e.val()&&confirm("Return this payment for $"+t.toFixed(2).toString()+"?")&&(e.val("Saving..."),sendVoidReturn(e.attr("id"),"r",e.data("pid"),t,a))}),$("#"+t).on("click",".hhk-undoReturnPmt",function(){var e=$(this),t=parseFloat(e.data("amt"));"Saving..."!==e.val()&&confirm("Undo this Return/Refund for $"+t.toFixed(2).toString()+"?")&&(e.val("Saving..."),sendVoidReturn(e.attr("id"),"ur",e.data("pid"),null,a))}),$("#"+t).on("click",".hhk-deleteWaive",function(){var e=$(this);"Deleting..."!==e.val()&&confirm("Delete this House payment?")&&(e.val("Deleting..."),sendVoidReturn(e.attr("id"),"d",e.data("ilid"),e.data("iid"),null,a))}),$("#"+t).on("click",".pmtRecpt",function(){reprintReceipt($(this).data("pid"),"#pmtRcpt")}),$("#"+t).mousedown(function(e){var t=$(e.target);"pudiv"!==t[0].id&&0===t.parents("#pudiv").length&&$("div#pudiv").remove()})}